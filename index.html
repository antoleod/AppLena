<!doctype html>

<html lang="es" dir="ltr">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
    <title>Appli de Léna — v3 estable</title>
    <meta name="theme-color" content="#ec4899"/>
    <style>
      :root{
        --fg:#111827; --muted:#6b7280; --card:rgba(255,255,255,.94);
        --ring:#ec4899; --good:#22c55e; --bad:#ef4444;
        --grad:linear-gradient(135deg,#fdf2f8,#fae8ff,#e9d5ff);
      }
      *{box-sizing:border-box}
      html,body,#root{height:100%}
      body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto; color:var(--fg); background:var(--grad); background-size:200% 200%; animation:bg 26s linear infinite}
      @keyframes bg{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
      .container{max-width:1100px;margin:0 auto;min-height:100vh;padding:12px;display:flex;flex-direction:column}
      .header{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,#fff,rgba(255,255,255,.85));border-radius:20px;padding:10px 14px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
      .brand{display:flex;gap:10px;align-items:center}
      .brand b{font-size:20px;background:linear-gradient(90deg,#ec4899,#f59e0b,#10b981,#3b82f6,#8b5cf6);-webkit-background-clip:text;background-clip:text;color:transparent}
      .stage{flex:1;display:flex;align-items:center;justify-content:center;padding:12px}
      .card{background:var(--card);border-radius:24px;box-shadow:0 12px 28px rgba(0,0,0,.08);padding:16px;width:min(1100px,100%)}
      .grid{display:grid;gap:12px}
      @media(min-width:640px){.grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr));}}
      @media(max-width:639.98px){.grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr));}}
      .icon-btn{border:1px solid rgba(167,139,250,.25);background:linear-gradient(180deg,#fff,#fdf2f8);border-radius:20px;padding:18px;min-height:140px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.06);transition:transform .12s}
      .icon-btn:active{transform:scale(.98)}
      .icon-emoji{font-size:34px}
      .icon-label{font-weight:900}
      .back{border:none;background:#fff;border-radius:16px;padding:12px 16px;box-shadow:0 6px 16px rgba(0,0,0,.08);display:inline-flex;align-items:center;gap:8px;cursor:pointer}
      .back-lg{padding:14px 18px;font-size:16px}
      .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
      .progress{height:8px;border-radius:999px;background:linear-gradient(90deg,rgba(167,139,250,.25),rgba(236,72,153,.25));overflow:hidden}
      .progress>span{display:block;height:100%;background:linear-gradient(90deg,#a78bfa,#ec4899,#f59e0b);transition:width .2s}
      .opt{position:relative;border:1px solid rgba(167,139,250,.25);background:linear-gradient(180deg,#fff,#fdf2f8);border-radius:16px;padding:16px;min-height:84px;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 10px 20px rgba(0,0,0,.06);cursor:pointer;transition:transform .08s}
      .opt:active{transform:scale(.98)}
      .opt .badge{position:absolute;left:8px;top:8px;background:#a78bfa;color:#fff;border-radius:999px;width:24px;height:24px;font-size:12px;display:flex;align-items:center;justify-content:center;font-weight:800}
      .question{font-size:36px;font-weight:900;text-align:center;margin:10px 0}
      .modal-wrap{position:fixed;inset:0;background:rgba(15,23,42,.38);display:flex;align-items:center;justify-content:center;z-index:50}
      .modal{background:#fff;border-radius:18px;padding:18px;min-width:260px;max-width:92vw;text-align:center;box-shadow:0 24px 60px rgba(0,0,0,.25)}
      .key{min-width:44px;height:44px;border-radius:10px;border:none;background:#fff;box-shadow:0 6px 14px rgba(0,0,0,.06);font-weight:900;cursor:pointer}
      .board{display:grid;gap:8px}
      .tile{width:60px;height:60px;border-radius:12px;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;box-shadow:0 8px 18px rgba(0,0,0,.08);cursor:pointer}
      .tile.fixed{background:#f3f4f6;color:#6b7280;cursor:default}
      .tile.sel{outline:3px solid var(--ring)}
      .card-wrap{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
      .mem-front{background:#fff;display:flex;align-items:center;justify-content:center;border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.08);height:110px;font-size:24px;color:#a78bfa}
      .mem-back{background:#fff;display:flex;align-items:center;justify-content:center;border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.08);height:110px;font-size:20px}
      .mem{position:relative;perspective:600px;height:110px}
      .mem>.side{position:absolute;inset:0;border-radius:14px;backface-visibility:hidden;transition:transform .25s}
      .mem>.back{transform:rotateY(180deg)}
      .mem.open>.front{transform:rotateY(180deg)}
      .mem.open>.back{transform:rotateY(0)}
      .combo{position:fixed;right:16px;top:16px;background:linear-gradient(90deg,#f59e0b,#ec4899);color:#fff;border-radius:999px;padding:8px 12px;font-weight:900;box-shadow:0 12px 28px rgba(0,0,0,.14);transform:translateY(-10px) scale(.95);opacity:0;transition:transform .18s ease, opacity .18s ease;z-index:60}
      .combo.show{transform:translateY(0) scale(1);opacity:1}
      @media (min-width:900px){.question{font-size:40px}}
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script>
      const {useState,useMemo,useRef,useEffect} = React;// ===== Utils
  const r=(a,b)=> Math.floor(Math.random()*(b-a+1))+a;
  const shuffle=(arr)=>{const a=[...arr]; for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a;};
  // Tolerante: acentos, espacios, mayúsculas
  const strip=(s)=> Array.from(String(s||'').normalize('NFD')).filter(ch=>{const c=ch.charCodeAt(0); return !(c>=0x300&&c<=0x36F)}).join('');
  const norm=(x)=> strip(x).trim().toLowerCase().replace(/\s+/g,' ');
  const eqAns=(a,b)=>{const na=Number(a), nb=Number(b); if(!Number.isNaN(na)&&!Number.isNaN(nb)) return na===nb; return norm(a)===norm(b)};
  const choicesNum=(correct)=>{ const c=Number(correct); const s=new Set([c]); while(s.size<4){ const d=Math.max(1,Math.round(Math.abs(c)*0.2)+1); s.add(c+(Math.random()<.5?-1:1)*r(1,d)); } return shuffle([...s]).map(String); };

  // WebAudio mini
  const Sound=(()=>{let ctx; const ensure=()=> (ctx ||= new (window.AudioContext||window.webkitAudioContext)()); const beep=(f=660,d=0.09,t='triangle',w=0,g=0.05)=>{const c=ensure(); const o=c.createOscillator(); const G=c.createGain(); o.type=t; o.frequency.value=f; G.gain.value=g; o.connect(G); G.connect(c.destination); o.start(c.currentTime+w); o.stop(c.currentTime+w+d);}; return {good:()=>{beep(660,0.09); beep(880,0.1,'triangle',0.08);}, bad:()=>{beep(220,0.14,'sawtooth');}}})();

  // ===== Error Boundary simple
  class ErrorBoundary extends React.Component{constructor(p){super(p); this.state={err:null}} componentDidCatch(err){this.setState({err})} render(){ if(this.state.err){ return React.createElement('div',{className:'card'}, React.createElement('h2',null,'Algo salió mal 😿'), React.createElement('p',{className:'caption'}, String(this.state.err)), React.createElement('div',{className:'row'}, React.createElement('button',{className:'back',onClick:()=>location.reload()},'Recargar')) ); } return this.props.children; }}

  // ===== Components básicos
  const Progress=({i,total})=> React.createElement('div',{className:'progress'}, React.createElement('span',{style:{width:`${(i)/(total-1||1)*100}%`}}));
  const IconButton=({emoji,label,desc,onClick})=> React.createElement('button',{className:'icon-btn',onClick}, React.createElement('div',{className:'icon-emoji'},emoji), React.createElement('div',{className:'icon-label'},label), desc? React.createElement('div',{style:{fontSize:12,color:"#6b7280"}},desc):null);
  const LevelPill=({children,onClick})=> React.createElement('button',{className:'back',onClick},children);

  // ===== MCQGame v2 (estable)
  function MCQGame({title,items:onItems,onExit,onWrong,onWin,onCorrect}){
    // Congelar items localmente (no se regeneran al re-render)
    const [items]=useState(()=> onItems.map((it)=>({ ...it, options:[...new Set(it.options)].slice(0,4) })) );
    const [i,setI]=useState(0), [score,setScore]=useState(0), [streak,setStreak]=useState(0);
    const total=items.length; const item=items[i];
    const [opts]=useState(()=> shuffle(item.options)); // opciones fijas por pregunta
    const pick=(label)=>{
      try{
        const good=eqAns(label,item.answer);
        if(good){ setScore(s=>s+1); setStreak(s=>s+1); onCorrect&&onCorrect(); if(i+1<total){ setI(i+1);} else onWin&&onWin(score+1); }
        else { setStreak(0); onWrong&&onWrong(1); }
      }catch(e){ console.error(e); onWrong&&onWrong(1); }
    };
    return (
      React.createElement('div',{className:'card'},
        React.createElement('button',{className:'back back-lg',style:{marginBottom:10},onClick:onExit},'🦄 Retour'),
        React.createElement('h2',null,title),
        React.createElement('div',{className:'question','aria-live':'polite'}, item.emoji? item.emoji+' ':null, item.prompt),
        React.createElement(Progress,{i,total}),
        React.createElement('div',{className:'grid cols-3',style:{marginTop:12}},
          opts.map((o,idx)=> React.createElement('button',{key:idx,className:'opt',onClick:()=>pick(o)},
            React.createElement('span',{className:'badge'},String.fromCharCode(65+idx)),
            React.createElement('b',null,o)
          ))
        ),
        React.createElement('div',{className:'row',style:{marginTop:8}}, React.createElement('span',{className:'caption'},`Pregunta ${i+1}/${total} — Score ${score}`))
      )
    );
  }

  // ===== Bancos y generadores — re‑hechos para estabilidad
  // Cloze FR
  const CLOZE_BANK=[
    { text:"Chaque matin, Léna ____ à l'école.", options:["va","vont","allez","aller"], answer:"va" },
    { text:"Le chat ____ sur le canapé.", options:["dort","dorment","dormi","dors"], answer:"dort" },
    { text:"Papa ____ un café.", options:["boit","boivent","boire","bu"], answer:"boit" },
    { text:"Nous ____ dans la cour.", options:["jouons","joue","jouent","jouer"], answer:"jouons" },
    { text:"La cloche ____ à neuf heures.", options:["sonne","sonnent","sonné","sonner"], answer:"sonne" },
  ];
  function mkClozeItems(n){ return shuffle(CLOZE_BANK).slice(0,n).map(x=>({prompt:x.text.replace('____','_____'), options:shuffle(x.options), answer:x.answer, emoji:'📖'})); }

  // Vocab multilíngua
  const VOCAB_CORE=[
    {emoji:'🍎', es:'manzana', en:'apple', nl:'appel'},
    {emoji:'💧', es:'agua', en:'water', nl:'water'},
    {emoji:'🍞', es:'pan', en:'bread', nl:'brood'},
    {emoji:'🥛', es:'leche', en:'milk', nl:'melk'},
    {emoji:'🐱', es:'gato', en:'cat', nl:'kat'},
    {emoji:'🐶', es:'perro', en:'dog', nl:'hond'},
    {emoji:'🏠', es:'casa', en:'house', nl:'huis'},
    {emoji:'🏫', es:'escuela', en:'school', nl:'school'},
    {emoji:'📚', es:'libro', en:'book', nl:'boek'},
    {emoji:'👋', es:'hola', en:'hello', nl:'hallo'},
    {emoji:'👋', es:'adiós', en:'goodbye', nl:'tot ziens'},
    {emoji:'🙏', es:'por favor', en:'please', nl:'alsjeblieft'},
    {emoji:'🙂', es:'gracias', en:'thank you', nl:'dank je'},
    {emoji:'🔴', es:'rojo', en:'red', nl:'rood'},
    {emoji:'🔵', es:'azul', en:'blue', nl:'blauw'},
    {emoji:'🟢', es:'verde', en:'green', nl:'groen'},
    {emoji:'1️⃣', es:'uno', en:'one', nl:'een'},
    {emoji:'2️⃣', es:'dos', en:'two', nl:'twee'},
    {emoji:'3️⃣', es:'tres', en:'three', nl:'drie'},
    {emoji:'🔟', es:'diez', en:'ten', nl:'tien'}
  ];
  function mkVocabItems(target,count){
    const targetName = target==='en'? 'Inglés' : target==='nl'? 'Holandés' : 'Español';
    const sourceKey = target==='es'? 'en' : 'es';
    const take = shuffle(VOCAB_CORE).slice(0,count);
    return take.map(it=>{
      const ans = it[target];
      const src = it[sourceKey];
      let pool = shuffle(VOCAB_CORE.map(o=> o[target]).filter(v=> !eqAns(v,ans)));
      const opts = [ans, ...pool.slice(0,3)];
      // Garantía
      const uniq=[]; for(const o of opts){ if(!uniq.some(u=>eqAns(u,o))) uniq.push(o);} while(uniq.length<4){ const fb=pool.shift()||ans; if(!uniq.some(u=>eqAns(u,fb))) uniq.push(fb); }
      return {prompt:`«${src}» → ${targetName}?`, options:shuffle(uniq.slice(0,4)), answer:ans, emoji:it.emoji};
    });
  }

  // Aritmética fiable
  function mkArith(mode,count,minA,maxA,minB,maxB){
    const pick=()=> mode==='mix'? ['+','-','x','/'][r(0,3)]: mode;
    const items=[]; for(let i=0;i<count;i++){
      let a=r(minA,maxA), b=r(minB,maxB), op=pick(), ans;
      if(op==='x') ans=a*b; else if(op==='+') ans=a+b; else if(op==='-'){ if(a<b) [a,b]=[b,a]; ans=a-b; } else { b=Math.max(1,r(minB,maxB)); const k=r(minA,maxA); a=k*b; ans=k; }
      items.push({prompt:`${a} ${op} ${b} = ?`, options:choicesNum(ans), answer:String(ans), emoji:'🔢'});
    }
    return items;
  }

  // Place value
  function mkPlace(count,min,max,target){
    const items=[]; for(let i=0;i<count;i++){ const n=r(min,max); const u=n%10, d=Math.floor(n/10)%10, c=Math.floor(n/100)%10; const correct= target==='unités'?u: target==='dizaines'?d:c; items.push({prompt:`${n} → ${target}`, options:choicesNum(correct), answer:String(correct), emoji:'🔟'}); }
    return items;
  }

  // Number Line
  function mkNumberLine(count,max){
    const items=[]; for(let i=0;i<count;i++){ let a=r(0,Math.floor(max/2)), b=r(1,Math.floor(max/2)); const op=(Math.random()<.5?'+':'-'); if(op==='-'){ const aa=Math.max(a,b); const bb=Math.min(a,b); a=aa; b=bb; } const ans= op==='+'? a+b : a-b; items.push({prompt:`${a} ${op} ${b} = ?`, options:choicesNum(ans), answer:String(ans), emoji:'🎯'}); }
    return items;
  }

  // Memory Game (arreglado)
  function MemoryGame({onExit,onWrong,onWin,onCorrect}){
    const [lvl,setLvl]=useState(0);
    if(!lvl){ return React.createElement('div',{className:'card'},
      React.createElement('button',{className:'back back-lg',style:{marginBottom:10},onClick:onExit},'🦄 Retour'),
      React.createElement('h2',null,'Memoria (operación ↔ resultado)'),
      React.createElement('p',{className:'caption'},'Empareja operación con su resultado.'),
      React.createElement('div',{className:'row',style:{marginTop:8}}, [1,2,3,4,5].map(k=> React.createElement(LevelPill,{key:k,onClick:()=>setLvl(k)},`Nivel ${k}`)))
    ); }
    const pairs = lvl===1?4: lvl===2?6: lvl===3?8: lvl===4?10:12;
    const mk=()=>{ const arr=[]; for(let i=0;i<pairs;i++){ const a=r(1,9), b=r(1,9); const op = lvl>=3?(['+','-','x'][r(0,2)]) : (lvl===2?(['+','-'][r(0,1)]):'+'); let exp=`${a}+${b}`, val=a+b; if(op==='-'){ const aa=Math.max(a,b), bb=Math.min(a,b); exp=`${aa}-${bb}`; val=aa-bb;} if(op==='x'){ exp=`${a}×${b}`; val=a*b;} const id=`${exp}=${val}`; arr.push({id,front:'❓',back:exp,match:id+'r'}); arr.push({id:id+'r',front:'❓',back:String(val),match:id}); } return shuffle(arr); };
    const [cards,setCards]=useState(()=> mk());
    useEffect(()=>{ setCards(mk()); },[lvl]);
    const [open,setOpen]=useState([]), [solved,setSolved]=useState({});
    const click=(idx)=>{ if(solved[idx]||open.includes(idx)) return; const now=[...open,idx]; setOpen(now); if(now.length===2){ const [a,b]=now; if(cards[a].match===cards[b].id){ onCorrect&&onCorrect(); setSolved(s=>({...s,[a]:1,[b]:1})); setOpen([]); if(Object.keys(solved).length+2===cards.length) onWin&&onWin(3); } else { setTimeout(()=> setOpen([]), 450); onWrong&&onWrong(1); } } };
    return React.createElement('div',{className:'card'},
      React.createElement('button',{className:'back back-lg',style:{marginBottom:10},onClick:onExit},'🦄 Retour'),
      React.createElement('h2',null,`Memoria · Nivel ${lvl}`),
      React.createElement('div',{className:'card-wrap'}, cards.map((c,idx)=> React.createElement('div',{key:idx,className:'mem'+(open.includes(idx)||solved[idx]? ' open':''), onClick:()=>click(idx)},
        React.createElement('div',{className:'side front mem-front'},'❓'),
        React.createElement('div',{className:'side back mem-back'},c.back)
      )))
    );
  }

  // ===== App
  function App(){
    const [screen,setScreen]=useState('home');
    const [bills,setBills]=useState(()=> Number(localStorage.getItem('bills')||'0'));
    const [combo,setCombo]=useState({show:false,key:0});
    const [soundOn,setSoundOn]=useState(()=> localStorage.getItem('soundOn')!=='0');
    const addBills=(n)=>{ const nb=bills+n; setBills(nb); localStorage.setItem('bills',String(nb)); };
    const onWrong=(pen=1)=>{ if(soundOn) Sound.bad(); const nb=Math.max(0,bills-pen); setBills(nb); localStorage.setItem('bills',String(nb)); };
    const onCorrect=()=>{ if(soundOn) Sound.good(); setCombo({show:true,key:Date.now()}); setTimeout(()=> setCombo(c=>({...c,show:false})), 800); };
    const onWin=(earned,next)=>{ addBills(earned); };

    // Rutas MCQ (items generados una sola vez por nivel)
    const [payload,setPayload]=useState(null);

    const startVocab=(lang)=> setPayload({type:'mcq', title:`Vocabulario · ${lang==='en'?'Inglés':lang==='nl'?'Holandés':'Español'} · Nivel 1`, items: mkVocabItems(lang,8)});
    const startCloze=()=> setPayload({type:'mcq', title:'Lecture · Nivel 1', items: mkClozeItems(8)});
    const startMath=()=> setPayload({type:'mcq', title:'Math · Mix · Nivel 1', items: mkArith('mix',10,1,20,1,10)});
    const startPlace=()=> setPayload({type:'mcq', title:'Unités/Dizaines · Nivel 1', items: mkPlace(10,10,999,'dizaines')});
    const startNumLine=()=> setPayload({type:'mcq', title:'Droite numérique · Nivel 1', items: mkNumberLine(10,20)});

    const goHome=()=>{ setScreen('home'); setPayload(null); };

    const Home=()=> React.createElement('div',{className:'card'},
      React.createElement('div',{className:'grid cols-3'},
        React.createElement(IconButton,{emoji:'🗣️',label:'Lenguas',desc:'ES · EN · NL', onClick:()=>setScreen('languages')}),
        React.createElement(IconButton,{emoji:'📖',label:'Lecture',desc:'Cloze', onClick:()=>startCloze()}),
        React.createElement(IconButton,{emoji:'🧮',label:'Math · Mix',desc:'+ − × ÷', onClick:()=>startMath()}),
        React.createElement(IconButton,{emoji:'🔟',label:'Unités/Dizaines',desc:'Base 10', onClick:()=>startPlace()}),
        React.createElement(IconButton,{emoji:'🎯',label:'Droite numérique',desc:'Add/Sub', onClick:()=>startNumLine()}),
        React.createElement(IconButton,{emoji:'🧠',label:'Memoria',desc:'Pares', onClick:()=>setScreen('memory')}),
      )
    );

    const Languages=()=> React.createElement('div',{className:'card'},
      React.createElement('button',{className:'back back-lg',style:{marginBottom:10},onClick:goHome},'🦄 Retour'),
      React.createElement('h2',null,'Lenguas / Languages'),
      React.createElement('div',{className:'grid cols-3',style:{marginTop:8}},
        React.createElement(IconButton,{emoji:'🇪🇸',label:'Español',desc:'Vocabulario', onClick:()=>startVocab('es')}),
        React.createElement(IconButton,{emoji:'🇬🇧',label:'English',desc:'Vocabulary', onClick:()=>startVocab('en')}),
        React.createElement(IconButton,{emoji:'🇳🇱',label:'Nederlands',desc:'Woorden', onClick:()=>startVocab('nl')}),
      )
    );

    const Toolbar=()=> React.createElement('div',{className:'header'},
      React.createElement('div',{className:'brand'}, React.createElement('div',null,'🦄'), React.createElement('b',null,'Appli de Léna — 2e primaire')),
      React.createElement('div',{className:'row'},
        React.createElement('button',{className:'back',onClick:()=>setSoundOn(v=>{localStorage.setItem('soundOn',(!v)?'1':'0'); return !v;})}, soundOn?'🔊 Sonido':'🔈 Silencio'),
        React.createElement('div',{className:'back'},'💵 ', React.createElement('b',null,String(bills)))
      )
    );

    const Body=()=>{
      if(screen==='home') return React.createElement(Home);
      if(screen==='languages') return React.createElement(Languages);
      if(screen==='memory') return React.createElement(MemoryGame,{onExit:goHome,onWrong,onWin,onCorrect});
      if(payload&&payload.type==='mcq') return React.createElement('div',{className:'card'}, React.createElement(MCQGame,{title:payload.title, items:payload.items, onExit:goHome, onWrong, onWin, onCorrect}));
      return React.createElement(Home);
    };

    return React.createElement(ErrorBoundary,null,
      React.createElement('div',{className:'container'},
        React.createElement(Toolbar),
        React.createElement('main',{className:'stage'}, React.createElement(Body)),
        React.createElement('div',{className:'combo'+(combo.show?' show':'')},'🔥 ¡Bien!')
      )
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
</script>

  </body>
</html>