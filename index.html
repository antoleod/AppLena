<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Appli de Léna — Menu magique 🦄</title>
<meta name="theme-color" content="#b06fff"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600;700;900&family=Nunito:wght@600;800&display=swap" rel="stylesheet">
<style>
:root{
  /* Mantengo tus variables base (no renombro): */
  --bg:#fdf2ff; --bg2:#fae8ff; --card:rgba(255,255,255,.94); --cardHi:rgba(255,255,255,.88);
  --ink:#2d2252; --muted:#6b5b7a;
  --p1:#b06fff; --p2:#ff8dc7; --p3:#7be0e6; --ok:#22c55e; --bad:#ef4444; --warn:#ffd27e;
  --radius:22px; --shadow:0 12px 28px rgba(176,111,255,.18);
  --h:76px;
  --icon-size:36px;
  --ring:#ff9bd6;
  --bg-speed:26s;
}
/* Tema oscuro */
@media (prefers-color-scheme: dark){
  :root{ --bg:#100d18; --bg2:#1b1632; --card:rgba(255,255,255,.08); --cardHi:rgba(255,255,255,.06); --ink:#efe8ff; --muted:#cdbef0; --shadow:0 10px 28px rgba(0,0,0,.45); --ring:#ffbde0; }
}
html[data-theme="dark"]{
  --bg:#0f0c17; --bg2:#201a3a; --card:rgba(255,255,255,.08); --cardHi:rgba(255,255,255,.06);
  --ink:#efe8ff; --muted:#cdbef0; --shadow:0 10px 28px rgba(0,0,0,.5); --ring:#ffbde0;
}
/* Modo fiesta */
html[data-party="on"]{ --bg-speed:14s; filter:saturate(1.15); }

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:"Nunito", ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
  -webkit-font-smoothing:antialiased;
  background:linear-gradient(135deg,var(--bg),var(--bg2),#e9d5ff);
  background-size:200% 200%; animation:bg-pan var(--bg-speed) linear infinite;
  overflow:hidden;
}
@keyframes bg-pan{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

/* ===== Header pill bar (glass + rainbow) ===== */
header{height:var(--h); display:flex; align-items:center; justify-content:center; padding:10px}
#bar{
  width:min(1140px, 96vw); height:100%; padding:0 14px; display:flex; align-items:center; justify-content:space-between; gap:10px;
  border-radius:24px; background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.78));
  box-shadow:var(--shadow); backdrop-filter:saturate(1.3) blur(8px);
}
#brand{display:flex; align-items:center; gap:12px}
#brand .logo{
  width:46px;height:46px;border-radius:14px;display:grid;place-items:center;
  background: conic-gradient(from 140deg, var(--p1), var(--p2), var(--warn), var(--p3), var(--p1));
  box-shadow: var(--shadow); animation:spinBadge 8s linear infinite;
  position:relative; overflow:hidden;
}
#brand .logo::after{content:"🦄";font-size:26px; filter:drop-shadow(0 2px 4px rgba(0,0,0,.12))}
@keyframes spinBadge{to{transform:rotate(1turn)}}
#brand .title{line-height:1}
#brand .title .t1{font-size:13px}
#brand .title .t2{
  font-size:22px; font-weight:900; font-family:"Fredoka";
  background: linear-gradient(90deg,#ec4899,#f59e0b,#10b981,#3b82f6,#8b5cf6);
  -webkit-background-clip:text; background-clip:text; color:transparent; letter-spacing:.2px;
  text-shadow: 0 2px 8px rgba(176,111,255,.08);
}
#controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.chip{
  border:1px solid transparent;
  background: linear-gradient(#fff,#fff) padding-box,
             linear-gradient(135deg,#ec4899,#f59e0b,#10b981,#3b82f6,#8b5cf6) border-box;
  background-size:100% 100%,300% 300%; animation: rainbow 8s linear infinite;
  color:#1f213a; border-radius:22px; padding:10px 14px; font-weight:800; display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none;
  box-shadow:0 6px 14px rgba(0,0,0,.06);
}
@keyframes rainbow{0%{background-position:0% 0%,0% 0%}100%{background-position:0% 0%,300% 300%}}
.chip.ghost{background:var(--card); color:var(--ink); border:1px solid rgba(167,139,250,.25)}
.chip.badge{background:var(--card); color:var(--muted); border:1px solid rgba(167,139,250,.25)}
#coinChip{border:2px dashed var(--ring); background:#fff; color:#111}

/* ===== Layout ===== */
main{position:absolute; inset:var(--h) 0 0 0; display:grid; grid-template-rows: 1fr}
#home{overflow:auto; padding:24px}
#homeInner{width:min(1140px, 96vw); margin:0 auto}
#grid{display:grid; grid-template-columns: repeat(3, minmax(220px,1fr)); gap:14px; margin-top:14px}
@media (max-width: 980px){ #grid{grid-template-columns:repeat(2, minmax(220px,1fr))} }
@media (max-width: 640px){ #grid{grid-template-columns:1fr} }

/* ===== Menu cards ===== */
.card{
  position:relative; overflow:hidden;
  border:1px solid transparent;
  background: linear-gradient(var(--card), var(--card)) padding-box,
             linear-gradient(135deg,var(--p2),var(--warn),var(--ok),#3b82f6,var(--p1)) border-box;
  background-size:100% 100%,300% 300%; animation: rainbow 8s linear infinite;
  border-radius: var(--radius); padding:18px; box-shadow:0 10px 24px rgba(0,0,0,.10);
  transition: transform .12s, box-shadow .12s, filter .12s;
  display:flex; flex-direction:column; gap:10px;
}
.card:hover{ transform: translateY(-4px) scale(1.02); box-shadow:0 14px 30px rgba(0,0,0,.14); filter:saturate(1.05) }
.cardHeader{display:flex; gap:12px; align-items:center}
.icon{
  --halo: radial-gradient(closest-side, rgba(236,72,153,.22), transparent);
  width:56px;height:56px;border-radius:16px; display:grid;place-items:center; font-size:28px;
  background:#fff; color:#111; border:1px solid rgba(167,139,250,.25);
  box-shadow:0 6px 16px rgba(0,0,0,.10), 0 0 0 10px rgba(236,72,153,.06);
  position:relative; isolation:isolate; animation:float 4.5s ease-in-out infinite;
}
.icon::before{
  content:""; position:absolute; inset:-12px; z-index:-1; border-radius:20px; background:var(--halo); filter:blur(8px);
}
@keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
.ctitle{font-weight:900; font-size:19px; font-family:"Fredoka"; letter-spacing:.2px}
.csub{font-size:12px; color:var(--muted)}
.badge{
  position:absolute; top:10px; right:10px; display:flex; gap:6px; align-items:center;
  background:#fff; color:#6b6b8f; border:1px solid rgba(167,139,250,.25);
  border-radius:999px; padding:4px 8px; font-size:12px; font-weight:900; box-shadow:0 2px 8px rgba(0,0,0,.06)
}
.badge .stars{display:flex; gap:2px; align-items:center}
.stars .s{font-size:14px; filter: drop-shadow(0 2px 4px rgba(0,0,0,.08))}
.stars .off{opacity:.35}

.card .bar{height:6px; width:36%; border-radius:6px; background:linear-gradient(90deg,var(--p1),var(--p2),var(--p3))}
.subs{display:grid; grid-template-columns:repeat(2,minmax(120px,1fr)); gap:8px; margin-top:6px}
.sub{
  border:1px solid transparent; position:relative; overflow:hidden;
  background: linear-gradient(#fff,#fff) padding-box,
             linear-gradient(135deg,var(--p2),var(--warn),var(--ok),#3b82f6,var(--p1)) border-box;
  background-size:100% 100%,300% 300%; animation: rainbow 8s linear infinite;
  color:#1f213a; border-radius:14px; padding:10px 12px; font-weight:900; cursor:pointer; text-align:center;
  box-shadow:0 6px 14px rgba(0,0,0,.06); transition: transform .08s;
}
.sub .stars{position:absolute; left:8px; top:6px}
.sub:hover{ transform: translateY(-2px) scale(1.02); }
.card.collapsed .subs{display:none}

/* ===== Stage ===== */
#stage{display:none; grid-template-rows:auto 8px 1fr auto; height:100%;}
#stageTop{
  display:flex; align-items:center; justify-content:space-between; padding:12px 16px;
  background: var(--card); color: var(--ink);
  border-bottom:1px solid rgba(167,139,250,.25); box-shadow:0 6px 16px rgba(0,0,0,.06);
}
#breadcrumbs{font-weight:900}
#progress{height:8px; background: linear-gradient(90deg, rgba(167,139,250,.25), rgba(236,72,153,.25)); border-top:1px solid rgba(167,139,250,.25); overflow:hidden}
#barProg{height:100%; width:0%; background: linear-gradient(90deg, var(--p1), var(--p2), var(--warn)); transition: width .2s}
#content{padding:16px; overflow:auto; position:relative}
.prompt{font-size:22px; font-weight:900; line-height:1.25; display:flex; align-items:center; gap:10px}
.spark{font-size:24px}
.small{font-size:13px; color:var(--muted)}
.ok{color:var(--ok)} .bad{color:var(--bad)}

/* ===== MCQ Options ===== */
.options{display:grid; grid-template-columns:repeat(2,minmax(200px,1fr)); gap:12px; margin-top:14px}
@media (max-width:720px){.options{grid-template-columns:1fr}}
.option{
  position:relative; border:1px solid rgba(167,139,250,.25);
  background: linear-gradient(180deg,#fff,#fdf2f8); color:#1f213a;
  border-radius:16px; padding:16px; min-height:96px; display:flex; align-items:center; justify-content:center; gap:8px;
  box-shadow:0 10px 20px rgba(0,0,0,.06); cursor:pointer; transition:transform .08s;
  font-size:15px; font-weight:900; font-family:"Fredoka", system-ui;
}
.option:active{transform:scale(.98)}
.option.correct{outline:3px solid var(--ok); outline-offset: 2px; animation:popbtn .22s ease}
.option.wrong{outline:3px solid var(--bad); outline-offset: 2px; animation:shake .35s}
@keyframes popbtn{0%{transform:scale(.98)}70%{transform:scale(1.03)}100%{transform:scale(1)}}
@keyframes shake{10%{transform:translateX(-4px)}20%{transform:translateX(4px)}30%{transform:translateX(-3px)}40%{transform:translateX(3px)}60%{transform:translateX(2px)}100%{transform:translateX(0)}}
.optColor{width:24px;height:24px;border-radius:8px;border:2px solid #0001;display:inline-block;margin-right:8px;vertical-align:-5px}

/* Inputs / ordenación */
.answerBox{display:flex; gap:8px; align-items:center; margin-top:12px}
.answerBox input, textarea{width:100%; padding:12px 14px; border-radius:12px; border:2px solid rgba(167,139,250,.25); background:#fff; color:#111; font-size:18px}
.chips{display:flex; gap:8px; flex-wrap:wrap}
.draggable{user-select:none;background:#fff;border:2px dashed rgba(167,139,250,.45);padding:10px 12px;border-radius:12px;cursor:grab;box-shadow:0 6px 14px rgba(0,0,0,.06)}
.dropzone{min-height:60px;background:#f9f9ff;border:2px dashed rgba(167,139,250,.45);border-radius:12px;padding:8px}

/* Memory flip */
.memoryGrid{display:grid; grid-template-columns:repeat(4,minmax(60px,1fr)); gap:10px; margin-top:12px}
.cardMem{height:110px; position:relative; border-radius:14px; cursor:pointer; perspective:600px}
.cardMem .front,.cardMem .back{
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center; border-radius:14px; backface-visibility:hidden;
  background:#fff; color:#111; box-shadow:0 8px 18px rgba(0,0,0,.08); transition:transform .25s
}
.cardMem .back{ transform:rotateY(180deg); }
.cardMem.flipped .front{ transform:rotateY(180deg); }
.cardMem.flipped .back{ transform:rotateY(0deg); }
.pairGood{outline:4px solid var(--ok)}

/* Sudoku */
.sudoku{display:grid; grid-template-columns:repeat(4,60px); gap:8px; margin-top:10px}
.sudoku input{width:60px;height:60px;text-align:center;font-weight:900;font-size:20px;border-radius:12px;border:1px solid rgba(167,139,250,.35); background:#fff; color:#111; box-shadow:0 8px 18px rgba(0,0,0,.08)}
.fixed{background:#f3f4f6 !important; color:#6b7280}

/* Footer/Buttons */
#stageBottom{padding:10px 16px; display:flex; justify-content:space-between; align-items:center; gap:8px; background: var(--card); color: var(--ink); border-top:1px solid rgba(167,139,250,.25)}
.btn{appearance:none;border:1px solid transparent;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.06)}
.btn.p{background:linear-gradient(90deg,var(--p1),var(--p2)); color:#fff}
.btn.g{background:#fff;color:#1f213a;border:1px solid rgba(167,139,250,.25)}
.btn.s{background:linear-gradient(90deg,var(--ok),#34d399); color:#021}
.btn.d{background:linear-gradient(90deg,var(--bad),#f97393); color:#fff}

/* Flashcards */
.cards{display:grid; grid-template-columns:repeat(2,minmax(200px,1fr)); gap:12px}
.flash{background:#fff;border:1px solid rgba(167,139,250,.25);border-radius:14px;padding:14px;position:relative;min-height:90px; box-shadow:0 10px 20px rgba(0,0,0,.06); color:#111}
.flash .q{font-weight:900}
.flash .a{position:absolute; inset:0; display:grid; place-items:center; font-weight:900; background:#0002; border-radius:14px; opacity:0; transition:opacity .2s}
.flash.show .a{opacity:1}

/* Drawing */
#drawWrap{border:1px dashed rgba(167,139,250,.35); border-radius:16px; padding:10px; display:grid; grid-template-columns:1fr 160px; gap:10px; margin-top:10px; background:var(--card)}
#canvas{background:#fff;border-radius:12px;touch-action:none;border:1px solid rgba(167,139,250,.25)}
#palette{display:grid; grid-template-columns:repeat(2,1fr); gap:8px}
.sw{height:40px;border-radius:10px;border:2px solid #0003}
.sw.sel{outline:3px solid rgba(0,0,0,.15)}
#thick{width:100%}

/* Modal + confetti */
#modal{position:fixed; inset:0; background:rgba(15,23,42,.38); display:none; place-items:center; z-index:60; animation:fade .15s}
#modal .box{background:#fff; color:#1f213a; border-radius:18px; width:min(720px,92vw); padding:18px; box-shadow:0 24px 60px rgba(0,0,0,.25); animation:pop .2s; text-align:center}
#modal h3{margin:8px 0 6px; font-size:18px; font-weight:900; font-family:"Fredoka", system-ui}
@keyframes fade{from{opacity:0}to{opacity:1}}@keyframes pop{from{transform:scale(.92)}to{transform:scale(1)}}
#fx{position:fixed; inset:0; pointer-events:none; z-index:50}

/* Sparkles (click) + scrollbar */
.sparkle{position:fixed; pointer-events:none; width:12px; height:12px; transform:translate(-50%,-50%) scale(.6);
  background:conic-gradient(from 0deg, var(--p1), var(--p2), var(--warn), var(--p3), var(--p1));
  clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%);
  opacity:.9; filter:drop-shadow(0 6px 12px rgba(176,111,255,.35)); animation:spark-pop .8s ease-out forwards}
@keyframes spark-pop{0%{opacity:0; transform:translate(-50%,-50%) scale(.4) rotate(0)}50%{opacity:1}100%{opacity:0; transform:translate(-50%,-80%) scale(1.6) rotate(40deg)}}
::-webkit-scrollbar { height:10px; width:10px; } ::-webkit-scrollbar-thumb { background: linear-gradient(180deg,var(--p1),var(--p2)); border-radius:999px; }

/* Reduce motion */
@media (prefers-reduced-motion: reduce){
  #brand .logo, .card{ animation:none } body{ animation:none } .cardMem .front,.cardMem .back{ transition:none }
}
</style>
</head>
<body>
<header>
  <div id="bar">
    <div id="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">
        <div class="t1">Appli de Léna — 2e primaire</div>
        <div class="t2">Monde licorne magique</div>
      </div>
    </div>
    <div id="controls">
      <div id="coinChip" class="chip">🪙 <span id="coins">0</span></div>
      <div class="chip badge">Niv. <span id="lvl">1</span></div>
      <div id="soundChip" class="chip">🔊 <b id="soundState">ON</b></div>
      <div id="themeChip" class="chip ghost">🌙/☀️ Thème</div>
      <div id="partyChip" class="chip ghost">🎉 Fête</div>
      <div id="fsChip" class="chip ghost">⛶ Plein écran</div>
      <div id="homeChip" class="chip ghost">🏠 Menu</div>
      <div id="avatarChip" class="chip">🙂 <span id="avatarName">Invité</span></div>
      <button id="btnFlash" class="chip">⚡ Révision</button>
      <button id="btnShop" class="chip">🛍️ Boutique</button>
      <button id="btnScores" class="chip">🏆 Scores</button>
    </div>
  </div>
</header>

<main>
  <!-- Home menu grid -->
  <section id="home">
    <div id="homeInner">
      <div class="small">Choisis un thème. Les sous-thèmes apparaissent <b>à l’intérieur</b> de chaque carte. Les ⭐ montrent tes progrès.</div>
      <div id="grid"></div>
    </div>
  </section>

  <!-- Stage (exercises) -->
  <section id="stage">
    <div id="stageTop">
      <div id="breadcrumbs">Accueil</div>
      <div style="display:flex; align-items:center; gap:10px;"><div id="uni" aria-label="licorne">🦄</div></div>
    </div>
    <div id="progress"><div id="barProg"></div></div>
    <div id="content"></div>
    <div id="stageBottom">
      <div class="small" id="tip">Astuce : active le mode plein écran pour mieux jouer</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnPrev" class="btn g">⟵ Précédent</button>
        <button id="btnSkip" class="btn g">Passer</button>
        <button id="btnCheck" class="btn p">Valider</button>
      </div>
    </div>
  </section>
</main>

<!-- Modal -->
<div id="modal">
  <div class="box">
    <h3 id="modalTitle">Titre</h3>
    <div id="modalBody">…</div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
      <button id="modalClose" class="btn s">OK</button>
    </div>
  </div>
</div>

<canvas id="fx"></canvas>

<script>
/* =========================================================
   Appli de Léna — Menu con estrellas y efectos ✨
   ========================================================= */
(() => {
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const shuffle=arr=>arr.sort(()=>Math.random()-.5);
  const choice=arr=>arr[Math.floor(Math.random()*arr.length)];
  const clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
  const strip=s=>(s||"").normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/\s+/g," ").trim().toLowerCase();

  const STORE="lena_menu_v3";
  const state={
    level:1,totalLevels:15,coins:0,sound:true, theme:null, party:false,
    user:{name:"Invité"},
    area:null,sub:null,
    progress:{done:0,total:5},
    asked:new Set(),
    scores:[], inventory:[], album:[],
    stars:{} /* key "area|sub" => 0..3 */,
    block:{correct:0,wrong:0}
  };
  const save=()=>localStorage.setItem(STORE, JSON.stringify({...state,asked:[...state.asked]}));
  const load=()=>{try{const d=JSON.parse(localStorage.getItem(STORE)||"{}");Object.assign(state,d,{asked:new Set()});}catch{}};

  /* ----------- audio ----------- */
  const audio=(()=>{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const beep=(f=700,d=.1,type='sine',v=.18)=>{ if(!state.sound) return;
      const o=ctx.createOscillator(), g=ctx.createGain(); o.type=type; o.frequency.value=f; g.gain.value=v; o.connect(g).connect(ctx.destination);
      o.start(); setTimeout(()=>o.stop(), d*1000);
    };
    return {
      ok(){beep(880,.08,'sine',.15); setTimeout(()=>beep(1320,.1,'sine',.12),80)},
      no(){beep(220,.16,'sawtooth',.15); setTimeout(()=>beep(180,.16,'square',.12),120)},
      click(){beep(520,.05,'triangle',.08)}
    }
  })();

  /* ----------- confetti ----------- */
  const fx=(()=>{
    const c=$("#fx"), ctx=c.getContext("2d"); let W,H,parts=[],raf;
    const resize=()=>{c.width=W=innerWidth; c.height=H=innerHeight}; addEventListener("resize",resize); resize();
    const spawn=(n=140)=>{
      for(let i=0;i<n;i++){
        parts.push({x:Math.random()*W,y:-20,r:rnd(4,8),c:choice(["#8b5cf6","#f472b6","#22d3ee","#f59e0b","#22c55e"]),vx:(Math.random()-.5)*2,vy:rnd(2,4),a:Math.random()*Math.PI});
      }
      loop(); setTimeout(()=>{parts=[]; cancelAnimationFrame(raf);},2200);
    };
    const loop=()=>{cancelAnimationFrame(raf); raf=requestAnimationFrame(loop);
      ctx.clearRect(0,0,W,H);
      parts.forEach(p=>{p.x+=p.vx; p.y+=p.vy; p.a+=.1; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a);
        ctx.fillStyle=p.c; ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2); ctx.restore();});
      parts=parts.filter(p=>p.y<H+40);
    };
    return {spawn};
  })();

  /* ----------- sparkles on click ----------- */
  function sparkleAt(x,y,count=6){
    for(let i=0;i<count;i++){
      const s=document.createElement("div"); s.className="sparkle";
      s.style.left=(x+rnd(-12,12))+"px"; s.style.top=(y+rnd(-8,8))+"px";
      document.body.appendChild(s); setTimeout(()=>s.remove(),800);
    }
  }
  document.addEventListener("pointerdown",e=>{
    if(e.target.closest(".sub,.card,.option,.chip")) sparkleAt(e.clientX,e.clientY,8);
  });

  /* ----------- header chips ----------- */
  $("#fsChip").onclick=()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else document.exitFullscreen(); };
  $("#soundChip").onclick=()=>{ state.sound=!state.sound; $("#soundState").textContent=state.sound?"ON":"OFF"; save(); };
  $("#homeChip").onclick=()=> showHome();
  $("#btnFlash").onclick=()=> openFlashcards();
  $("#btnShop").onclick=()=> openShop();
  $("#btnScores").onclick=()=> showScores();
  $("#themeChip").onclick=()=>{ // toggle dark/light
    const now = document.documentElement.getAttribute("data-theme");
    if(now==="dark"){ document.documentElement.removeAttribute("data-theme"); state.theme=null; }
    else { document.documentElement.setAttribute("data-theme","dark"); state.theme="dark"; }
    save();
  };
  $("#partyChip").onclick=()=>{ state.party=!state.party; document.documentElement.setAttribute("data-party", state.party?"on":"off"); if(state.party) fx.spawn(); save(); };

  /* ----------- HUD ----------- */
  const refreshHUD=()=>{ $("#coins").textContent=state.coins; $("#lvl").textContent=state.level; $("#barProg").style.width=Math.round((state.progress.done/state.progress.total)*100)+"%"; };

  /* ----------- areas + subtopics (menu) ----------- */
  const AREAS=[
    {id:"fr",  icon:"🇫🇷", title:"Français", sub:"Lecture, vocabulaire, grammaire",
      subs:[{id:"lecture",name:"Lecture"},{id:"vocab",name:"Vocabulaire"},{id:"gram",name:"Grammaire"},
            {id:"ecrit",name:"Expression écrite"},{id:"dialogue",name:"Dialogue oral"}]},
    {id:"math",icon:"🎯", title:"Mathématiques", sub:"+  −  ×  ÷",
      subs:[{id:"addsub",name:"Add/Sous"},{id:"mult",name:"Multiplications"},
            {id:"div",name:"Divisions"}, {id:"eq",name:"Équations"},
            {id:"ordre",name:"Ordre"}, {id:"base10",name:"Unités-Dizaines"},
            {id:"problemes",name:"Problèmes"}]},
    {id:"sciences", icon:"🌍", title:"Monde & Sciences", sub:"Saisons, famille, santé",
      subs:[{id:"saisons",name:"Saisons & météo"},{id:"famille",name:"Famille"},
            {id:"hygiene",name:"Hygiène"}, {id:"aliments",name:"Alimentation"},
            {id:"corps",name:"Parties du corps"}]},
    {id:"arts", icon:"🎨", title:"Arts & couleurs", sub:"Mélanges, dessin",
      subs:[{id:"melanges",name:"Mélanges de couleurs"},{id:"dessin",name:"Dessin interactif"}]},
    {id:"num", icon:"💻", title:"Culture numérique", sub:"Souris, icônes, sécurité",
      subs:[{id:"icones",name:"Icônes"},{id:"souris",name:"Souris & clavier"},{id:"securite",name:"Sécurité Internet"}]},
    {id:"logique", icon:"🧩", title:"Jeux logiques", sub:"Mémoire, Sudoku, motifs",
      subs:[{id:"paires",name:"Paires / mémoire"},{id:"sudoku",name:"Sudoku 4×4"},{id:"patterns",name:"Séquences"}]},
  ];

  function starRow(n){ // 0..3
    const full = "⭐".repeat(n), empty = "⭐".repeat(3-n);
    return `<div class="stars" aria-label="${n} étoiles"><span class="s">${full||""}</span>${n<3?`<span class="s off">${empty}</span>`:""}</div>`;
  }

  function renderMenu(){
    const g=$("#grid"); g.innerHTML="";
    AREAS.forEach(a=>{
      const keyArea = a.id+"|*";
      const starsArea = Math.max(0, ...a.subs.map(s=> state.stars[a.id+"|"+s.id]||0));
      const card=document.createElement("div"); card.className="card collapsed"; card.dataset.area=a.id;
      card.innerHTML=`
        <div class="badge">${a.subs.length} sous-thèmes ${starRow(starsArea)}</div>
        <div class="cardHeader">
          <div class="icon">${a.icon}</div>
          <div>
            <div class="ctitle">${a.title}</div>
            <div class="csub">${a.sub}</div>
          </div>
        </div>
        <div class="bar"></div>
        <div class="subs"></div>
      `;
      const subs=card.querySelector(".subs");
      a.subs.forEach(s=>{
        const key=a.id+"|"+s.id; const st=state.stars[key]||0;
        const b=document.createElement("div"); b.className="sub"; b.dataset.sub=s.id;
        b.innerHTML = `${starRow(st)} ${s.name}`;
        b.onclick=()=>{ sparkleAt(innerWidth/2, 100, 10); state.area=a; state.sub=s; startBlock(); };
        subs.appendChild(b);
      });
      card.querySelector(".cardHeader").onclick=()=>{ card.classList.toggle("collapsed"); };
      g.appendChild(card);
    });
  }

  /* ----------- Stage flow ----------- */
  function showHome(){ $("#home").style.display="block"; $("#stage").style.display="none"; $("#breadcrumbs").textContent="Accueil"; renderMenu(); }
  function showStage(){ $("#home").style.display="none"; $("#stage").style.display="grid"; }
  function exercisesForLevel(L){ return clamp(5 + Math.round((L-1)*((20-5)/(state.totalLevels-1))), 5, 20); }
  function startBlock(){
    state.progress.total=exercisesForLevel(state.level);
    state.progress.done=0; state.asked=new Set(); state.block={correct:0,wrong:0};
    $("#barProg").style.width="0%";
    $("#breadcrumbs").textContent=`${state.area.title} › ${state.sub.name}`;
    showStage(); nextQuestion();
  }

  const engine={
    qcm(q){
      $("#content").innerHTML=`<div class="prompt"><span class="spark">🪄</span>${q.text}</div><div class="options" id="opts"></div>`;
      const opts=$("#opts");
      q.options.forEach((op,i)=>{
        const el=document.createElement("div"); el.className="option"; el.dataset.idx=i;
        el.innerHTML = `${op.color?`<span class="optColor" style="background:${op.color}"></span>`:""} <span>${op.label}</span>`;
        el.onclick=()=> evaluate(i===q.correct,q,op.label,el);
        opts.appendChild(el);
      });
      bindNav(true);
    },
    input(q){
      $("#content").innerHTML=`<div class="prompt">✍️ ${q.text}</div>
        <div class="answerBox"><input id="ans" type="${q.kind||'text'}" placeholder="${q.placeholder||'Ta réponse'}"/></div>`;
      $("#ans").focus();
      $("#btnCheck").onclick=()=>{ const v=$("#ans").value; const ok=q.check(v); evaluate(ok,q,v); };
      bindNav(true);
    },
    order(q){
      $("#content").innerHTML=`<div class="prompt">🔢 ${q.text}</div>
        <div class="chips" id="pool"></div>
        <div class="small">Place dans la boîte :</div>
        <div class="dropzone" id="drop"></div>`;
      const pool=$("#pool"), drop=$("#drop");
      q.items.forEach((it,i)=>{const c=document.createElement("div"); c.className="draggable"; c.textContent=it; c.draggable=true; c.addEventListener("dragstart",e=>{e.dataTransfer.setData("text/plain",it)}); pool.appendChild(c);});
      [pool,drop].forEach(z=>{
        z.addEventListener("dragover",e=>e.preventDefault());
        z.addEventListener("drop",e=>{
          e.preventDefault();
          const t=e.dataTransfer.getData("text/plain");
          const from=[pool,drop].find(zz=>[...zz.children].some(x=>x.textContent===t));
          const node=[...from.children].find(x=>x.textContent===t);
          if(node&&z!==from) z.appendChild(node);
        });
      });
      $("#btnCheck").onclick=()=>{ const arr=[...drop.children].map(x=>x.textContent); const ok=q.check(arr); evaluate(ok,q,arr.join(", ")); };
      bindNav(true);
    },
    memory(q){
      $("#content").innerHTML=`<div class="prompt">🧠 ${q.text}</div><div class="memoryGrid" id="mem"></div>`;
      const grid=$("#mem"); let first=null, lock=false, pairs=0;
      q.deck.forEach(card=>{
        const el=document.createElement("div"); el.className="cardMem"; el.dataset.val=card.v;
        el.innerHTML=`<div class="front">🎴</div><div class="back">${card.e}</div>`;
        el.onclick=()=>{
          if(lock || el.classList.contains("done")) return;
          el.classList.add("flipped");
          if(!first){ first=el; audio.click(); return; }
          lock=true; setTimeout(()=>{
            if(first.dataset.val===el.dataset.val){
              first.classList.add("done","pairGood"); el.classList.add("done","pairGood"); pairs++; audio.ok();
              if(pairs===q.pairs){ evaluate(true,q,"Mémoire OK"); }
            } else { first.classList.remove("flipped"); el.classList.remove("flipped"); audio.no(); }
            first=null; lock=false;
          }, 420);
        };
        grid.appendChild(el);
      });
      bindNav(false);
    },
    sudoku(q){
      $("#content").innerHTML=`<div class="prompt">🧮 Sudoku 4×4 — complète (1–4)</div>
        <div class="sudoku" id="sudoku"></div>
        <div style="margin-top:8px"><button class="btn g" id="btnClear">Effacer</button></div>`;
      const wrap=$("#sudoku");
      q.grid.forEach((v,i)=>{
        const inp=document.createElement("input"); inp.maxLength=1;
        if(v){ inp.value=v; inp.disabled=true; inp.className="fixed"; }
        inp.oninput=()=>{ inp.value=inp.value.replace(/[^1-4]/g,''); };
        wrap.appendChild(inp);
      });
      $("#btnClear").onclick=()=> $$("#sudoku input:not(.fixed)").forEach(i=>i.value="");
      $("#btnCheck").onclick=()=>{ const vals=$$("#sudoku input").map(i=>+i.value||0); const ok=q.check(vals); evaluate(ok,q,"Grille"); };
      bindNav(true);
    },
    drawing(q){
      $("#content").innerHTML=`<div class="prompt">🎨 ${q.text}</div>
        <div id="drawWrap">
          <canvas id="canvas" width="800" height="480"></canvas>
          <div>
            <div style="font-weight:900">Palette</div>
            <div id="palette"></div>
            <div style="margin-top:10px">Épaisseur : <input type="range" id="thick" min="2" max="24" value="8"/></div>
            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
              <button id="clearCanvas" class="btn g">Effacer</button>
              <button id="validateDrawing" class="btn s">J'ai fini</button>
            </div>
          </div>
        </div>`;
      const colors=["#000","#f43f5e","#f59e0b","#22c55e","#3b82f6","#a855f7","#ff99c8","#a9def9","#caffbf"];
      const pal=$("#palette");
      const canvas=$("#canvas"), ctx=canvas.getContext("2d");
      ctx.lineCap="round"; ctx.lineJoin="round"; ctx.strokeStyle=colors[0]; ctx.lineWidth=8;
      colors.forEach((c,i)=>{const sw=document.createElement("div"); sw.className="sw"; sw.style.background=c; if(i===0) sw.classList.add("sel"); sw.onclick=()=>{ $$("#palette .sw").forEach(x=>x.classList.remove("sel")); sw.classList.add("sel"); ctx.strokeStyle=c; }; pal.appendChild(sw);});
      let drawing=false, moves=0, used=new Set([colors[0]]), last=[0,0];
      const pos=e=>{const r=canvas.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; return [x,y];};
      const start=e=>{drawing=true; last=pos(e);};
      const draw=e=>{ if(!drawing) return; const [x,y]=pos(e); ctx.beginPath(); ctx.moveTo(...last); ctx.lineTo(x,y); ctx.stroke(); last=[x,y]; moves++; used.add(ctx.strokeStyle);};
      const end=()=>{drawing=false;};
      canvas.addEventListener("mousedown",start); addEventListener("mouseup",end); canvas.addEventListener("mousemove",draw);
      canvas.addEventListener("touchstart",e=>{start(e); e.preventDefault();},{passive:false});
      canvas.addEventListener("touchmove",e=>{draw(e); e.preventDefault();},{passive:false});
      canvas.addEventListener("touchend",end);
      $("#thick").oninput=e=> ctx.lineWidth=+e.target.value;
      $("#clearCanvas").onclick=()=>{ctx.clearRect(0,0,canvas.width,canvas.height); moves=0; used=new Set()};
      $("#validateDrawing").onclick=()=>{ const ok=moves>250 && used.size>=3; evaluate(ok,q,"dessin"); };
      bindNav(true);
    },
    flash(cards){
      $("#home").style.display="none"; $("#stage").style.display="grid";
      $("#breadcrumbs").textContent="Révision rapide";
      $("#content").innerHTML=`<div class="prompt"><span class="spark">⚡</span>Révision rapide — clique pour révéler</div><div class="cards" id="fc"></div>`;
      const wrap=$("#fc"); cards.forEach(c=>{const el=document.createElement("div"); el.className="flash"; el.innerHTML=`<div class="q">${c.q}</div><div class="a">${c.a}</div>`; el.onclick=()=>el.classList.toggle("show"); wrap.appendChild(el);});
      $("#btnCheck").style.display="none"; $("#btnSkip").style.display="inline-flex"; $("#btnPrev").style.display="inline-flex";
      $("#btnPrev").onclick=showHome; $("#btnSkip").onclick=showHome;
    }
  };

  function bindNav(checkable){
    $("#btnCheck").style.display=checkable?"inline-flex":"none";
    $("#btnPrev").onclick=()=> showModal("Info","Tu ne peux pas revenir en arrière pendant un bloc. Courage ! 💪");
    $("#btnSkip").onclick=()=>{ state.progress.done++; refreshHUD(); nextQuestion(); };
  }

  function nextQuestion(){
    if(state.progress.done>=state.progress.total){ endOfBlock(); return; }
    // petite pause mouvement toutes les 4 questions
    if(state.progress.done>0 && state.progress.done%4===0){
      const move=choice(["Lève-toi et touche tes orteils 5 fois !","Imite un chat pendant 10 secondes 😺","Saute comme une grenouille 6 fois 🐸","Fais un tour sur toi-même 🌀"]);
      $("#content").innerHTML=`<div class="prompt">🤸 Pause mouvement :</div><div style="margin-top:10px;font-weight:900;font-size:20px">${move}</div>
      <div style="margin-top:10px"><button class="btn s" id="doneMove">Je l’ai fait ! (+1🪙)</button></div>`;
      $("#doneMove").onclick=()=>{ win(1); state.progress.done++; refreshHUD(); nextQuestion(); };
      $("#btnCheck").style.display="none"; $("#btnSkip").style.display="inline-flex";
      return;
    }
    let q, tries=0;
    do { q = makeQuestion(state.area.id, state.sub.id); tries++; if(tries>50) break; } while(state.asked.has(q.id));
    state.asked.add(q.id); state.current=q;
    if(q.type==="qcm") engine.qcm(q);
    else if(q.type==="input") engine.input(q);
    else if(q.type==="order") engine.order(q);
    else if(q.type==="memory") engine.memory(q);
    else if(q.type==="sudoku") engine.sudoku(q);
    else if(q.type==="drawing") engine.drawing(q);
    else engine.qcm(q);
    refreshHUD();
  }

  function evaluate(ok,q,userAns,el){
    if(ok){
      state.block.correct++;
      if(el) el.classList.add("correct");
      win(1); state.progress.done++; refreshHUD();
      setTimeout(nextQuestion,360);
    } else {
      state.block.wrong++;
      if(el) el.classList.add("wrong");
      lose(2);
      showModal("Oups ❌", `La bonne réponse : <b>${solutionOf(q)}</b><br><small>${q.explain||"Regarde bien l’énoncé 👀"}</small>`);
    }
  }
  const solutionOf=q=> q.type==="qcm" ? (q.options[q.correct]?.label ?? "—") : "Voir explication.";

  function endOfBlock(){
    // estrellas según errores: 3 (0 erreur), 2 (≤2), 1 (sinon)
    const w = state.block.wrong;
    const stars = w===0?3 : (w<=2?2:1);
    const key = state.area.id+"|"+state.sub.id;
    state.stars[key] = Math.max(state.stars[key]||0, stars);
    save();

    fx.spawn();
    showModal("🎉 Bravo !", `
      <p>Tu as terminé le niveau ${state.level} (${state.progress.total} exercices).</p>
      <p>Billets-unicorne : <b>${state.coins}</b> 🪙</p>
      <div style="font-size:24px">Tes étoiles pour <b>${state.sub.name}</b> : ${"⭐".repeat(stars)}${stars<3?`<span style="opacity:.35">${"⭐".repeat(3-stars)}</span>`:""}</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button class="btn s" id="goNext">Continuer niveau suivant</button>
        <button class="btn g" id="stay">Rejouer ce niveau</button>
        <button class="btn g" id="goHome">Aller au menu</button>
      </div>
    `, ()=>{
      $("#goNext").onclick=()=>{ state.level=Math.min(state.totalLevels,state.level+1); startBlock(); hideModal(); };
      $("#stay").onclick=()=>{ startBlock(); hideModal(); };
      $("#goHome").onclick=()=>{ hideModal(); showHome(); };
      state.scores.unshift({name:state.user.name||"Joueur",coins:state.coins,level:state.level,at:Date.now()});
      state.scores=state.scores.slice(0,20); save();
    });
  }

  function win(n){ state.coins+=n; save(); audio.ok(); }
  function lose(n){ state.coins=Math.max(0,state.coins-n); save(); audio.no(); }

  /* ----------- Modal helpers ----------- */
  function showModal(title, html, onOpen){
    $("#modalTitle").innerHTML=title; $("#modalBody").innerHTML=html; $("#modal").style.display="grid";
    $("#modalClose").onclick=hideModal; if(onOpen) onOpen();
  }
  function hideModal(){ $("#modal").style.display="none"; }

  /* ----------- Shop & scores ----------- */
  const SHOP=[
    {id:"rainbow",name:"Arc-en-ciel", price:12, emoji:"🌈"},
    {id:"etoile", name:"Étoile", price:6, emoji:"⭐"},
    {id:"coeur",  name:"Cœur",   price:7, emoji:"💖"},
    {id:"licorne",name:"Mini-licorne", price:18, emoji:"🦄"},
    {id:"fleur",  name:"Fleur",  price:5, emoji:"🌸"},
    {id:"soleil", name:"Soleil", price:8, emoji:"☀️"},
  ];
  function openShop(){
    const owned=id=>state.inventory.includes(id);
    const rows=SHOP.map(it=>`
      <div class="flash" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div><span style="font-size:22px">${it.emoji}</span> <b>${it.name}</b> — ${it.price}🪙</div>
        ${owned(it.id)? '<span class="small">Déjà acheté</span>':'<button class="btn p" data-buy="'+it.id+'">Acheter</button>'}
      </div>`).join("");
    showModal("🛍️ Boutique", `<div>${rows}</div><div class="small" style="margin-top:6px">Les stickers peuvent être placés sur la zone de jeu.</div>`, ()=>{
      $("#modalBody").onclick=e=>{
        const id=e.target?.dataset?.buy; if(!id) return;
        const item=SHOP.find(x=>x.id===id);
        if(state.coins<item.price){ showModal("Boutique", `Pas assez de billets pour <b>${item.name}</b>. Continue de jouer !`); return; }
        state.coins-=item.price; state.inventory.push(id); save(); refreshHUD(); hideModal(); openShop();
      };
    });
  }
  function showScores(){
    const rows=(state.scores||[]).slice(0,12).map(s=>`<tr><td>${s.name}</td><td>${s.coins}🪙</td><td>Niv. ${s.level}</td><td>${new Date(s.at).toLocaleDateString()}</td></tr>`).join("");
    showModal("🏆 Scores (local)", `
      <table style="width:100%;border-collapse:collapse">
        <thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #eee">Joueur</th>
        <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">Billets</th>
        <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">Progrès</th>
        <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">Date</th></tr></thead>
        <tbody>${rows || '<tr><td colspan="4" style="padding:6px">Aucun score enregistré.</td></tr>'}</tbody>
      </table>
      <div style="display:flex;gap:8px;margin-top:10px">
        <input id="nameInput" placeholder="Ton prénom" style="flex:1;padding:10px;border-radius:10px;border:1px solid #ddd">
        <button id="saveScore" class="btn s">Enregistrer ce score</button>
      </div>
    `, ()=>{
      $("#saveScore").onclick=()=>{
        const name=($("#nameInput").value||"Joueur").slice(0,16);
        state.scores.unshift({name, coins:state.coins, level:state.level, at:Date.now()});
        state.scores=state.scores.slice(0,20); save(); hideModal();
      };
    });
  }

  /* ----------- Flashcards ----------- */
  function openFlashcards(){
    const cards=shuffle([
      {q:"bleu + jaune = ?", a:"vert"},
      {q:"Synonyme de « papa » ?", a:"père"},
      {q:"3 × 4 = ?", a:"12"},
      {q:"Icône 💾 ?", a:"Sauvegarder"},
      {q:"Saison de la neige ?", a:"hiver"},
      {q:"Unités avant dizaines ?", a:"unités"},
      {q:"Mot de passe : le partager ?", a:"Non !"}
    ]).slice(0,8);
    engine.flash(cards);
  }

  /* ----------- Fabrique de questions ----------- */
  // FR
  const FR={
    lecture(){
      const tales=[
        {t:"Mina trouve une graine. Elle la plante. Un matin, une petite fleur apparaît.", q:"Vrai ou faux : Mina a planté une graine ?", a:true, exp:"On lit « Elle la plante »."},
        {t:"Lucas a un cerf-volant rouge. Il pleut. Lucas décide d’attendre.", q:"Vrai ou faux : Lucas joue sous la pluie.", a:false, exp:"Il décide d’attendre."},
        {t:"Zoé voit un chat et un chien. Le chat dort, le chien court.", q:"Qui dort ?", a:"le chat", choices:["le chat","le chien","les deux"], exp:"« Le chat dort »."}
      ];
      const s=choice(tales);
      if(typeof s.a==="boolean"){
        return {id:"fr-lecture-"+s.t,type:"qcm",text:`Lis : « ${s.t} » — ${s.q}`,options:[{label:"Vrai"},{label:"Faux"}],correct:s.a?0:1, explain:s.exp};
      } else {
        const opts=shuffle(s.choices).map(x=>({label:x})); const correct=opts.findIndex(o=>o.label===s.a);
        return {id:"fr-lecture-"+s.t,type:"qcm",text:`Lis : « ${s.t} » — ${s.q}`,options:opts,correct, explain:s.exp};
      }
    },
    vocab(){
      const cat=choice([
        {name:"animaux", pairs:[["chat","🐱"],["chien","🐶"],["poisson","🐟"],["oiseau","🐦"],["lion","🦁"],["souris","🐭"]]},
        {name:"vêtements", pairs:[["chapeau","👒"],["chaussures","👟"],["pantalon","👖"],["robe","👗"],["manteau","🧥"],["gants","🧤"]]},
        {name:"saisons", pairs:[["printemps","🌸"],["été","☀️"],["automne","🍂"],["hiver","❄️"]]},
        {name:"famille", pairs:[["maman","👩"],["papa","👨"],["frère","👦"],["sœur","👧"],["bébé","👶"],["grand-mère","👵"]]},
        {name:"couleurs", pairs:[["rouge","🔴"],["bleu","🔵"],["jaune","🟡"],["vert","🟢"],["violet","🟣"],["orange","🟠"]]}
      ]);
      const pair=choice(cat.pairs); let opts=shuffle(cat.pairs.map(p=>p[0])).slice(0,4); if(!opts.includes(pair[0])) opts[0]=pair[0];
      return {id:`fr-vocab-${cat.name}-${pair[0]}`, type:"qcm", text:`Choisis le mot qui correspond à ${pair[1]} (${cat.name}).`, options:opts.map(x=>({label:x})), correct:opts.indexOf(pair[0]), explain:`${pair[1]} correspond à « ${pair[0]} ».`};
    },
    gram(){
      const t=choice(["genre","pluriel","etreavoir"]);
      if(t==="genre"){
        const pairs=[["une","fille"],["un","garçon"],["une","pomme"],["un","livre"]]; const p=choice(pairs);
        return {id:`fr-gram-genre-${p.join("-")}`, type:"qcm", text:`Choisis le bon genre : ____ ${p[1]}`, options:[{label:"un"},{label:"une"}], correct:p[0]==="un"?0:1, explain:`On dit « ${p[0]} ${p[1]} ».`};
      }
      if(t==="pluriel"){
        const w=choice([["cheval","chevaux"],["animal","animaux"],["chou","choux"],["chien","chiens"]]);
        const arr=shuffle([w[1], w[0]+"s", w[0]+"x", w[0]]);
        return {id:`fr-gram-pluriel-${w[0]}`, type:"qcm", text:`Quel est le pluriel de « ${w[0]} » ?`, options:arr.map(x=>({label:x})), correct:arr.indexOf(w[1]), explain:`Le pluriel de « ${w[0]} » est « ${w[1]} ».`};
      }
      const subj=choice(["Je","Tu","Il","Elle","Nous","Vous","Ils"]); const verb=choice(["être","avoir"]);
      const forms={"être":{"Je":"suis","Tu":"es","Il":"est","Elle":"est","Nous":"sommes","Vous":"êtes","Ils":"sont"},"avoir":{"Je":"ai","Tu":"as","Il":"a","Elle":"a","Nous":"avons","Vous":"avez","Ils":"ont"}};
      const corr=forms[verb][subj]; const opts=shuffle([corr, choice(["es","est","a","ont","avez","sommes","ai","as"]), choice(["serai","aurai"])]);
      return {id:`fr-etreavoir-${subj}-${verb}`, type:"qcm", text:`Conjugue ${verb} : ${subj} ___`, options:opts.map(x=>({label:x})), correct:opts.indexOf(corr), explain:`${subj} ${corr}.`};
    },
    ecrit(){
      const sentence=choice(["Le chat saute sur le mur.","Aujourd’hui il fait beau.","La licorne brille dans le ciel.","Nous aimons lire des contes."]);
      return {id:`fr-ecrit-${sentence}`, type:"input", text:"Copie la phrase exactement :", kind:"text", placeholder:sentence, check:v=>strip(v)===strip(sentence), explain:`Réponse attendue : « ${sentence} ».`};
    },
    dialogue(){
      const dial=choice([
        {q:"— Bonjour ! Ça va ?\n— __________", a:"Oui, très bien merci !", wrong:["Je m’appelle Léo.","Bleu et rouge.","Au revoir."]},
        {q:"— Tu veux jouer avec moi ?\n— __________", a:"Oui, avec plaisir !", wrong:["J’ai huit ans.","Je mange une pomme.","Il pleut."]},
        {q:"— Merci pour ton aide !\n— __________", a:"De rien !", wrong:["Bonjour !","À demain.","Peut-être."]}
      ]);
      const opts=shuffle([dial.a,...dial.wrong]).map(x=>({label:x}));
      return {id:`fr-dialogue-${dial.a}`, type:"qcm", text:`Choisis la bonne réplique :<br><pre style="white-space:pre-wrap;background:#fff;border:1px solid #eee;padding:10px;border-radius:10px">${dial.q}</pre>`, options:opts, correct:opts.findIndex(o=>o.label===dial.a), explain:`On répond : « ${dial.a} ».`};
    }
  };

  // MATH
  const MATH={
    addsub(lvl){
      const a=rnd(0,40+lvl*4), b=rnd(0,40+lvl*4), add=Math.random()<.5; const res=add?a+b:a-b;
      const text=`${a} ${add?"+":"−"} ${b} = ?`;
      const arr=shuffle([res,res+rnd(1,5), res-rnd(1,5), res+rnd(6,10)]);
      return {id:`m-addsub-${a}-${b}-${add}`, type:"qcm", text, options:arr.map(x=>({label:String(x)})), correct:arr.indexOf(res), explain:`On calcule : ${a} ${add?"+":"−"} ${b} = ${res}.`};
    },
    mult(lvl){
      const table=choice([1,2,3,4,5,10]); const b=rnd(1,10+lvl); const res=table*b;
      const arr=shuffle([res, res+table, res-table, res+2]);
      return {id:`m-mult-${table}-${b}`, type:"qcm", text:`${table} × ${b} = ?`, options:arr.map(x=>({label:String(x)})), correct:arr.indexOf(res), explain:`Table de ${table} : ${table}×${b}=${res}.`};
    },
    div(lvl){
      const groups=rnd(2,5), each=rnd(2,5+Math.floor(lvl/2)), total=groups*each;
      const arr=shuffle([each, each+1, each-1, each+2]);
      return {id:`m-div-${groups}-${each}`, type:"qcm", text:`On partage ${total} bonbons en ${groups} groupes égaux. Combien dans chaque groupe ?`, options:arr.map(x=>({label:String(x)})), correct:arr.indexOf(each), explain:`${total} ÷ ${groups} = ${each}.`};
    },
    eq(){
      const a=rnd(1,30), b=rnd(1,30), c=a+b, miss=choice(["a","b","c"]);
      if(miss==="a"){const arr=shuffle([a,a+1,a-1,a+2]); return {id:`m-eq-a-${a}-${b}`, type:"qcm", text:`□ + ${b} = ${c}`, options:arr.map(x=>({label:String(x)})), correct:arr.indexOf(a), explain:`${c} − ${b} = ${a}.`};}
      if(miss==="b"){const arr=shuffle([b,b+1,b-1,b+2]); return {id:`m-eq-b-${a}-${b}`, type:"qcm", text:`${a} + □ = ${c}`, options:arr.map(x=>({label:String(x)})), correct:arr.indexOf(b), explain:`${c} − ${a} = ${b}.`};}
      const arr=shuffle([c,c+1,c-1,c+2]); return {id:`m-eq-c-${a}-${b}`, type:"qcm", text:`${a} + ${b} = □`, options:arr.map(x=>({label:String(x)})), correct:arr.indexOf(c), explain:`${a}+${b}=${c}.`};
    },
    ordre(){
      const arr=[rnd(0,99),rnd(0,99),rnd(0,99),rnd(0,99)]; const mode=Math.random()<.5?"croissant":"décroissant";
      return {id:`m-ordre-${arr.join("-")}-${mode}`, type:"order", text:`Range ces nombres en ordre ${mode} :`, items:shuffle(arr.map(x=>String(x))), check(ans){const sorted=[...arr].sort((a,b)=> mode==="croissant"?a-b:b-a).map(String); return JSON.stringify(ans)===JSON.stringify(sorted);}, explain:`Ordre ${mode}.`};
    },
    base10(){
      const d=rnd(0,9), u=rnd(0,9), n=d*10+u;
      const opts=shuffle([`${d} diz. et ${u} unit.`, `${d+1} diz. et ${u-10} unit.`, `${d-1} diz. et ${u+10} unit.`, `${d} diz. et ${u+1} unit.`]);
      return {id:`m-b10-${n}`, type:"qcm", text:`Décompose ${n} en dizaines et unités.`, options:opts.map(x=>({label:x})), correct:opts.indexOf(`${d} diz. et ${u} unit.`), explain:`${n} = ${d} dizaines et ${u} unités.`};
    },
    problemes(){
      const a=rnd(2,9), b=rnd(2,9), r=a+b;
      const arr=shuffle([r,r+1,r-1,r+2]);
      return {id:`m-prob-${a}-${b}`, type:"qcm", text:`Léna achète ${a} pommes et ${b} poires. Combien de fruits a-t-elle ?`, options:arr.map(x=>({label:String(x)})), correct:arr.indexOf(r), explain:`On additionne : ${a}+${b}=${r}.`};
    }
  };

  // SCIENCES
  const SCI={
    saisons(){const q=choice([{act:"On fait un bonhomme de neige",season:"hiver",emoji:"⛄"},{act:"On nage à la plage",season:"été",emoji:"🏖️"},{act:"Les feuilles tombent",season:"automne",emoji:"🍂"},{act:"Les fleurs poussent",season:"printemps",emoji:"🌸"}]); const opts=shuffle(["printemps","été","automne","hiver"]); return {id:"sci-saison-"+q.act,type:"qcm",text:`${q.emoji} ${q.act}. Quelle saison ?`, options:opts.map(x=>({label:x})), correct:opts.indexOf(q.season), explain:`C’est en ${q.season}.`};},
    famille(){const q=choice([{p:"La sœur de ma maman est ma …",a:"tante"},{p:"Le fils de ma tante est mon …",a:"cousin"},{p:"Le père de mon père est mon …",a:"grand-père"}]); const opts=shuffle([q.a,"ami","voisin","frère"]); return {id:"sci-fam-"+q.a,type:"qcm",text:q.p,options:opts.map(x=>({label:x})),correct:opts.indexOf(q.a), explain:`On dit : ${q.a}.`};},
    hygiene(){const pairs=[["Se laver les mains avant de manger","bon"],["Se brosser les dents deux fois par jour","bon"],["Garder un mouchoir usé dans la poche","mauvais"],["Boire de l’eau","bon"]]; const q=choice(pairs); const opts=["bon","mauvais"]; return {id:"sci-hyg-"+q[0],type:"qcm",text:`Est-ce un geste d’hygiène : « ${q[0]} » ?`,options:opts.map(x=>({label:x})),correct:opts.indexOf(q[1]), explain:`C’est « ${q[1]} ».`};},
    aliments(){const good=choice(["pomme 🍎","carotte 🥕","riz 🍚","yaourt 🥛"]); const bad=choice(["bonbon 🍬","soda 🥤","chips 🍟"]); const opts=shuffle([good,bad, choice(["poisson 🐟","eau 💧","fromage 🧀"])]); return {id:"sci-alim-"+good,type:"qcm",text:`Quel aliment est le plus sain pour le goûter ?`,options:opts.map(x=>({label:x})),correct:opts.indexOf(good), explain:`Choisis plutôt ${good}.`};},
    corps(){const pairs=[["Voir","les yeux 👀"],["Sentir","le nez 👃"],["Marcher","les jambes 🦵"],["Saisir","les mains ✋"]]; const q=choice(pairs); const opts=shuffle(pairs.map(p=>p[1])); return {id:"sci-corps-"+q[0], type:"qcm", text:`Pour « ${q[0]} », quelle partie du corps ?`, options:opts.map(x=>({label:x})), correct:opts.indexOf(q[1]), explain:`On utilise ${q[1]}.`};}
  };

  // ARTS
  const ARTS={
    melanges(){const mix=choice([{a:"🔵 bleu",b:"🟡 jaune",res:"🟢 vert",color:"#22cc88"},{a:"🔴 rouge",b:"🔵 bleu",res:"🟣 violet",color:"#8a2be2"},{a:"🔴 rouge",b:"🟡 jaune",res:"🟠 orange",color:"#ff8c00"}]); const arr=shuffle(["🟢 vert","🟣 violet","🟠 orange"]); return {id:"art-mix-"+mix.res,type:"qcm",text:`Mélange ${mix.a} + ${mix.b} = ?`, options:arr.map(x=>({label:x, color: x.includes("vert")?"#22cc88":x.includes("violet")?"#8a2be2":"#ff8c00"})), correct:arr.indexOf(mix.res), explain:`Résultat : ${mix.res}.`};},
    dessin(){return {id:"art-dessin", type:"drawing", text:"Dessine librement (utilise au moins 3 couleurs et remplis bien la feuille)."};}
  };

  // NUM
  const NUM={
    icones(){const pairs=[["💾","Sauvegarder"],["🖨️","Imprimer"],["❌","Fermer"],["🔍","Rechercher"]]; const p=choice(pairs); const opts=shuffle(pairs.map(x=>x[1])); return {id:"num-ic-"+p[0], type:"qcm", text:`Quelle action correspond à ${p[0]} ?`, options:opts.map(x=>({label:x})), correct:opts.indexOf(p[1]), explain:`${p[0]} = ${p[1]}.`};},
    souris(){const q=choice([{t:"Quel bouton pour ouvrir un menu contextuel ?",a:"clic droit",o:["clic gauche","clic droit","molette"]},{t:"Pour déplacer un objet, on …",a:"clique et on glisse",o:["double-clique","clique et on glisse","appuie sur Échap"]},{t:"La touche pour effacer un caractère à gauche est …",a:"Retour arrière (Backspace)",o:["Entrée","Retour arrière (Backspace)","Majuscule"]}]); const arr=shuffle(q.o); return {id:"num-souris-"+q.t,type:"qcm",text:q.t,options:arr.map(x=>({label:x})),correct:arr.indexOf(q.a), explain:`Réponse : ${q.a}.`};},
    securite(){const q=choice([{t:"Tu donnes ton mot de passe à ton ami.",a:false,exp:"Ne jamais partager son mot de passe."},{t:"Tu demandes à un adulte avant de cliquer sur un lien étrange.",a:true,exp:"Toujours demander de l’aide."}]); return {id:"num-sec-"+q.t,type:"qcm",text:`Vrai ou faux : ${q.t}`,options:[{label:"Vrai"},{label:"Faux"}],correct:q.a?0:1, explain:q.exp};}
  };

  // LOGIQUE
  const LOG={
    paires(){const em=["🍎","🍌","🍇","🍓","🍑","🍐"]; const deck=shuffle(em.concat(em)).map((e,i)=>({e,v:e+"-"+i})); return {id:"log-memo", type:"memory", text:"Retourne les cartes et trouve les paires.", deck, pairs:em.length};},
    sudoku(){const p=choice([{g:[1,0,0,4, 0,0,2,0, 0,2,0,0, 3,0,0,1]},{g:[0,0,2,1, 1,0,0,0, 0,1,0,0, 4,0,1,0]}]);
      return {id:"log-sudoku-"+p.g.join(""), type:"sudoku", grid:p.g, check(vals){
        if(vals.length!==16 || vals.some(v=>v<1||v>4)) return false;
        const okRow=r=> new Set(vals.slice(r*4,(r+1)*4)).size===4;
        const okCol=c=> new Set([vals[c],vals[c+4],vals[c+8],vals[c+12]]).size===4;
        const blk=(r,c)=>{const idx=[r*8+c*2, r*8+c*2+1, r*8+c*2+4, r*8+c*2+5].map(i=>[Math.floor(i/4), i%4]).map(([R,C])=>vals[R*4+C]); return new Set(idx).size===4;};
        for(let i=0;i<4;i++){ if(!okRow(i)||!okCol(i)) return false; }
        for(let r=0;r<2;r++) for(let c=0;c<2;c++) if(!blk(r,c)) return false;
        return true;
      }};
    },
    patterns(){
      const s=choice([{arr:["🔴","🔵","🔴","🔵","?"], a:"🔴", opts:["🔴","🟢","🟡"], exp:"Répétition rouge/bleu."},{arr:["1","2","3","?","5"], a:"4", opts:["4","6","2"], exp:"Suite 1 à 5."},{arr:["🐶","🐱","🐶","?","🐶"], a:"🐱", opts:["🐱","🐭","🐸"], exp:"Un chien sur deux."}]);
      const opt=shuffle(s.opts); return {id:"log-pat-"+s.arr.join(""), type:"qcm", text:`Complète la séquence : ${s.arr.join(" ")}`, options:opt.map(x=>({label:x})), correct:opt.indexOf(s.a), explain:s.exp};
    }
  };

  function makeQuestion(area,sub){
    switch(area){
      case "fr": return FR[sub]();
      case "math": return MATH[sub](state.level);
      case "sciences": return SCI[sub]();
      case "arts": return ARTS[sub]();
      case "num": return NUM[sub]();
      case "logique": return LOG[sub]();
      default: return FR.vocab();
    }
  }

  /* ----------- init ----------- */
  load();
  // aplicar tema/party guardados
  if(state.theme==="dark") document.documentElement.setAttribute("data-theme","dark");
  document.documentElement.setAttribute("data-party", state.party?"on":"off");

  renderMenu(); refreshHUD(); showHome();

  if(!state.user?.name || state.user.name==="Invité"){
    showModal("Bienvenue !", `
      <p>Comment t’appelles-tu ?</p>
      <div><input id="nameInput2" placeholder="Ton prénom" style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd"></div>
    `, ()=>{
      $("#nameInput2").focus();
      $("#modalClose").onclick=()=>{
        const n=$("#nameInput2").value.trim()||"Invité";
        state.user.name=n; $("#avatarName").textContent=n; save(); hideModal();
      };
    });
  } else { $("#avatarName").textContent = state.user.name; }

})();
</script>
</body>
</html>