<!doctype html>
<html lang="fr" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Appli de Léna — 2e primaire (édition magique)</title>
    <meta name="theme-color" content="#b06fff">
    <meta name="color-scheme" content="light dark">

    <!-- Fonts para look infantil moderno -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800;900&family=Fredoka:wght@600;800&display=swap" rel="stylesheet">

    <style>
      :root{
        /* Pastel multicolor (clair) */
        --bg-1:#fdf2ff; --bg-2:#fae8ff; --bg-3:#e9d5ff; --fg:#2d2252;
        --card:rgba(255,255,255,.94); --muted:#6b5b7a; --ring:#ff9bd6;
        --good:#22c55e; --bad:#ef4444;
        --lila:#b06fff; --rose:#ff8dc7; --menta:#7be0e6; --miel:#ffd27e;
        --icon-size:36px;
        --shadow:0 12px 28px rgba(176,111,255,.18);
        --radius:22px;
        --bg-speed: 26s;
      }
      /* Tema oscuro (toggle + media) */
      @media (prefers-color-scheme: dark){
        :root{
          --bg-1:#100d18; --bg-2:#151126; --bg-3:#1b1632; --fg:#efe8ff;
          --card:rgba(255,255,255,.08); --muted:#cdbef0; --ring:#ffbde0;
          --shadow:0 10px 28px rgba(0,0,0,.45);
        }
      }
      html[data-theme="dark"]{
        --bg-1:#0f0c17; --bg-2:#171327; --bg-3:#201a3a; --fg:#efe8ff;
        --card:rgba(255,255,255,.08); --muted:#cdbef0; --ring:#ffbde0;
        --shadow:0 10px 28px rgba(0,0,0,.5);
      }
      /* Modo Fête (saturación y velocidad) */
      html[data-party="on"]{
        --bg-speed: 14s;
        filter: saturate(1.15);
      }

      *{box-sizing:border-box}
      html,body,#root{height:100%}
      body{
        margin:0;
        font-family:"Nunito", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
        color:var(--fg);
        -webkit-font-smoothing:antialiased;
        background:linear-gradient(135deg,var(--bg-1),var(--bg-2),var(--bg-3));
        background-size:200% 200%;
        animation:bg-pan var(--bg-speed) linear infinite;
      }
      @keyframes bg-pan{
        0%{background-position:0% 50%}
        50%{background-position:100% 50%}
        100%{background-position:0% 50%}
      }

      /* Layout */
      .container{max-width:1100px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
      .container.full{max-width:100%;width:100%}
      .header{
        display:flex;align-items:center;justify-content:space-between;
        padding:14px 16px;margin:12px;border-radius:24px;
        background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.65));
        box-shadow: var(--shadow);
        backdrop-filter:saturate(1.2) blur(6px);
      }
      .brand{display:flex;align-items:center;gap:10px}
      .brand .title{
        font-family:"Fredoka", system-ui;
        font-weight:900;font-size:22px;
        background:linear-gradient(90deg,#ec4899,#f59e0b,#10b981,#3b82f6,#8b5cf6);
        -webkit-background-clip:text;background-clip:text;color:transparent;
        letter-spacing:.2px
      }
      .brand-badge{
        width:42px;height:42px;border-radius:12px;display:grid;place-items:center;
        background: conic-gradient(from 140deg, var(--lila), var(--rose), var(--miel), var(--menta), var(--lila));
        box-shadow: var(--shadow);
        animation: spinBadge 8s linear infinite;
      }
      @keyframes spinBadge{to{transform:rotate(1turn)}}

      .stage{flex:1;display:flex;align-items:center;justify-content:center;padding:12px}
      .stage.home{align-items:stretch}
      .stage.center .card{max-width:900px;width:100%}
      .stage.full .card{width:min(1200px,100%)}

      /* UI base */
      .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
      .caption{color:var(--muted);font-size:12px}
      .bill-purse{display:flex;align-items:center;gap:6px;font-weight:800}

      .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
      .grid{display:grid;gap:14px}
      @media (min-width:640px){.grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr));}}
      @media (max-width:639.98px){.grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr));}}

      .icon-btn{
        position:relative;border:1px solid transparent;
        background:linear-gradient(#fff,#fff) padding-box,
          linear-gradient(135deg,#ec4899,#f59e0b,#10b981,#3b82f6,#8b5cf6) border-box;
        background-size:100% 100%,300% 300%;
        animation:rainbow 8s linear infinite;
        border-radius:22px;padding:18px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;
        text-align:center;min-height:140px;box-shadow:0 6px 14px rgba(0,0,0,.06);
        transition:transform .12s ease, box-shadow .12s ease;cursor:pointer;color:var(--fg)
      }
      @keyframes rainbow{0%{background-position:0% 0%,0% 0%}100%{background-position:0% 0%,300% 300%}}
      .icon-emoji{font-size:36px}
      .icon-label{font-weight:900;font-size:16px;font-family:"Fredoka"}
      .icon-desc{font-size:12px;color:var(--muted)}
      .icon-btn:hover{transform:translateY(-4px);box-shadow:0 14px 30px rgba(0,0,0,.12)}
      .icon-btn .icon-emoji{position:relative}
      .icon-btn .icon-emoji::after{content:'';position:absolute;inset:-10px;background:radial-gradient(closest-side,rgba(236,72,153,.25),transparent);filter:blur(6px);border-radius:50%;z-index:-1}

      .back{
        border:none;background:#fff;border-radius:14px;padding:10px 12px;
        box-shadow:0 6px 16px rgba(0,0,0,.06);
        display:inline-flex;align-items:center;gap:8px;cursor:pointer
      }
      .back.back-lg{padding:12px 16px;font-size:16px;border-radius:16px}
      .back:hover{transform:translateY(-1px)}
      .back:focus-visible{outline:3px solid var(--ring);outline-offset:2px}
      .back::after{content:'';position:absolute;inset:0;opacity:0;background:radial-gradient(120px 40px at var(--x,50%) 120%, rgba(236,72,153,.15), transparent);transition:opacity .2s}
      .back:hover::after{opacity:1}

      .progress{height:8px;border-radius:999px;background:linear-gradient(90deg, rgba(167,139,250,.25), rgba(236,72,153,.25));overflow:hidden}
      .progress > span{display:block;height:100%;background:linear-gradient(90deg,#a78bfa,#ec4899,#f59e0b);transition:width .2s}

      /* Options / MCQ */
      .opt{
        position:relative;border:1px solid rgba(167,139,250,.25);
        background:linear-gradient(180deg,#fff,#fdf2f8);
        border-radius:16px;padding:14px 16px;min-height:96px;display:flex;align-items:center;justify-content:center;gap:8px;
        box-shadow:0 10px 20px rgba(0,0,0,.06);cursor:pointer;transition:transform .08s
      }
      .opt:active{transform:scale(.98)}
      .opt .emo{font-size:26px}
      .opt .lbl{font-weight:900;font-family:"Fredoka"}
      .opt .badge{position:absolute;left:8px;top:8px;background:#a78bfa;color:#fff;border-radius:999px;width:24px;height:24px;font-size:12px;display:flex;align-items:center;justify-content:center;font-weight:900}
      .opt.pop{animation:popbtn .22s ease}
      @keyframes popbtn{0%{transform:scale(.98)}70%{transform:scale(1.03)}100%{transform:scale(1)}}

      /* Modal */
      .modal-wrap{position:fixed;inset:0;background:rgba(15,23,42,.38);display:flex;align-items:center;justify-content:center;z-index:50;animation:fade .15s}
      .modal{background:#fff;border-radius:18px;padding:18px 18px;min-width:260px;max-width:92vw;text-align:center;box-shadow:0 24px 60px rgba(0,0,0,.25);animation:pop .2s}
      .modal h3{margin:8px 0 6px;font-size:18px;font-weight:900;font-family:"Fredoka"}
      .modal .big{font-size:56px}
      .modal .actions{margin-top:10px;display:flex;gap:8px;justify-content:center}
      @keyframes fade{from{opacity:0}to{opacity:1}} @keyframes pop{from{transform:scale(.92)}to{transform:scale(1)}}
      .modal[data-type="bad"]{animation:shake .35s ease-in-out,pop .2s}
      @keyframes shake{10%{transform:translateX(-4px)}20%{transform:translateX(4px)}30%{transform:translateX(-3px)}40%{transform:translateX(3px)}60%{transform:translateX(2px)}100%{transform:translateX(0)}}

      /* Mascotte / combo */
      .mascot{position:fixed;left:16px;bottom:18px;background:#fff;border-radius:14px;padding:8px 12px;box-shadow:0 10px 24px rgba(0,0,0,.14);display:flex;align-items:center;gap:8px;font-weight:800;transform:translateY(16px);opacity:0;transition:transform .18s ease, opacity .18s ease;z-index:60}
      .mascot.show{transform:translateY(0);opacity:1}
      .combo{position:fixed;right:16px;top:16px;background:linear-gradient(90deg,#f59e0b,#ec4899);color:#fff;border-radius:999px;padding:8px 12px;font-weight:900;box-shadow:0 12px 28px rgba(0,0,0,.14);transform:translateY(-10px) scale(.95);opacity:0;transition:transform .18s ease, opacity .18s ease;z-index:60}
      .combo.show{transform:translateY(0) scale(1);opacity:1}

      /* Dots base-10 / boards / keypad */
      .ten,.unit{display:grid;grid-template-columns:repeat(10,10px);gap:6px;align-items:center}
      .unit{grid-template-columns:repeat(10,10px)}
      .dot{width:10px;height:10px;border-radius:50%;background:#8b5cf6;box-shadow:0 1px 0 rgba(0,0,0,.08)}
      .money{display:inline-block;margin:2px;font-size:22px;animation:jump .3s ease-in-out}
      @keyframes jump{0%{transform:translateY(6px)}50%{transform:translateY(-2px)}100%{transform:translateY(0)}}

      .number-line{display:none} /* UPDATE: ocultamos estilos innecesarios tras eliminar la Droite numérique */

      .board{display:grid;gap:8px}
      .board.cols-4{grid-template-columns:repeat(4,60px)}
      .tile{width:60px;height:60px;border-radius:12px;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;box-shadow:0 8px 18px rgba(0,0,0,.08);cursor:pointer}
      .tile.fixed{background:#f3f4f6;color:#6b7280;cursor:default}
      .tile.sel{outline:3px solid var(--ring)}
      .tile.err{background:#fee2e2}

      .card-wrap{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
      .card-flip{position:relative;height:110px;border-radius:14px;perspective:600px}
      .face{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;border-radius:14px;background:#fff;box-shadow:0 8px 18px rgba(0,0,0,.08);backface-visibility:hidden;transition:transform .25s}
      .backface{transform:rotateY(180deg)}
      .is-open .front{transform:rotateY(180deg)}
      .is-open .backface{transform:rotateY(0)}

      .keypad{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
      .key{min-width:44px;height:44px;border-radius:10px;border:none;background:#fff;box-shadow:0 6px 14px rgba(0,0,0,.06);font-weight:900;cursor:pointer}

      /* “Brillitos” al clic */
      .sparkle{
        position:fixed; pointer-events:none; width:12px;height:12px; transform: translate(-50%,-50%) scale(.6);
        background: conic-gradient(from 0deg, var(--lila), var(--rose), var(--miel), var(--menta), var(--lila));
        clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
        opacity:.9; filter: drop-shadow(0 6px 12px rgba(176,111,255,.35));
        animation: pop .8s ease-out forwards;
      }
      @keyframes pop{
        0%{opacity:0; transform: translate(-50%,-50%) scale(.4) rotate(0deg)}
        50%{opacity:1}
        100%{opacity:0; transform: translate(-50%,-80%) scale(1.6) rotate(40deg)}
      }

      /* Accesibilidad: reducir movimiento */
      @media (prefers-reduced-motion: reduce){
        .brand-badge{animation:none}
        .icon-btn{animation:none}
        .card-flip .face{transition:none}
        body{animation:none}
        .sparkle{animation-duration:.2s}
      }

      /* Scrollbar cute */
      ::-webkit-scrollbar{height:10px;width:10px}
      ::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#a78bfa,#ec4899);border-radius:999px}

      /* UPDATE: Pregunta grande centrada + Retour unicornio grande + loaders + micro-animaciones y táctil ≥44px */
      .question{font-family:"Fredoka",system-ui;font-weight:900;font-size:clamp(28px,4vw,32px);text-align:center;line-height:1.2;margin:10px 0}
      .back.back-retour{display:inline-flex;align-items:center;gap:10px}
      .back.back-retour .uni{font-size:48px;line-height:1}

      .skel{position:relative;overflow:hidden;background:rgba(255,255,255,.55);border-radius:12px;min-height:80px}
      .skel::after{content:"";position:absolute;inset:0;transform:translateX(-100%);
        background:linear-gradient(90deg,transparent,rgba(255,255,255,.6),transparent);
        animation:skel 1.2s infinite}
      @keyframes skel{to{transform:translateX(100%)}}

      .icon-btn,.opt,.back,.card{transition-duration:160ms} /* 120–200ms */
      .key,.opt,.icon-btn,.back{min-height:44px;min-width:44px}
    </style>
  </head>
  <body>
    <noscript>Active JavaScript pour utiliser l’application.</noscript>

    <!-- Sprite de icônes SVG (magia) -->
    <svg width="0" height="0" aria-hidden="true" focusable="false" style="position:absolute">
      <defs>
        <linearGradient id="grad-sugar" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0" stop-color="#ff8dc7"/><stop offset="1" stop-color="#b06fff"/>
        </linearGradient>
        <symbol id="ico-star" viewBox="0 0 64 64">
          <path fill="url(#grad-sugar)" d="M32 6l7.6 15.6 17.2 2.5-12.4 12.1 2.9 17-15.3-8-15.3 8 2.9-17L7.2 24.1l17.2-2.5L32 6z"/>
        </symbol>
      </defs>
    </svg>

    <div id="root"></div>

    <!-- React 18 + Babel (modo sencillo para probar) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      // UPDATE: QA MANUAL
      // 1) Mathématiques → probar 5 modos con 10 niveles; +/− con llevadas/préstamos.
      // 2) Mémoire → 2×3, 4×4, 4×5; modos ii/wi/ww; ⏱️ y 🔢 opcionales; sin repetición en sesión.
      // 3) Équations → niveles 1–5 suma/resta; 6–10 mult/div; modal con explicación.
      // 4) Contes → lectura centrada + botón “Leer” si TTS.
      // 5) Sudoku → 4×4/6×6/9×9; “💡 Pista”; solución única; ruta ‘sudoku4’ intacta.
      // 6) Droite numérique eliminada (tarjeta y ruta).
      // 7) Accesibilidad táctil ≥44px; animaciones 160ms; skeleton en Memory.

      const { useState, useMemo, useEffect, useRef } = React;

      /* ===================== Utils ===================== */
      const r = (min,max)=> Math.floor(Math.random()*(max-min+1))+min;
      const shuffle = (a)=>{const b=[...a]; for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [b[i],b[j]]=[b[j],b[i]];} return b;};
      const takeN = (arr,n)=> shuffle(arr).slice(0,Math.min(n,arr.length));
      const makeChoices=(correct)=>{const s=new Set([correct]); while(s.size<4){const d=Math.max(1,Math.round(Math.abs(correct)*0.2)+1); s.add(correct + (Math.random()<.5?-1:1)*r(1,d));} return shuffle([...s]).slice(0,4)};

      // Normalización de respuestas (tolerante)
      const stripDiacritics = (s) => Array.from(String(s||'').normalize('NFD')).filter(ch => { const c=ch.charCodeAt(0); return !(c>=0x0300 && c<=0x036F); }).join('');
      const collapseSpaces = (s) => s.trim().replace(/ +/g,' ');
      const norm = (x) => collapseSpaces(stripDiacritics(String(x==null?'':x)).toLowerCase());
      const eqAns = (a,b)=>{ const na=Number(a), nb=Number(b); if(!Number.isNaN(na) && !Number.isNaN(nb)) return na===nb; return norm(a)===norm(b); };

      // Sonidos simples (sin archivos)
      const Sound = (()=>{ let ctx; const ensure=()=>{ if(!ctx){ ctx = new (window.AudioContext||window.webkitAudioContext)(); } return ctx; }
        const beep=(freq=660, dur=0.12, type='sine', when=0, gain=0.04)=>{ const c=ensure(); const o=c.createOscillator(); const g=c.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(c.destination); o.start(c.currentTime+when); o.stop(c.currentTime+when+dur); };
        const good=()=>{ beep(660,0.09,'triangle',0); beep(880,0.1,'triangle',0.08); beep(1320,0.12,'triangle',0.16); };
        const bad =()=>{ beep(220,0.14,'sawtooth',0,0.06); beep(150,0.18,'sawtooth',0.08,0.06); };
        return {good,bad}; })();

      function confettiBurst(x,y){
        const emo=['💜','💙','💚','💛','🦄','✨'];
        for(let i=0;i<12;i++){
          const span=document.createElement('span');
          span.textContent=emo[r(0,emo.length-1)];
          span.style.position='fixed'; span.style.left=x+'px'; span.style.top=y+'px';
          span.style.pointerEvents='none'; span.style.transition='transform .8s, opacity .8s';
          document.body.appendChild(span);
          requestAnimationFrame(()=>{
            span.style.transform=`translate(${r(-120,120)}px, ${r(-120,120)}px) rotate(${r(-180,180)}deg)`; span.style.opacity='0';
          });
          setTimeout(()=> span.remove(), 900);
        }
      }

      // Rastro de brillitos (desktop)
      ;(()=>{try{
        if(!window.matchMedia('(pointer:fine)').matches) return;
        let last=0;
        document.addEventListener('pointermove',e=>{
          const now=performance.now(); if(now-last<60) return; last=now;
          const s=document.createElement('span');
          s.textContent=['✨','💖','🌈'][Math.floor(Math.random()*3)];
          s.style.position='fixed'; s.style.left=(e.clientX-6)+'px'; s.style.top=(e.clientY-6)+'px';
          s.style.fontSize='14px'; s.style.pointerEvents='none'; s.style.transition='transform .7s, opacity .7s';
          document.body.appendChild(s);
          requestAnimationFrame(()=>{ s.style.transform='translateY(-14px) scale(1.1)'; s.style.opacity='0';});
          setTimeout(()=>s.remove(),800);
        });
      }catch(_){} })();

      // Brillitos al click
      function sparkleAt(x, y, count = 3){
        for(let i=0;i<count;i++){
          const s = document.createElement('div');
          s.className = 'sparkle';
          const dx = (Math.random() - .5) * 80;
          const dy = (Math.random() - .5) * 80;
          s.style.left = (x + dx) + 'px';
          s.style.top  = (y + dy) + 'px';
          s.style.transform += ` rotate(${Math.random()*90-45}deg)`;
          document.body.appendChild(s);
          setTimeout(()=> s.remove(), 900);
        }
      }
      window.addEventListener('pointerdown', (e) => sparkleAt(e.clientX, e.clientY, 6));

      /* ===================== SIN REPETICIÓN POR PARTIDA ===================== */
      // UPDATE: usedIds + resetSession + pickUnique
      const usedIds = new Set();
      function resetSession(){ usedIds.clear(); }
      function pickUnique(pool, count, idOf = (it)=> it.id ?? it.prompt ?? JSON.stringify(it)){
        const out=[]; const seen=new Set();
        for(const item of shuffle(pool)){
          const id=idOf(item);
          if(!usedIds.has(id) && !seen.has(id)){
            seen.add(id); usedIds.add(id); out.push(item);
            if(out.length>=count) break;
          }
        }
        while(out.length < Math.min(count, pool.length)){
          const it = pool[out.length]; const id=idOf(it);
          if(!seen.has(id)){ seen.add(id); out.push(it); } else break;
        }
        return out;
      }

      /* ===================== UI bits ===================== */
      const Progress=({current,total})=> (
        <div className="progress" aria-label="progression">
          <span style={{width:`${(current)/(Math.max(total-1,1))*100}%`}}/>
        </div>
      );
      const LevelPill=({children,onClick})=> (
        <button className="back" onClick={onClick} style={{background:'#ec4899',color:'#fff',position:'relative'}}>{children}</button>
      );
      const OptionButton=({index,emoji,label,onClick})=>{
        const handle=(e)=>{ e.currentTarget.classList.add('pop'); setTimeout(()=> e.currentTarget.classList.remove('pop'), 220); onClick(e); };
        return (
          <button className="opt" onClick={handle} aria-label={label}>
            <span className="badge">{String.fromCharCode(65+index)}</span>
            {emoji ? <span className="emo">{emoji}</span> : null}
            <span className="lbl">{label}</span>
          </button>
        );
      };
      const Modal=({open,type='info',title,children,actions=[],onClose})=> open? (
        <div className="modal-wrap" onClick={onClose}>
          <div className="modal" role="dialog" aria-modal="true" data-type={type} onClick={e=>e.stopPropagation()}>
            <div className="big">{type==='bad'? '🦄😢':'🎉'}</div>
            <h3>{title}</h3>
            <div>{children}</div>
            <div className="actions">
              {actions.length? actions.map((a,i)=> (
                <button key={i} className="back" onClick={a.onClick} style={a.primary?{background:'#ec4899',color:'#fff'}:null}>{a.label}</button>
              )) : <button className="back" onClick={onClose}>OK</button>}
            </div>
          </div>