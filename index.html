<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="color-scheme" content="light dark"/>
<meta name="description" content="Appli de L√©na ‚Äî activit√©s ludiques (lecture, maths, logique, arts) avec √©toiles, pi√®ces et effets magiques pour enfants."/>
<title>Appli de L√©na ‚Äî Menu magique ü¶Ñ</title>
<meta name="theme-color" content="#b06fff"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600;700;900&family=Nunito:wght@600;800&display=swap" rel="stylesheet">
<style>
:root{
  /* Paleta suavizada (m√°s pastel) */
  --bg:#f7f5ff; --bg2:#eeebff; --card:rgba(255,255,255,.95); --cardHi:rgba(255,255,255,.9);
  /* M√°s contraste en pantallas Samsung/iPad: tinta m√°s oscura y muted m√°s legible */
  --ink:#231a3d; --muted:#534a6a;
  --p1:#a78bfa; --p2:#fecdd3; --p3:#a7f3d0; --ok:#22c55e; --bad:#ef4444; --warn:#ffe7ad;
  --mint:#b9f5d0; --lila:#d9c7ff; --rose:#ffd1e8; --celeste:#cde7ff; --sun:#ffef9f;
  --radius:22px; --shadow:0 12px 28px rgba(176,111,255,.16);
  --h:66px;
  --icon-size:36px;
  --ring:#f9a8d4;
  --bg-speed:26s;
  /* Timing & easing (anim utility classes) */
  --dur-fast:140ms; --dur-base:240ms; --dur-slow:360ms;
  --ease-smooth:cubic-bezier(.2,.8,.2,1);
  /* FX: unified animation tokens (mapped to existing) */
  --fast:150ms; --base:250ms; --slow:420ms; --ease:var(--ease-smooth);
}
/* Improve touch ergonomics across devices */
button, .chip, .option, .sub { touch-action: manipulation; }
/* iOS tap highlight reduce */
*{ -webkit-tap-highlight-color: rgba(0,0,0,0.06); }
/* Skip link (accessibility) */
.skip-link{position:absolute; left:8px; top:-48px; background:var(--card); color:var(--ink); border:1px solid rgba(167,139,250,.35); border-radius:999px; padding:8px 12px; box-shadow:0 6px 16px rgba(0,0,0,.06); font-weight:900; z-index:9999; transition: top .2s}
.skip-link:focus{top:8px}
/* Tema oscuro */
@media (prefers-color-scheme: dark){
  :root{ --bg:#100d18; --bg2:#1b1632; --card:rgba(255,255,255,.08); --cardHi:rgba(255,255,255,.06); --ink:#efe8ff; --muted:#cdbef0; --shadow:0 10px 28px rgba(0,0,0,.45); --ring:#ffbde0; }
}
html[data-theme="dark"]{
  --bg:#0f0c17; --bg2:#201a3a; --card:rgba(255,255,255,.08); --cardHi:rgba(255,255,255,.06);
  --ink:#efe8ff; --muted:#cdbef0; --shadow:0 10px 28px rgba(0,0,0,.5); --ring:#ffbde0;
}
/* Modo fiesta */
html[data-party="on"]{ --bg-speed:14s; filter:saturate(1.15); }

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:"Nunito", ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
  -webkit-font-smoothing:antialiased;
  background:linear-gradient(135deg,var(--bg),var(--bg2),#f3e8ff);
  background-size:200% 200%; animation:bg-pan var(--bg-speed) linear infinite;
  overflow:hidden;
  /* Safe-area support for phones/tablets with notches */
  padding-top: env(safe-area-inset-top, 0px);
  padding-left: env(safe-area-inset-left, 0px);
  padding-right: env(safe-area-inset-right, 0px);
}
/* Rainbow overlay inspired by Avatar World */
body::before{
  content:""; position:fixed; inset:0; pointer-events:none; z-index:-1; opacity:.18;
  background:
    radial-gradient(800px 800px at 10% 15%, var(--rose), transparent 60%),
    radial-gradient(700px 700px at 90% 20%, var(--celeste), transparent 55%),
    radial-gradient(600px 600px at 20% 80%, var(--mint), transparent 60%),
    radial-gradient(500px 500px at 80% 85%, var(--sun), transparent 60%);
  filter:hue-rotate(0deg);
  animation: hue 16s linear infinite;
}
@keyframes hue{ to{ filter:hue-rotate(360deg); } }
@keyframes bg-pan{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

/* === Animation utility classes (reusable) === */
.fade-in{animation:fadeIn var(--dur-base) var(--ease-smooth) both}
.slide-up{animation:slideUp var(--dur-base) var(--ease-smooth) both}
.slide-left{animation:slideLeft2 var(--dur-base) var(--ease-smooth) both}
.pop{animation:popIn var(--dur-fast) var(--ease-smooth) both}
.glow{box-shadow:0 0 0 6px rgba(56,189,248,.18), 0 10px 28px rgba(56,189,248,.25) !important}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideLeft2{from{opacity:0;transform:translateX(12px)}to{opacity:1;transform:translateX(0)}}
@keyframes popIn{0%{transform:scale(.98)}70%{transform:scale(1.03)}100%{transform:scale(1)}}
/* Friendly micro-shake for wrong answers */
.shake-soft{animation:shake .35s}

/* Magical screen transitions */
.screen-enter{animation:screenIn .28s ease both}
.screen-leave{animation:screenOut .24s ease both}
@keyframes screenIn{from{opacity:0; transform:translateY(8px) scale(.98)} to{opacity:1; transform:translateY(0) scale(1)}}
@keyframes screenOut{from{opacity:1; transform:translateY(0) scale(1)} to{opacity:0; transform:translateY(-6px) scale(.98)}}

/* Cross-fade variant for view swaps (gentler) */
.xfade-enter{animation:xfIn .28s ease both}
.xfade-leave{animation:xfOut .24s ease both}
@keyframes xfIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}
@keyframes xfOut{from{opacity:1} to{opacity:0}}

/* ===== FX: Reusable visual effects toolkit ===== */
.fx-pop{ animation: fxPop var(--base) var(--ease) both }
.fx-glow{ animation: fxGlow var(--base) var(--ease) both }
.fx-shake{ animation: fxShake var(--base) ease both }
.fx-fade{ animation: fxFade var(--base) var(--ease) both }
.fx-slide-up{ animation: fxSlideUp var(--base) var(--ease) both }
.fx-slide-left{ animation: fxSlideLeft var(--base) var(--ease) both }
.missPulse{ animation: missPulse 1.8s ease-in-out infinite }
@keyframes fxPop{ 0%{ transform:scale(.9); opacity:.6 } 70%{ transform:scale(1.04); opacity:1 } 100%{ transform:scale(1) } }
@keyframes fxGlow{ 0%{ box-shadow:0 0 0 0 rgba(56,189,248,.00) } 60%{ box-shadow:0 0 0 16px rgba(56,189,248,.16) } 100%{ box-shadow:0 0 0 0 rgba(56,189,248,.00) } }
@keyframes fxShake{ 10%{ transform:translateX(-8px) } 20%{ transform:translateX(8px) } 30%{ transform:translateX(-6px) } 40%{ transform:translateX(6px) } 60%{ transform:translateX(3px) } 100%{ transform:translateX(0) } }
@keyframes fxFade{ from{ opacity:0 } to{ opacity:1 } }
@keyframes fxSlideUp{ from{ opacity:0; transform:translateY(14px) } to{ opacity:1; transform:translateY(0) } }
@keyframes fxSlideLeft{ from{ opacity:0; transform:translateX(18px) } to{ opacity:1; transform:translateX(0) } }
@keyframes missPulse{ 0%{ transform:scale(.98) } 50%{ transform:scale(1.02) } 100%{ transform:scale(.98) } }

/* ===== Header pill bar (glass + rainbow) ===== */
header{height:var(--h); display:flex; align-items:center; justify-content:center; padding:10px}
#bar{
  width:min(1600px, 98vw); height:100%; padding:0 14px; display:flex; align-items:center; justify-content:space-between; gap:10px;
  border-radius:24px; background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.86));
  box-shadow:var(--shadow); backdrop-filter:saturate(1.3) blur(8px);
  overflow-x:auto; scroll-snap-type:x proximity;
  padding-left: calc(14px + env(safe-area-inset-left, 0px));
  padding-right: calc(14px + env(safe-area-inset-right, 0px));
}
#brand{display:flex; align-items:center; gap:12px}
#brand .logo{
  width:40px;height:40px;border-radius:12px;display:grid;place-items:center;
  background: conic-gradient(from 140deg, var(--p1), var(--p2), var(--warn), var(--p3), var(--p1));
  box-shadow: var(--shadow); animation:spinBadge 8s linear infinite;
  position:relative; overflow:hidden;
}
#brand .logo::after{content:"ü¶Ñ";font-size:26px; filter:drop-shadow(0 2px 4px rgba(0,0,0,.12))}
@keyframes spinBadge{to{transform:rotate(1turn)}}
#brand .title{line-height:1}
#brand .title .t1{font-size:13px}
#brand .title .t2{
  font-size:18px; font-weight:900; font-family:"Fredoka";
  background: linear-gradient(90deg,#ec4899,#f59e0b,#10b981,#3b82f6,#8b5cf6);
  -webkit-background-clip:text; background-clip:text; color:transparent; letter-spacing:.2px;
  text-shadow: 0 2px 8px rgba(176,111,255,.08);
}
#controls{display:flex;align-items:center;gap:8px;flex-wrap:nowrap}
/* Sombra ligeramente m√°s marcada para iconos del header */
#controls .chip{ text-shadow: 0 2px 4px rgba(0,0,0,.10); }
.chip{
  border:1px solid transparent;
  background: linear-gradient(#fff,#fff) padding-box,
             linear-gradient(135deg,#f0abfc,#fde68a,#a7f3d0,#bfdbfe,#c4b5fd) border-box;
  background-size:100% 100%,240% 240%; animation: rainbow 12s linear infinite;
  color:#1f213a; border-radius:18px; padding:6px 10px; font-weight:800; display:inline-flex; align-items:center; gap:6px; cursor:pointer; user-select:none; font-size:14px;
  box-shadow:0 6px 14px rgba(0,0,0,.06), inset 0 1px 0 rgba(255,255,255,.6);
}
@keyframes rainbow{0%{background-position:0% 0%,0% 0%}100%{background-position:0% 0%,300% 300%}}
.chip.ghost{background:var(--card); color:var(--ink); border:1px solid rgba(167,139,250,.25)}
.chip.badge{background:var(--card); color:var(--muted); border:1px solid rgba(167,139,250,.25)}
#coinChip{border:2px dashed var(--ring); background:#fff; color:#111}

/* ===== Layout ===== */
main{position:absolute; inset:var(--h) 0 0 0; display:grid; grid-template-rows: 1fr}
#home{overflow:auto; padding:24px}
#homeInner{width:min(1600px, 98vw); margin:0 auto}
#grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:16px; margin-top:14px; align-items:stretch}
@media (max-width: 980px){ #grid{grid-template-columns:repeat(auto-fit, minmax(200px,1fr))} }
@media (max-width: 640px){ #grid{grid-template-columns:repeat(auto-fit, minmax(180px,1fr))} }

/* ===== Menu cards ===== */
.card{
  position:relative; overflow:hidden;
  border:1px solid transparent;
  background: linear-gradient(var(--card), var(--card)) padding-box,
             linear-gradient(135deg,rgba(254,205,211,.9),rgba(255,231,173,.9),rgba(167,243,208,.9),rgba(191,219,254,.9),rgba(196,181,253,.9)) border-box;
  background-size:100% 100%,240% 240%; animation: rainbow 12s linear infinite;
  border-radius: var(--radius); padding:18px; box-shadow:0 16px 34px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.6);
  transition: transform .12s, box-shadow .12s, filter .12s, opacity .2s;
  display:flex; flex-direction:column; gap:10px;
  height:100%; min-height:240px;
}
.card:hover{ transform: translateY(-4px) scale(1.02); box-shadow:0 14px 30px rgba(0,0,0,.14); filter:saturate(1.05) }
/* Cards reveal: slide-up + fade-in */
.card{ opacity:1; }
.card.reveal{ animation:cardIn .45s ease both; }
@keyframes cardIn{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
.cardHeader{display:flex; gap:12px; align-items:center}
.icon{
  --halo: radial-gradient(closest-side, rgba(236,72,153,.22), transparent);
  width:46px;height:46px;border-radius:14px; display:grid;place-items:center; font-size:24px;
  background:#fff; color:#111; border:1px solid rgba(167,139,250,.25);
  box-shadow:0 6px 16px rgba(0,0,0,.10), 0 0 0 10px rgba(236,72,153,.06);
  position:relative; isolation:isolate; animation:float 4.5s ease-in-out infinite;
}
.icon::before{
  content:""; position:absolute; inset:-12px; z-index:-1; border-radius:20px; background:var(--halo); filter:blur(8px);
}
@keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
@keyframes text-rainbow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.ctitle{font-weight:900; font-size:19px; font-family:"Fredoka"; letter-spacing:.2px;
  background:linear-gradient(90deg,#ec4899,#f59e0b,#10b981,#3b82f6,#8b5cf6,#ec4899);
  background-size:300% 100%; -webkit-background-clip:text; background-clip:text; color:transparent;
  animation:text-rainbow 8s linear infinite;
}
.csub{font-size:12px; color:var(--muted); background:linear-gradient(90deg,#a78bfa,#fca5a5,#fcd34d,#86efac,#93c5fd,#a78bfa); background-size:300% 100%; -webkit-background-clip:text; background-clip:text; color:transparent; animation:text-rainbow 12s linear infinite}
.badge{
  position:absolute; top:10px; right:10px; display:flex; gap:6px; align-items:center;
  background:#fff; color:#6b6b8f; border:1px solid rgba(167,139,250,.25);
  border-radius:999px; padding:4px 8px; font-size:12px; font-weight:900; box-shadow:0 2px 8px rgba(0,0,0,.06)
}
.badge .stars{display:flex; gap:2px; align-items:center}
.stars .s{font-size:14px; filter: drop-shadow(0 2px 4px rgba(0,0,0,.08))}
.stars .off{opacity:.35}

.card .bar{height:6px; width:36%; border-radius:6px; background:linear-gradient(90deg,var(--p1),var(--p2),var(--p3))}
.subs{display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:8px; margin-top:auto}
.sub{
  border:1px solid transparent; position:relative; overflow:hidden;
  background: linear-gradient(#fff,#fff) padding-box,
             linear-gradient(135deg,rgba(254,205,211,.9),rgba(255,231,173,.9),rgba(167,243,208,.9),rgba(191,219,254,.9),rgba(196,181,253,.9)) border-box;
  background-size:100% 100%,240% 240%; animation: rainbow 12s linear infinite;
  color:transparent; border-radius:14px; padding:12px 14px; font-weight:900; cursor:pointer; text-align:center;
  box-shadow:0 6px 14px rgba(0,0,0,.06); transition: transform .08s;
  display:flex; align-items:center; justify-content:center;
  min-height:52px; font-size:clamp(14px, 1.1vw + 10px, 18px);
}
.sub > span{ background:linear-gradient(90deg,#ec4899,#f59e0b,#10b981,#3b82f6,#8b5cf6,#ec4899); background-size:300% 100%; -webkit-background-clip:text; background-clip:text; color:transparent; animation:text-rainbow 10s linear infinite }
.sub .stars{position:absolute; left:8px; top:6px; font-size:10px}
.sub:hover{ transform: translateY(-2px) scale(1.02); }
.card.collapsed .subs{display:none}

/* ===== Stage ===== */
#stage{display:none; grid-template-rows:auto 8px 1fr auto; height:100%;}
#stageTop{
  display:flex; align-items:center; justify-content:space-between; padding:12px 16px;
  background: var(--card); color: var(--ink);
  border-bottom:1px solid rgba(167,139,250,.25); box-shadow:0 6px 16px rgba(0,0,0,.06);
}
#breadcrumbs{font-weight:900}
#progress{height:8px; background: linear-gradient(90deg, rgba(167,139,250,.25), rgba(236,72,153,.25)); border-top:1px solid rgba(167,139,250,.25); overflow:hidden}
#barProg{height:100%; width:0%; background: linear-gradient(90deg, var(--p1), var(--p2), var(--warn)); transition: width .35s cubic-bezier(0.22, 1, 0.36, 1)}
#content{padding:16px; overflow:auto; position:relative}
.prompt{font-size:clamp(22px, 2.2vw + 14px, 34px); font-weight:900; line-height:1.25; display:flex; align-items:center; gap:10px}
.spark{font-size:24px}
.small{font-size:13px; color:var(--muted)}
.ok{color:var(--ok)} .bad{color:var(--bad)}

/* ===== MCQ Options ===== */
.options{display:grid; grid-template-columns:repeat(2,minmax(200px,1fr)); gap:12px; margin-top:14px}
@media (max-width:720px){.options{grid-template-columns:1fr}}
.option{
  position:relative; border:1px solid rgba(167,139,250,.25);
  background: linear-gradient(180deg,#fff,#fdf2f8); color:#1f213a;
  border-radius:16px; padding:18px; min-height:88px; display:flex; align-items:center; justify-content:center; gap:8px;
  box-shadow:0 10px 20px rgba(0,0,0,.06); cursor:pointer; transition:transform .08s, box-shadow .16s;
  font-size:clamp(16px, 1.2vw + 10px, 22px); font-weight:900; font-family:"Fredoka", system-ui;
}
.option:hover{ transform:translateY(-2px) scale(1.02); box-shadow:0 16px 28px rgba(0,0,0,.10) }
.option:active{transform:scale(.98)}
.option.correct{outline:3px solid var(--ok); outline-offset: 2px; animation:popbtn .22s ease; box-shadow: 0 0 0 6px rgba(34,197,94,.18), 0 8px 24px rgba(16,185,129,.25)}
.option.wrong{outline:3px solid var(--bad); outline-offset: 2px; animation:shake .35s}
@keyframes popbtn{0%{transform:scale(.98)}70%{transform:scale(1.03)}100%{transform:scale(1)}}
@keyframes shake{10%{transform:translateX(-4px)}20%{transform:translateX(4px)}30%{transform:translateX(-3px)}40%{transform:translateX(3px)}60%{transform:translateX(2px)}100%{transform:translateX(0)}}
.optColor{width:24px;height:24px;border-radius:8px;border:2px solid #0001;display:inline-block;margin-right:8px;vertical-align:-5px}

/* Inputs / ordenaci√≥n */
.answerBox{display:flex; gap:8px; align-items:center; margin-top:12px}
.answerBox input, textarea{width:100%; padding:14px 16px; border-radius:16px; border:2px solid rgba(167,139,250,.25); background:#fff; color:#111; font-size:clamp(18px, 1.4vw + 10px, 24px)}
.chips{display:flex; gap:8px; flex-wrap:wrap}
.draggable{user-select:none;background:#fff;border:2px dashed rgba(167,139,250,.45);padding:10px 12px;border-radius:12px;cursor:grab;box-shadow:0 6px 14px rgba(0,0,0,.06)}
.dropzone{min-height:60px;background:#f9f9ff;border:2px dashed rgba(167,139,250,.45);border-radius:12px;padding:8px}

/* Maisons des nombres ‚Äî saisie */
.housesWrap{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:8px}
.houseCard{background:var(--card);color:var(--ink);border:1px solid rgba(167,139,250,.25);border-radius:16px;padding:12px;box-shadow:0 10px 20px rgba(0,0,0,.06)}
.houseHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.roofTag{background:linear-gradient(90deg,var(--p1),var(--p2));color:#fff;border-radius:999px;padding:6px 10px;font-weight:900;box-shadow:0 6px 14px rgba(0,0,0,.12)}
.floorRow{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0}
.floorRow input{width:100%;padding:12px 14px;border-radius:12px;border:2px solid rgba(167,139,250,.25);background:#fff;color:#111;font-size:20px;text-align:center}
.floorRow.ok input{border-color:var(--ok);outline:3px solid rgba(34,197,94,.25);outline-offset:1px}
.floorRow.err input{border-color:var(--bad)}
.hint{font-size:12px;color:var(--muted);margin-top:4px;min-height:16px}

/* Memory flip */
.memoryGrid{display:grid; grid-template-columns:repeat(4,minmax(60px,1fr)); gap:10px; margin-top:12px}
.cardMem{height:110px; position:relative; border-radius:14px; cursor:pointer; perspective:600px}
.cardMem .front,.cardMem .back{
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center; border-radius:14px; backface-visibility:hidden;
  background:#fff; color:#111; box-shadow:0 8px 18px rgba(0,0,0,.08); transition:transform .25s
}
.cardMem .back{ transform:rotateY(180deg); }
.cardMem.flipped .front{ transform:rotateY(180deg); }
.cardMem.flipped .back{ transform:rotateY(0deg); }
.pairGood{outline:4px solid var(--ok)}

/* Sudoku */
.sudoku{display:grid; grid-template-columns:repeat(4,60px); gap:8px; margin-top:10px}
.sudoku input{width:60px;height:60px;text-align:center;font-weight:900;font-size:20px;border-radius:12px;border:1px solid rgba(167,139,250,.35); background:#fff; color:#111; box-shadow:0 8px 18px rgba(0,0,0,.08)}
.fixed{background:#f3f4f6 !important; color:#6b7280}

/* Footer/Buttons */
#stageBottom{padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:10px; background: var(--card); color: var(--ink); border-top:1px solid rgba(167,139,250,.25); padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px))}
.btn{appearance:none;border:1px solid transparent;border-radius:16px;padding:clamp(12px,1.2vw+8px,18px) clamp(16px,1.6vw+10px,24px);font-weight:900;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.06); font-size:clamp(16px,1.2vw+10px,22px); min-height:44px; min-width:44px}
.btn:hover,
.btn:focus-visible{transform:translateY(-2px) scale(1.05); transition:transform .14s; box-shadow:0 18px 34px rgba(176,111,255,.20)}
.btn:active{ transform:scale(.98) }
.btn.p{background:linear-gradient(90deg,var(--p1),var(--p2)); color:#fff}
.btn.g{background:#fff;color:#1f213a;border:1px solid rgba(167,139,250,.25)}
.btn.s{background:linear-gradient(90deg,var(--ok),#34d399); color:#021}
.btn.d{background:linear-gradient(90deg,var(--bad),#f97393); color:#fff}
/* Bigger back button */
#btnPrev{font-size:clamp(18px,1.6vw+10px,24px); padding:clamp(14px,1.6vw+10px,22px) clamp(18px,1.8vw+12px,28px);}

/* Magical animated buttons */
.btn.magic{
  border-radius:24px;
  font-size:clamp(18px,1.8vw+10px,26px);
  padding:clamp(16px,2vw+12px,26px) clamp(22px,2.4vw+14px,36px);
  background-size:300% 300%;
  animation: rainbow 10s linear infinite;
}
.btn.magic .uni-wrap{display:inline-block; animation: walk 2s ease-in-out infinite}
@keyframes walk{0%{transform:translateY(0)}50%{transform:translateY(-3px)}100%{transform:translateY(0)}}

/* Tales */
.tale{font-size:20px; line-height:1.8; text-align:left}
.tale p{margin:10px 0}

/* Flashcards */
.cards{display:grid; grid-template-columns:repeat(2,minmax(200px,1fr)); gap:12px}
.flash{background:#fff;border:1px solid rgba(167,139,250,.25);border-radius:14px;padding:14px;position:relative;min-height:90px; box-shadow:0 10px 20px rgba(0,0,0,.06); color:#111}
.flash .q{font-weight:900}
.flash .a{position:absolute; inset:0; display:grid; place-items:center; font-weight:900; background:#0002; border-radius:14px; opacity:0; transition:opacity .2s}
.flash.show .a{opacity:1}

/* Drawing */
#drawWrap{border:1px dashed rgba(167,139,250,.35); border-radius:16px; padding:10px; display:grid; grid-template-columns:1fr 240px; gap:12px; margin-top:10px; background:var(--card)}
#canvas{background:#fff;border-radius:12px;touch-action:none;border:1px solid rgba(167,139,250,.25)}
#palette{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px}
.sw{height:48px;border-radius:10px;border:2px solid #0003}
.sw.sel{outline:3px solid rgba(0,0,0,.15)}
#thick{width:100%}
/* R√©f√©rence dessin/instructions */
#refWrap{margin-bottom:10px}
#refWrap img{max-width:100%; height:auto; display:block; border-radius:10px; border:1px solid rgba(167,139,250,.25)}
#instructions{font-size:14px; color:var(--muted); margin:8px 0 4px}

/* Modal + confetti */
#modal{position:fixed; inset:0; background:rgba(15,23,42,.38); display:none; place-items:center; z-index:60; animation:fade .15s}
#modal .box{background:#fff; color:#1f213a; border-radius:18px; width:min(720px,92vw); padding:18px; box-shadow:0 24px 60px rgba(0,0,0,.25); animation:pop .2s; text-align:center}
#modal h3{margin:8px 0 6px; font-size:18px; font-weight:900; font-family:"Fredoka", system-ui}
/* Larger, touch-friendly modal buttons */
#modal .box .btn{ font-size:clamp(18px,1.6vw+10px,24px); padding:clamp(16px,1.8vw+12px,24px) clamp(22px,2.2vw+14px,32px); border-radius:20px; }
@keyframes fade{from{opacity:0}to{opacity:1}}@keyframes pop{from{transform:scale(.92)}to{transform:scale(1)}}
#modal.closing{ animation: fadeOut .18s ease both }
@keyframes fadeOut{ to{ opacity:0 } }
#fx{position:fixed; inset:0; pointer-events:none; z-index:50}

/* Win popup (non blocking) */
#winPop{position:fixed; left:50%; top:calc(var(--h) + 56px); transform:translateX(-50%) scale(.92); background:linear-gradient(90deg,var(--p2),var(--p1)); color:#201a3a; border-radius:16px; padding:10px 14px; box-shadow:0 16px 36px rgba(0,0,0,.18); font-weight:900; z-index:65; opacity:0; animation:wpIn .22s ease forwards}
#winPop.out{animation:wpOut .22s ease forwards}
@keyframes wpIn{to{opacity:1; transform:translateX(-50%) scale(1)}}
@keyframes wpOut{to{opacity:0; transform:translateX(-50%) translateY(-6px) scale(.98)}}

/* Floating stickers */
.sticker{position:fixed; z-index:1; font-size:22px; opacity:.25; filter:drop-shadow(0 2px 4px rgba(0,0,0,.1)); pointer-events:none; animation:floatY 6s ease-in-out infinite}
/* Twinkle effect for stars */
.sticker.tw{ animation: floatY 6s ease-in-out infinite, twinkle 2.4s ease-in-out infinite; }
@keyframes twinkle{ 0%,100%{ filter:drop-shadow(0 0 0 rgba(255,255,255,0)); opacity:.22 } 50%{ filter:drop-shadow(0 0 12px rgba(255,255,255,.6)); opacity:.45 } }
/* Slow horizontal drift for clouds */
.sticker.cloud{ animation: floatY 7s ease-in-out infinite, drift 22s linear infinite alternate; }
@keyframes drift{ from{ transform:translateX(-20px)} to{ transform:translateX(20px) } }
@keyframes floatY{0%{transform:translateY(0)}50%{transform:translateY(-10px)}100%{transform:translateY(0)}}

/* Sparkles (click) + scrollbar */
.sparkle{position:fixed; pointer-events:none; width:12px; height:12px; transform:translate(-50%,-50%) scale(.6);
  background:conic-gradient(from 0deg, var(--p1), var(--p2), var(--warn), var(--p3), var(--p1));
  clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%);
  opacity:.9; filter:drop-shadow(0 6px 12px rgba(176,111,255,.35)); animation:spark-pop .8s ease-out forwards}
@keyframes spark-pop{0%{opacity:0; transform:translate(-50%,-50%) scale(.4) rotate(0)}50%{opacity:1}100%{opacity:0; transform:translate(-50%,-80%) scale(1.6) rotate(40deg)}}
::-webkit-scrollbar { height:10px; width:10px; } ::-webkit-scrollbar-thumb { background: linear-gradient(180deg,var(--p1),var(--p2)); border-radius:999px; }

/* Reduce motion (pero no cuando modo fiesta est√° activo) */
@media (prefers-reduced-motion: reduce){
  html:not([data-party="on"]) #brand .logo,
  html:not([data-party="on"]) .card{ animation:none }
  html:not([data-party="on"]) body{ animation:none }
  html:not([data-party="on"]) .cardMem .front,
  html:not([data-party="on"]) .cardMem .back{ transition:none }
  #pilot{ animation:none }
  #pilotHalo{ animation:none }
  /* Disable utility animations when reduced motion */
  .fade-in,.slide-up,.slide-left,.pop{ animation:none !important }
  /* FX: disable all reusable FX when reduced motion */
  .fx-pop,.fx-glow,.fx-shake,.fx-fade,.fx-slide-up,.fx-slide-left,.missPulse{ animation:none !important }
}

/* High contrast preference: subtly increase borders/shadows */
@media (prefers-contrast: more){
  .card, .flash, .option, .sub, #bar, #stageTop, #stageBottom { border-color: rgba(0,0,0,.25) !important; box-shadow: 0 12px 28px rgba(0,0,0,.18) !important; }
  .chip, .btn { box-shadow: 0 10px 24px rgba(0,0,0,.20) !important; }
}

/* Accesibilidad: estilos de enfoque visibles para teclado */
.chip:focus-visible,
.sub:focus-visible,
.option:focus-visible,
button:focus-visible{
  outline:3px solid var(--ring);
  outline-offset:2px;
}

/* Bot√≥n Retroceder con unicornio que gui√±a */
.uni-wrap{position:relative; display:inline-block; width:1.2em; margin-right:6px}
.uni-a,.uni-b{position:absolute; inset:0; display:inline-block; text-align:center}
.uni-b{opacity:0; animation:wink 4s infinite}
@keyframes wink{0%,92%,100%{opacity:0} 94%,98%{opacity:1}}

/* Toast bonus */
.toast{position:fixed; left:50%; top:calc(var(--h) + 8px); transform:translateX(-50%) translateY(-8px); background:var(--card); color:var(--ink); border:1px solid rgba(167,139,250,.25); border-radius:999px; padding:12px 18px; box-shadow:0 10px 24px rgba(0,0,0,.12); font-weight:900; z-index:70; opacity:0; animation:toastIn .25s forwards; font-size:20px}
.toast.out{animation:toastOut .3s forwards}
@keyframes toastIn{to{opacity:1; transform:translateX(-50%) translateY(0)}}
@keyframes toastOut{to{opacity:0; transform:translateX(-50%) translateY(-10px)}}
/* Rainbow ribbon on level-up */
#rainbow{ position:fixed; left:0; right:0; top:calc(var(--h) + 6px); height:8px; border-radius:999px; background:linear-gradient(90deg,#ec4899,#f59e0b,#10b981,#3b82f6,#8b5cf6); box-shadow:0 8px 24px rgba(0,0,0,.18); opacity:0; pointer-events:none; z-index:64 }
#rainbow.show{ animation: rbIn 1.2s ease forwards }
@keyframes rbIn{ 0%{opacity:0; transform:translateY(-6px)} 35%{opacity:1; transform:translateY(0)} 100%{opacity:0} }

/* Pilot side panel (advanced levels) */
#pilotPanel{ position:fixed; right:12px; top:calc(var(--h) + 10px); width:min(360px, 92vw); max-height:calc(100vh - var(--h) - 24px); overflow:auto; background:var(--card); color:var(--ink); border:1px solid rgba(167,139,250,.25); border-radius:16px; box-shadow:0 18px 44px rgba(0,0,0,.18); padding:14px; z-index:66; opacity:0; transform:translateX(14px); }
#pilotPanel.show{ animation: slideLeft .28s ease both }
@keyframes slideLeft{ from{ opacity:0; transform:translateX(16px)} to{ opacity:1; transform:translateX(0)} }
#pilotPanel h4{ margin:4px 0 8px; font-family:"Fredoka"; font-size:clamp(16px,1.2vw+12px,22px) }
#pilotPanel .pRow{ display:flex; align-items:center; gap:8px; font-weight:900 }
#pilotPanel .pHint{ font-size:13px; color:var(--muted); margin-top:6px }
#pilotPanel .pBtns{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }

/* Correct halo pop */
.haloPop{ position:absolute; inset:-6px; border-radius:18px; box-shadow:0 0 0 6px rgba(56,189,248,.20), 0 0 0 12px rgba(56,189,248,.10); pointer-events:none; animation: haloBurst .6s ease forwards }
@keyframes haloBurst{ 0%{ opacity:0; transform:scale(.9)} 50%{ opacity:1; transform:scale(1.06)} 100%{ opacity:0; transform:scale(1.1) } }
/* Pilot (guide) overlay */
#pilot{position:absolute; left:50%; top:8px; transform:translateX(-50%) translateY(8px); background:var(--card); color:var(--ink); border:1px solid rgba(167,139,250,.25); border-radius:16px; padding:10px 12px; box-shadow:0 12px 28px rgba(0,0,0,.10); font-weight:900; z-index:45; opacity:0; animation:pilotIn .25s ease forwards}
#pilot small{font-weight:700; color:var(--muted)}
#pilot .step{display:flex; align-items:center; gap:8px}
@keyframes pilotIn{to{opacity:1; transform:translateX(-50%) translateY(0)}}
/* Halo highlight */
#pilotHalo{position:fixed; pointer-events:none; border:3px solid var(--ring); border-radius:14px; box-shadow:0 0 0 8px rgba(249,168,212,.18), 0 0 16px rgba(249,168,212,.35); z-index:44; animation:haloPulse 1.4s ease-in-out infinite}
@keyframes haloPulse{0%,100%{transform:scale(1); opacity:.95}50%{transform:scale(1.05); opacity:.75}}

/* Rappel grid */
.rappelGrid{display:grid; grid-template-columns:repeat(6,minmax(60px,1fr)); gap:10px; margin-top:12px}
.rappelTile{height:70px; display:grid; place-items:center; background:#fff; color:#111; border:1px solid rgba(167,139,250,.35); border-radius:12px; box-shadow:0 8px 18px rgba(0,0,0,.08); font-weight:900; font-size:20px; cursor:pointer}
.rappelTile.done{outline:3px solid var(--ok)}
.rappelTile.wrongflash{outline:3px solid var(--bad)}

/* Sombra ligera para TODO el texto (mejor legibilidad) */
body, body *{
  text-shadow:0 1px 1px rgba(0,0,0,.06);
}
/* Sombra multicolor muy ligera para textos blancos */
.btn.p, .btn.d{
  text-shadow: 0 1px 1px rgba(255,0,128,.08), 0 2px 2px rgba(255,200,0,.06), 0 -1px 1px rgba(0,200,255,.06);
}
/* Dots helper for multiplication hints */
.dotsWrap{display:flex; flex-direction:column; gap:6px; margin:8px 0}
.dotRow{display:flex; gap:6px; align-items:center}
.dot{width:10px;height:10px;border-radius:999px; background:#f472b6; box-shadow:0 1px 2px rgba(0,0,0,.12)}
/* Responsive helpers */
.svgWrap svg{max-width:100%; height:auto; display:block; margin:6px 0 10px}
/* Prettier coloriage feedback */
.svgWrap svg [id^="zone-"]{ transition: fill .25s ease; }
.svgWrap svg .painted{ filter: drop-shadow(0 4px 10px rgba(176,111,255,.25)); transform-box: fill-box; transform-origin: center; animation: zone-pop .5s ease; }
@keyframes zone-pop{ 0%{transform:scale(1)} 50%{transform:scale(1.04)} 100%{transform:scale(1)} }
.colorLegend{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin:6px 0 4px}
.colorLegend .chip{padding:6px 10px;font-size:14px}
.colorDot{width:16px;height:16px;border-radius:6px;border:2px solid #0002;display:inline-block;vertical-align:-3px;margin-right:6px}
.pulse{animation:popbtn .25s ease}
.numtxt{font-weight:900;color:#111;text-shadow:0 1px 0 #fff,0 1px 2px rgba(0,0,0,.35),0 2px 6px rgba(0,0,0,.18);letter-spacing:.2px}
.option .numtxt{font-size:22px}
.draggable.numchip{font-weight:900;color:#111;text-shadow:0 1px 0 #fff,0 1px 2px rgba(0,0,0,.35),0 2px 6px rgba(0,0,0,.18)}
.rappelTile{ text-shadow:0 1px 0 #fff, 0 1px 2px rgba(0,0,0,.35), 0 2px 6px rgba(0,0,0,.18) }
#sumBox{ font-weight:900; text-shadow:0 1px 0 #fff, 0 1px 2px rgba(0,0,0,.35), 0 2px 6px rgba(0,0,0,.18) }
.spatialWrap{position:relative;width:min(720px,96vw);height:340px;margin:8px auto}
.spatialWrap .zone{position:absolute;border:2px dashed rgba(167,139,250,.45);border-radius:12px}
.spatialWrap .zone.sel{outline:3px solid var(--ring);outline-offset:1px}
.spatialMouse{position:absolute;font-size:46px;cursor:grab;user-select:none;touch-action:none;filter:drop-shadow(0 6px 10px rgba(0,0,0,.12)); transition:left .45s ease, top .45s ease}
.spatialMouse.drag{cursor:grabbing}
/* Saucisse helpers */
.stepBox{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.tag{background:#fff;border:1px solid rgba(167,139,250,.25);border-radius:999px;padding:6px 10px;font-weight:900;box-shadow:0 6px 14px rgba(0,0,0,.06)}
@media (max-width:720px){
  :root{ --h:64px }
  .prompt{font-size:22px}
  .option{min-height:72px; font-size:16px}
}
/* Extra breakpoints for Samsung and iPad 11" */
@media (max-width:430px){
  #grid{ grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)) }
  #bar{ gap:6px }
  .chip{ font-size:13px; padding:6px 8px }
}
@media (min-width:600px) and (max-width:767px){ #grid{ grid-template-columns: repeat(auto-fit, minmax(200px,1fr)) } }
@media (min-width:768px) and (max-width:833px){ #grid{ grid-template-columns: repeat(auto-fit, minmax(220px,1fr)) } }
@media (min-width:834px) and (max-width:1023px){ #grid{ grid-template-columns: repeat(auto-fit, minmax(240px,1fr)) } }
@media (min-width:1024px) and (max-width:1199px){ #grid{ grid-template-columns: repeat(auto-fit, minmax(260px,1fr)) } }
@media (min-width:1200px){ #grid{ grid-template-columns: repeat(auto-fit, minmax(280px,1fr)) } }
@media (max-width:680px){
  #drawWrap{ grid-template-columns:1fr; }
}
/* Landscape small screens (e.g., some Samsung phones horizontal) */
@media (orientation: landscape) and (max-height: 480px){
  :root{ --h:56px }
  .prompt{ font-size: clamp(18px, 1.6vw + 10px, 24px) }
  .option{ min-height:60px; font-size: clamp(14px, 1vw + 9px, 18px) }
  #stageBottom{ position: sticky; bottom: 0 }
}
/* iPad 11" tuning (portrait/landscape) */
@media (min-width: 810px) and (max-width: 1200px){
  #grid{ grid-template-columns: repeat(auto-fit, minmax(240px,1fr)) }
  .option{ font-size: clamp(18px, 1vw + 14px, 24px) }
}
</style>
</head>
<body>
<a href="#content" class="skip-link">Aller au contenu</a>
<header role="banner">
  <div id="bar">
    <div id="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">
        <div class="t1">Appli de L√©na ‚Äî 2e primaire</div>
        <div class="t2">Monde licorne magique</div>
      </div>
    </div>
    <div id="controls">
      <div id="coinChip" class="chip" aria-live="polite">ü¶Ñüí∞ <span id="coins">0</span></div>
      <div class="chip badge">Niv. <span id="lvl">1</span></div>
      <div id="soundChip" class="chip">üîä <b id="soundState">ON</b></div>
      <!-- themeChip et partyChip fusionn√©s dans üéõÔ∏è Modes -->
      <div id="modeChip" class="chip ghost" aria-label="Modes" title="Modes">üéõÔ∏è Modes</div>
      <div id="fsChip" class="chip ghost" aria-label="Basculer plein √©cran">‚õ∂ Plein √©cran</div>
      <div id="homeChip" class="chip ghost" aria-label="Menu principal">ü¶Ñ Menu</div>
      <div id="avatarChip" class="chip" aria-label="Avatar enfant"><span id="avatarEmoji">üôÇ</span> <span id="avatarName">Invit√©</span></div>
      <button id="btnFlash" class="chip">‚ö° R√©vision</button>
      <button id="btnShop" class="chip">üõçÔ∏è Boutique</button>
      <button id="btnScores" class="chip">üèÜ Scores</button>
    </div>
  </div>
</header>

<main role="main">
  <!-- Home menu grid -->
  <section id="home">
    <div id="homeInner">
      <div id="grid"></div>
    </div>
  </section>

  <!-- Stage (exercises) -->
  <section id="stage">
    <div id="stageTop">
      <div id="breadcrumbs">Accueil</div>
      <div style="display:flex; align-items:center; gap:10px;"><div id="uni" aria-label="licorne">ü¶Ñ</div></div>
    </div>
    <div id="progress"><div id="barProg"></div></div>
    <div id="content"></div>
    <div id="stageBottom">
      <div class="small" id="tip">Astuce : active le mode plein √©cran pour mieux jouer</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnPrev" class="btn g magic"><span class="uni-wrap"><span class="uni-a">ü¶Ñ</span><span class="uni-b">üòâ</span></span> üîô Retour</button>
        <button id="btnSkip" class="btn g magic">‚è≠Ô∏è Passer</button>
        <button id="btnCheck" class="btn p magic">‚úÖ Valider</button>
      </div>
    </div>
  </section>
</main>

<!-- Modal -->
<div id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="box" tabindex="-1">
    <h3 id="modalTitle">Titre</h3>
    <div id="modalBody" aria-live="polite">‚Ä¶</div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
      <button id="modalClose" class="btn s">OK, ü¶Ñüòâ</button>
    </div>
  </div>
</div>

<div id="rainbow" aria-hidden="true"></div>
<canvas id="fx"></canvas>

<script>
/* =========================================================
   Appli de L√©na ‚Äî Menu con estrellas y efectos ‚ú®
   ========================================================= */
(() => {
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const shuffle=arr=>arr.sort(()=>Math.random()-.5);
  const choice=arr=>arr[Math.floor(Math.random()*arr.length)];
  // Friendly house banner for "Maisons des nombres"
  function houseSVG(total){
    const W=720,H=220;
    return `<?xml version='1.0' encoding='UTF-8'?>
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${W} ${H}' width='100%'>
      <defs>
        <linearGradient id='hbg' x1='0' x2='1'><stop offset='0' stop-color='#eef2ff'/><stop offset='1' stop-color='#fdf2f8'/></linearGradient>
        <filter id='s' x='-10%' y='-10%' width='120%' height='120%'><feDropShadow dx='0' dy='1' stdDeviation='1' flood-color='#000' flood-opacity='.1'/></filter>
      </defs>
      <rect x='0' y='0' width='${W}' height='${H}' rx='16' fill='url(#hbg)'/>
      <!-- ground -->
      <rect x='20' y='180' width='680' height='18' rx='9' fill='#86efac' opacity='.6'/>
      <!-- house base -->
      <rect x='180' y='90' width='360' height='100' rx='12' fill='#fee2e2' filter='url(#s)'/>
      <!-- roof -->
      <polygon points='180,92 360,32 540,92' fill='#fca5a5' filter='url(#s)'/>
      <!-- windows A/B -->
      <rect x='220' y='110' width='90' height='60' rx='10' fill='#ffffff' stroke='#000' stroke-opacity='.06'/>
      <rect x='410' y='110' width='90' height='60' rx='10' fill='#ffffff' stroke='#000' stroke-opacity='.06'/>
      <text x='265' y='146' text-anchor='middle' font-size='22' font-weight='800' fill='#334155'>A</text>
      <text x='455' y='146' text-anchor='middle' font-size='22' font-weight='800' fill='#334155'>B</text>
      <!-- total -->
      <text x='360' y='70' text-anchor='middle' font-size='26' font-weight='900' fill='#1f2937'>Total = ${total}</text>
      <text x='360' y='200' text-anchor='middle' font-size='18' font-weight='800' fill='#475569'>Glisse deux nombres dans la bo√Æte pour faire ${total}</text>
    </svg>`;
  }
  // Simple 2x2 book covers SVG to illustrate options (Lecture Assoc.)
  function bookCoversSVG(titles=[]){
    const W=720,H=260,pad=16,cw=(W-3*pad)/2,ch=(H-3*pad)/2;
    const cols=['#fde68a','#93c5fd','#fca5a5','#a7f3d0'];
    const safe=(s)=> String(s||'').slice(0,20);
    let i=0, cells='';
    for(let r=0;r<2;r++){
      for(let c=0;c<2;c++){
        const x=pad + c*(cw+pad), y=pad + r*(ch+pad);
        const t=safe(titles[i]||'');
        const col=cols[i%cols.length];
        cells += `<g>
          <rect x='${x}' y='${y}' rx='14' width='${cw}' height='${ch}' fill='${col}' opacity='0.85' stroke='#000' stroke-opacity='.06'/>
          <rect x='${x+12}' y='${y+18}' width='${cw-24}' height='${ch-70}' rx='10' fill='#fff' opacity='.75'/>
          <text x='${x+cw/2}' y='${y+ch-28}' text-anchor='middle' font-weight='800' font-size='14' fill='#1f2937'>${t}</text>
        </g>`;
        i++;
      }
    }
    return `<?xml version='1.0' encoding='UTF-8'?>
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${W} ${H}' width='${W}' height='${H}'>
      <rect x='0' y='0' width='${W}' height='${H}' rx='18' fill='url(#bg)'/>
      <defs><linearGradient id='bg' x1='0' x2='1'><stop offset='0' stop-color='#faf5ff'/><stop offset='1' stop-color='#eff6ff'/></linearGradient></defs>
      ${cells}
    </svg>`;
  }
  // Comparaisons mini SVGs per question index
  function buildCompSVG(idx){
    const base=(w=720,h=200)=>[`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${w} ${h}' width='${w}' height='${h}'>`,`</svg>`];
    // helpers
    const bar=(x,y,w,h,col='#94a3b8')=>`<rect x='${x}' y='${y}' width='${w}' height='${h}' rx='8' fill='${col}'/>`;
    const label=(x,y,t)=>`<text x='${x}' y='${y}' text-anchor='middle' font-weight='800' fill='#334155'>${t}</text>`;
    const glass=(x,fillH)=>`<g transform='translate(${x},0)'>
      <rect x='0' y='20' width='80' height='140' rx='18' fill='none' stroke='#64748b' stroke-width='3'/>
      <rect x='4' y='${160-fillH}' width='72' height='${fillH}' rx='12' fill='#60a5fa' opacity='.7'/>
    </g>`;
    const bottle=(x,h)=>`<g transform='translate(${x},0)'>
      <rect x='28' y='20' width='24' height='20' rx='6' fill='#94a3b8'/>
      <rect x='10' y='40' width='60' height='${h}' rx='20' fill='#86efac' opacity='.8' stroke='#166534' stroke-opacity='.15'/>
    </g>`;
    const jar=(x,fillH)=>`<g transform='translate(${x},0)'>
      <rect x='6' y='20' width='88' height='10' rx='6' fill='#94a3b8'/>
      <rect x='0' y='30' width='100' height='130' rx='20' fill='none' stroke='#64748b' stroke-width='3'/>
      <rect x='6' y='${160-fillH}' width='88' height='${fillH}' rx='12' fill='#93c5fd' opacity='.7'/>
    </g>`;
    const book=(x,t)=>`<g transform='translate(${x},0)'>
      <rect x='0' y='40' width='80' height='100' rx='8' fill='#fca5a5' stroke='#000' stroke-opacity='.05'/>
      <rect x='80' y='40' width='14' height='100' rx='3' fill='#ef4444'/>
      <text x='40' y='160' text-anchor='middle' font-size='12' fill='#334155' font-weight='700'>${t}</text>
    </g>`;
    const door=(x,h)=>`<g transform='translate(${x},0)'>
      <rect x='0' y='${170-h}' width='90' height='${h}' rx='8' fill='#f5d0fe' stroke='#000' stroke-opacity='.06'/>
      <circle cx='12' cy='${170-h+40}' r='4' fill='#94a3b8'/>
    </g>`;
    const bag=(x,fillH)=>`<g transform='translate(${x},0)'>
      <rect x='10' y='20' width='80' height='120' rx='18' fill='#fde68a' stroke='#000' stroke-opacity='.06'/>
      <rect x='16' y='${140-fillH}' width='68' height='${fillH}' rx='12' fill='#f59e0b' opacity='.7'/>
    </g>`;
    const W=720,H=200; const [s,e]=base(W,H);
    switch(idx){
      case 0: // ficelles: A longest
        return s+ bar(80,120,180,12,'#64748b')+label(170,150,'ficelle A')+
                   bar(300,140,140,12,'#94a3b8')+label(370,170,'ficelle B')+
                   bar(480,160,100,12,'#cbd5e1')+label(530,190,'ficelle C')+ e;
      case 1: // pains: least thick
        return s+ bar(120,90,120,28,'#fca5a5')+label(180,150,'pain fin')+
                   bar(320,70,120,48,'#fb7185')+label(380,150,'pain moyen')+
                   bar(520,50,120,68,'#ef4444')+label(580,150,'pain √©pais')+ e;
      case 2: // glasses 1/3,2/3,3/3
        return s+ glass(110,40)+label(150,180,'verre 1/3')+
                   glass(320,80)+label(360,180,'verre 2/3')+
                   glass(530,120)+label(570,180,'verre 3/3')+ e;
      case 3: // prices
        return s+ label(160,100,'stylo 1‚Ç¨')+label(360,100,'cahier 2‚Ç¨')+label(560,100,'boite 3‚Ç¨')+
                   bar(120,110,80,6,'#86efac')+bar(320,110,120,6,'#fde68a')+bar(520,110,160,6,'#fca5a5')+ e;
      case 4: // doors heights
        return s+ door(120,120)+label(165,190,'porte A')+
                   door(320,90)+label(365,190,'porte B')+
                   door(520,70)+label(565,190,'porte C')+ e;
      case 5: // bottles capacity
        return s+ bottle(120,120)+label(165,180,'2 L')+
                   bottle(320,80)+label(365,180,'1 L')+
                   bottle(520,60)+label(565,180,'0,5 L')+ e;
      case 6: // traits: shortest C
        return s+ bar(120,80,200,6,'#94a3b8')+label(220,110,'trait A')+
                   bar(320,90,140,6,'#cbd5e1')+label(390,120,'trait B')+
                   bar(520,100,80,6,'#e5e7eb')+label(560,130,'trait C')+ e;
      case 7: // sacs fill: least filled
        return s+ bag(120,40)+label(165,180,'sac l√©ger')+
                   bag(320,80)+label(365,180,'sac moyen')+
                   bag(520,120)+label(565,180,'sac lourd')+ e;
      case 8: // carnets thickness
        return s+ book(120,'petit')+book(320,'moyen')+book(520,'gros')+ e;
      case 9: // jars water: least water
        return s+ jar(110,20)+label(160,180,'vide')+
                   jar(310,70)+label(360,180,'moiti√©')+
                   jar(510,130)+label(560,180,'plein')+ e;
      default:
        return s+ label(W/2, H/2, 'Comparaisons')+ e;
    }
  }
  // Spatial scene SVG (house centered + helpers)
  function spatialSceneSVG(){
    const W=720,H=340;
    return `<?xml version='1.0' encoding='UTF-8'?>
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${W} ${H}' width='${W}' height='${H}'>
      <defs>
        <linearGradient id='sbg' x1='0' x2='1'><stop offset='0' stop-color='#eef2ff'/><stop offset='1' stop-color='#fdf2f8'/></linearGradient>
        <filter id='ss' x='-10%' y='-10%' width='120%' height='120%'><feDropShadow dx='0' dy='1' stdDeviation='1' flood-color='#000' flood-opacity='.1'/></filter>
      </defs>
      <rect x='0' y='0' width='${W}' height='${H}' rx='18' fill='url(#sbg)'/>
      <!-- sol -->
      <rect x='20' y='300' width='680' height='14' rx='7' fill='#86efac' opacity='.6'/>
      <!-- mur (pour \'contre\') -->
      <rect x='640' y='40' width='20' height='260' rx='6' fill='#cbd5e1'/>
      <!-- chaises (pour \"entre\") -->
      <rect x='70' y='230' width='60' height='70' rx='10' fill='#fcd34d' filter='url(#ss)'/>
      <rect x='190' y='230' width='60' height='70' rx='10' fill='#fcd34d' filter='url(#ss)'/>
      <!-- maison -->
      <polygon points='300,120 420,120 360,70' fill='#fca5a5' filter='url(#ss)'/>
      <rect x='300' y='120' width='120' height='120' rx='14' fill='#fee2e2' filter='url(#ss)'/>
      <rect x='318' y='190' width='36' height='50' rx='8' fill='#93c5fd'/>
      <rect x='366' y='190' width='36' height='50' rx='8' fill='#93c5fd'/>
      <rect x='352' y='210' width='28' height='60' rx='6' fill='#fbbf24'/>
      <text x='360' y='50' text-anchor='middle' font-size='20' font-weight='900' fill='#334155'>üè† Maison</text>
      <text x='100' y='220' text-anchor='middle' font-size='16' font-weight='800' fill='#334155'>Chaises</text>
      <text x='650' y='320' text-anchor='middle' font-size='14' font-weight='700' fill='#334155'>Mur</text>
    </svg>`;
  }
  // Number line for "saucisse" steps
  function sausageSVG(a,b,op,phase){
    const W=720,H=180, pad=40;
    const min=0,max=20; // simple range
    const toX=v=> pad + (W-2*pad) * (v-min)/(max-min);
    const base = [`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${W} ${H}' width='${W}' height='${H}'>`];
    base.push(`<rect x='0' y='0' width='${W}' height='${H}' rx='14' fill='url(#g)'/>`);
    base.push(`<defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='#f8fafc'/><stop offset='1' stop-color='#f3e8ff'/></linearGradient></defs>`);
    // baseline
    base.push(`<line x1='${toX(min)}' y1='100' x2='${toX(max)}' y2='100' stroke='#94a3b8' stroke-width='3'/>`);
    for(let i=min;i<=max;i+=2){ const x=toX(i); base.push(`<line x1='${x}' y1='95' x2='${x}' y2='105' stroke='#64748b'/>`); if(i%4===0) base.push(`<text x='${x}' y='120' text-anchor='middle' font-size='12' fill='#334155'>${i}</text>`); }
    // current and goals
    const cur = phase===0? a : (phase===1? 10 : (op==='+'? a+b : a-b));
    const tx10 = toX(10), txCur=toX(cur), txStart=toX(a), txRes = toX(op==='+'? a+b : a-b);
    // arcs for steps
    if(phase>=1){ base.push(`<path d='M ${txStart} 92 Q ${(txStart+tx10)/2} 60 ${tx10} 92' fill='none' stroke='#f59e0b' stroke-width='3'/>`); }
    if(phase>=2){ base.push(`<path d='M ${tx10} 92 Q ${(tx10+txRes)/2} 60 ${txRes} 92' fill='none' stroke='#22c55e' stroke-width='3'/>`); }
    // markers
    base.push(`<circle cx='${txStart}' cy='100' r='6' fill='#ef4444'/>`);
    base.push(`<circle cx='${txCur}' cy='100' r='8' fill='#3b82f6'/>`);
    base.push(`<circle cx='${txRes}' cy='100' r='6' fill='#10b981'/>`);
    base.push(`<text x='${txCur}' y='80' text-anchor='middle' font-weight='900' fill='#1f2937'>${cur}</text>`);
    base.push(`</svg>`);
    return base.join('');
  }
  // Soustraction pos√©e (avec retenue) ‚Äî SVG didactique
  function posedSubSVG(a,b){
    const da=Math.floor(a/10), ua=a%10; const db=Math.floor(b/10), ub=b%10;
    const borrow = ua<ub ? 1 : 0; const da2 = da-borrow; const ua2 = borrow? ua+10 : ua;
    const W=720,H=220; const x0=240,y0=70, cell=56, pad=10;
    function box(x,y,txt,hl){
      const f=hl? '#fef3c7':'#fff'; const s=hl? '#f59e0b':'#cbd5e1';
      return `<rect x='${x}' y='${y}' width='${cell}' height='${cell}' rx='10' fill='${f}' stroke='${s}'/>
              <text x='${x+cell/2}' y='${y+cell/2+8}' text-anchor='middle' font-weight='900' font-size='24' fill='#111'>${txt}</text>`;
    }
    const Dcol = x0, Ucol = x0+cell+pad;
    const parts=[];
    // en-t√™tes D/U
    parts.push(`<text x='${Dcol+cell/2}' y='${y0-16}' text-anchor='middle' font-weight='900' fill='#334155'>D</text>`);
    parts.push(`<text x='${Ucol+cell/2}' y='${y0-16}' text-anchor='middle' font-weight='900' fill='#334155'>U</text>`);
    // premi√®re ligne (minuend)
    parts.push(box(Dcol,y0, da2<0?0:da2, borrow?1:0));
    parts.push(box(Ucol,y0, ua2, borrow?1:0));
    // fl√®che de retenue
    if(borrow){
      const x1=Ucol+cell/2, y1=y0-6, x2=Dcol+cell/2, y2=y0;
      parts.push(`<path d='M ${x2} ${y2} C ${x2} ${y2-36}, ${x1} ${y2-36}, ${x1} ${y1}' stroke='#f59e0b' stroke-width='3' fill='none' marker-end='url(#arrow)'/>`);
      parts.push(`<text x='${x1+16}' y='${y1-8}' fill='#f59e0b' font-weight='800'>+10</text>`);
    }
    // deuxi√®me ligne (subtrahend)
    const y1=y0+cell+8;
    parts.push(box(Dcol,y1, db, 0));
    parts.push(box(Ucol,y1, ub, 0));
    parts.push(`<text x='${Dcol-28}' y='${y1+cell/2+10}' font-size='28' font-weight='900' fill='#334155'>‚àí</text>`);
    // ligne r√©sultat
    const y2=y1+cell+16;
    const r=a-b; const rd=Math.floor(r/10), ru=r%10;
    parts.push(box(Dcol,y2, rd, 0));
    parts.push(box(Ucol,y2, ru, 0));
    // barre de r√©sultat
    parts.push(`<rect x='${Dcol-8}' y='${y2-10}' width='${cell*2+pad+16}' height='4' rx='2' fill='#94a3b8'/>`);
    // defs
    const defs = `<defs><marker id='arrow' markerWidth='14' markerHeight='14' refX='10' refY='6' orient='auto-start-reverse'>
      <path d='M 0 0 L 12 6 L 0 12 z' fill='#f59e0b'/></marker></defs>`;
    return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${W} ${H}' width='${W}' height='${H}'>
      <rect x='0' y='0' width='${W}' height='${H}' rx='16' fill='url(#g2)'/>
      <defs><linearGradient id='g2' x1='0' x2='1'><stop offset='0' stop-color='#f8fafc'/><stop offset='1' stop-color='#f3e8ff'/></linearGradient></defs>
      ${defs}
      ${parts.join('')}
    </svg>`;
  }
  // Simple SVG generator for Tower of Hanoi (illustrative)
  function hanoiSVG(n=3){
    n=Math.max(3,Math.min(8,n));
    const W=720,H=180, baseY=150, pegW=8, pegH=110, pad=40;
    const pegX=[pad, W/2, W-pad];
    const colors=['#a5b4fc','#fda4af','#fdba74','#86efac','#93c5fd','#f5d0fe','#fecdd3','#99f6e4'];
    let discs='';
    for(let i=0;i<n;i++){
      const w=40 + (i+1)*20; const x=pegX[0]-w/2; const y=baseY - i*14 - 10;
      const c=colors[i%colors.length];
      discs += `<rect x="${x}" y="${y}" rx="6" ry="6" width="${w}" height="12" fill="${c}" stroke="#1f2937" stroke-opacity="0.08"/>`;
    }
    const pegs = pegX.map(x=>`<rect x="${x-pegW/2}" y="${baseY-pegH}" width="${pegW}" height="${pegH}" fill="#94a3b8"/>`).join('');
    const base = `<rect x="${pad-60}" y="${baseY}" width="${W-2*(pad-60)}" height="10" rx="5" fill="#e5e7eb"/>`;
    return `<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Tour de Hano√Ø">
      <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#f3e8ff"/><stop offset="1" stop-color="#e0e7ff"/></linearGradient></defs>
      <rect x="0" y="0" width="${W}" height="${H}" fill="url(#g)" rx="12"/>
      ${base}${pegs}${discs}
    </svg>`;
  }
  const renderDots=(rows,cols)=>{
    rows=rows|0; cols=cols|0; rows=Math.max(1,rows); cols=Math.max(1,cols);
    let html='<div class="dotsWrap">';
    for(let r=0;r<rows;r++){
      html += '<div class="dotRow">'+ Array.from({length:cols}).map(()=>'<span class="dot"></span>').join('') + '</div>';
    }
    html+='</div>'; return html;
  };
  const clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
  const strip=s=>(s||"").normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/\s+/g," ").trim().toLowerCase();
  // Simple TTS helper (fr-FR)
  const tts=(()=>{
    let cachedVoice=null; let ready=false; let pending=[];
    function pickVoice(){
      try{
        const vs = (window.speechSynthesis && window.speechSynthesis.getVoices)? speechSynthesis.getVoices(): [];
        if(!vs || !vs.length) return cachedVoice;
        const fr = vs.find(v=>/fr\b/i.test(v.lang));
        cachedVoice = fr || vs.find(v=>v.lang?.startsWith('fr')) || vs.find(v=>v.lang?.startsWith('en')) || vs[0] || null;
        return cachedVoice;
      }catch{ return cachedVoice }
    }
    try{
      if('speechSynthesis' in window){
        window.speechSynthesis.onvoiceschanged = ()=>{ ready=true; pickVoice(); const q=[...pending]; pending.length=0; q.forEach(t=> speakNow(t)); };
        // Trigger load
        setTimeout(()=>{ pickVoice(); ready=true; }, 300);
      }
    }catch{}
    function speakNow(text){
      try{
        if(!window.speechSynthesis || !text || !state.sound) return;
        const u=new SpeechSynthesisUtterance(text); u.lang='fr-FR'; u.rate=0.95; u.pitch=1.0; const v=pickVoice(); if(v) u.voice=v; speechSynthesis.cancel(); speechSynthesis.speak(u);
      }catch{}
    }
    return {
      speak(text){
        try{
          if(!window.speechSynthesis || !text || !state.sound) return;
          // Ensure audio context resumed to avoid mobile blocks
          try{ audioCtxResume && audioCtxResume(); }catch{}
          if(!ready && (!speechSynthesis.getVoices || speechSynthesis.getVoices().length===0)){
            pending.push(text);
          } else {
            speakNow(text);
          }
        }catch{}
      },
      stop(){ try{ speechSynthesis?.cancel?.(); }catch{} }
    }
  })();
  // Aide TDAH: expliquer en dizaines et unit√©s (court + emojis)
  const tu=n=>[Math.floor(n/10), n%10];
  const fmtTU=n=>{const [d,u]=tu(n); return `${n} = ${d} diz. + ${u} unit.`};
  const expAddSub=(a,b,res,add=true)=>{
    const sign = add?'+':'‚àí';
    const [da,ua]=tu(a), [db,ub]=tu(b), [dr,ur]=tu(res);
    const steps=[
      'üß© D√©compose',
      `${fmtTU(a)}`,
      `${fmtTU(b)}`
    ];
    if(add){
      const uSum = ua+ub; const carry = uSum>=10?1:0; const uText = carry ? `${ua} + ${ub} = ${uSum} ‚Üí garde ${ur} unit. et +${carry} diz.` : `${ua} + ${ub} = ${ur} unit.`;
      const dText = carry ? `${da} + ${db} + ${carry} = ${dr} diz.` : `${da} + ${db} = ${dr} diz.`;
      steps.push('üßÆ Calcule pas √† pas :');
      steps.push(`Unit√©s : ${uText}`);
      steps.push(`Dizaines : ${dText}`);
    } else {
      let ua2=ua, da2=da, borrow=0;
      if(ua<ub){ ua2=ua+10; da2=da-1; borrow=1; }
      const uText = borrow ? `${ua} < ${ub} ‚Üí emprunt : ${ua}+10 = ${ua2}; ${ua2} ‚àí ${ub} = ${ur} unit.` : `${ua} ‚àí ${ub} = ${ur} unit.`;
      const dText = borrow ? `${da} ‚àí 1 ‚àí ${db} = ${dr} diz.` : `${da} ‚àí ${db} = ${dr} diz.`;
      steps.push('üßÆ Calcule pas √† pas :');
      steps.push(`Unit√©s : ${uText}`);
      steps.push(`Dizaines : ${dText}`);
    }
    steps.push(`‚ú® R√©sultat : ${a} ${sign} ${b} = <b>${res}</b>`);
    steps.push(`${fmtTU(res)}`);
    return steps.join('<br>');
  };

  const STORE="lena_menu_v3";
  const ADHD_MODE=true; // Mode douceur: feedback gentil, pas de p√©nalit√©, indices brefs
  const ENABLE_MOVE_BREAKS=false; // D√©sactive les pauses mouvement demand√©es
  const state={
    level:1,totalLevels:6,coins:0,sound:true, theme:null, party:false,
    user:{name:"Invit√©"},
    area:null,sub:null,
    progress:{done:0,total:5},
    asked:new Set(),
    scores:[], inventory:[], album:[],
    stars:{} /* key "area|sub" => 0..3 */,
    block:{correct:0,wrong:0},
    streak:0,
    blockStartCoins:0,
    avatar:{hat:null, acc:null, bg:null, face:'üôÇ'},
    currentWrong:0
  };
  let navStack=["home"]; let skipPush=false;
  const save=()=>localStorage.setItem(STORE, JSON.stringify({...state,asked:[...state.asked]}));
  const load=()=>{try{const d=JSON.parse(localStorage.getItem(STORE)||"{}");Object.assign(state,d,{asked:new Set()});}catch{}};

  /* ----------- audio ----------- */
  let audioCtxResume=null;
  const audio=(()=>{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    audioCtxResume=()=>{ try{ ctx.resume && ctx.resume(); }catch{} };
    const beep=(f=700,d=.1,type='sine',v=.18)=>{ if(!state.sound) return;
      const o=ctx.createOscillator(), g=ctx.createGain(); o.type=type; o.frequency.value=f; g.gain.value=v; o.connect(g).connect(ctx.destination);
      o.start(); setTimeout(()=>o.stop(), d*1000);
    };
    return {
      ok(){beep(880,.08,'sine',.15); setTimeout(()=>beep(1320,.1,'sine',.12),80)},
      no(){beep(220,.16,'sawtooth',.15); setTimeout(()=>beep(180,.16,'square',.12),120)},
      click(){beep(520,.05,'triangle',.08)}
    }
  })();

  /* ----------- SFX: tiny sound toolkit (reusable) ----------- */
  // SFX: play(key,{volume,rate}) with short, gentle tones. Respects state.sound.
  const sfx = (()=>{
    let ctx=null;
    function ensure(){ if(ctx) return ctx; try{ ctx=new (window.AudioContext||window.webkitAudioContext)(); }catch{} return ctx; }
    function tone(freq=600, dur=0.12, type='sine', vol=0.15){ if(!state.sound) return; const ac=ensure(); if(!ac) return; try{ const o=ac.createOscillator(); const g=ac.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g).connect(ac.destination); o.start(); setTimeout(()=>{ try{o.stop()}catch{} }, dur*1000);}catch{} }
    function chord(list){ list.forEach(([f,d,t,v,delay])=> setTimeout(()=> tone(f,d,t,v), (delay||0))); }
    return {
      init(){ try{ ensure(); }catch{} },
      play(key,opts={}){
        try{ audioCtxResume && audioCtxResume(); }catch{}
        switch(key){
          case 'click': return audio.click();
          case 'ok': return audio.ok();
          case 'error': return audio.no();
          case 'flip': return tone(640, .09, 'triangle', .12);
          case 'move': return tone(500, .08, 'square', .10);
          case 'trail': return tone(760, .06, 'sine', .08);
          case 'fanfare': return chord([[880,.08,'sine',.14,0],[1175,.10,'sine',.12,90],[1568,.12,'triangle',.10,180]]);
          default: return;
        }
      }
    };
  })();
  try{ sfx.init(); }catch{}

  /* ----------- FX: lightweight class toggles (reusable) ----------- */
  const FX = {
    // FX: add class, remove after animation end
    use(el, cls){ try{ if(!el) return; el.classList.remove(cls); void el.offsetWidth; el.classList.add(cls); const off=()=>{ el.classList.remove(cls); el.removeEventListener('animationend', off); }; el.addEventListener('animationend', off); }catch{} },
    pop(el){ this.use(el,'fx-pop'); },
    glow(el){ this.use(el,'fx-glow'); },
    shake(el){ this.use(el,'fx-shake'); }
  };

  /* ----------- haptics (gentle vibration on mobile) ----------- */
  function haptic(kind){
    try{
      if(!('vibrate' in navigator)) return;
      if(kind==='ok') navigator.vibrate([8, 28, 8]);
      else if(kind==='no') navigator.vibrate([12, 24, 12]);
      else navigator.vibrate(10);
    }catch{}
  }

  /* ----------- celebration (new pastel burst) ----------- */
  const fx=(()=>{
    // Lightweight canvas burst with hearts/stars that fade out
    const c=$("#fx"), ctx=c.getContext("2d"); let W=0,H=0,parts=[],raf,life=0;
    const palette=["#ffd1e8","#d9c7ff","#b9f5d0","#cde7ff","#ffef9f","#f9a8d4","#a78bfa"]; // pastels
    const resize=()=>{c.width=W=innerWidth; c.height=H=innerHeight}; addEventListener("resize",resize); resize();
    function drawHeart(x,y,s,rot,col,alpha){
      ctx.save(); ctx.translate(x,y); ctx.rotate(rot); ctx.scale(s,s); ctx.globalAlpha=alpha; ctx.fillStyle=col;
      ctx.beginPath(); ctx.moveTo(0,-6); ctx.bezierCurveTo(6,-12, 16,-6, 0,10); ctx.bezierCurveTo(-16,-6, -6,-12, 0,-6); ctx.fill(); ctx.restore();
    }
    function drawStar(x,y,r,rot,col,alpha){
      ctx.save(); ctx.translate(x,y); ctx.rotate(rot); ctx.globalAlpha=alpha; ctx.fillStyle=col;
      ctx.beginPath(); for(let i=0;i<10;i++){ const a=i*Math.PI/5; const rr=i%2? r*0.5:r; ctx.lineTo(Math.cos(a)*rr, Math.sin(a)*rr);} ctx.closePath(); ctx.fill(); ctx.restore();
    }
    function loop(){ cancelAnimationFrame(raf); raf=requestAnimationFrame(loop);
      ctx.clearRect(0,0,W,H);
      parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.012; p.rot+=p.vr; p.age+=1; });
      parts=parts.filter(p=>p.age<p.maxAge);
      const t=parts.length? parts[0].age : 0; life=t;
      parts.forEach(p=>{
        const a=Math.max(0, 1 - (p.age/p.maxAge));
        if(p.kind==='heart') drawHeart(p.x,p.y,p.s, p.rot, p.c, a);
        else drawStar(p.x,p.y,p.r, p.rot, p.c, a);
      });
      if(parts.length===0){ ctx.clearRect(0,0,W,H); }
    }
    function spawn(n=60){
      parts.length=0; life=0;
      const cx=innerWidth/2, cy=Math.max(100, innerHeight*0.25);
      for(let i=0;i<n;i++){
        const kind = Math.random()<0.55?'heart':'star';
        const c=choice(palette); const ang=Math.random()*Math.PI*2; const sp=1.2+Math.random()*1.8;
        parts.push({
          kind,
          x:cx + Math.cos(ang)*8,
          y:cy + Math.sin(ang)*4,
          vx:Math.cos(ang)*sp,
          vy:Math.sin(ang)*sp*0.6 - 0.2,
          rot:Math.random()*Math.PI,
          vr:(Math.random()-.5)*0.2,
          s:0.5+Math.random()*0.9,
          r:6+Math.random()*10,
          c,
          age:0,
          maxAge: 60+Math.floor(Math.random()*30)
        });
      }
      loop();
      // Automatic cleanup after ~2 seconds
      setTimeout(()=>{ parts.length=0; cancelAnimationFrame(raf); ctx.clearRect(0,0,W,H); }, 2200);
    }
    return {spawn};
  })();

  // Win popup disabled (no animation after each achievement)
  function showWinPopup(msg='Bravo ! +1 ü¶Ñüí∞'){ return; }

  /* ----------- sparkles on click ----------- */
  function sparkleAt(x,y,count=6){
    for(let i=0;i<count;i++){
      const s=document.createElement("div"); s.className="sparkle";
      s.style.left=(x+rnd(-12,12))+"px"; s.style.top=(y+rnd(-8,8))+"px";
      document.body.appendChild(s); setTimeout(()=>s.remove(),800);
    }
  }
  document.addEventListener("pointerdown",e=>{
    if(e.target.closest(".sub,.card,.option,.chip")){
      sparkleAt(e.clientX,e.clientY,8);
      haptic('tap');
    }
  });
  // Safety: delegate critical demo buttons in case of reconciling content
  document.addEventListener("click", (ev)=>{
    const t=ev.target;
    if(t && t.id==="soustrSpeak" && !t.onclick){ try{ audioCtxResume && audioCtxResume(); }catch{}; const txt = "Soustraction pos√©e : explication"; try{ tts.speak(txt); }catch{} }
    if(t && t.id==="soustrStart" && !t.onclick){ try{ nextQuestion(); }catch{} }
  });
  // Asegura que el audio funcione tras la primera interacci√≥n del usuario
  addEventListener("pointerdown", ()=>{ try{ audioCtxResume && audioCtxResume(); }catch{} }, {once:true});

  /* ----------- Floating stickers (hearts, stars, clouds) ----------- */
  function spawnStickers(){
    try{
      if(document.querySelector('.sticker')) return; // already spawned
      const EMO=['‚≠ê','‚ú®','üíñ','üåà','‚òÅÔ∏è','üåü','üí´','ü©∑','ü©µ','ü™Ñ'];
      const n = Math.min(14, Math.max(6, Math.round((innerWidth*innerHeight)/140000)));
      for(let i=0;i<n;i++){
        const el=document.createElement('div'); el.className='sticker'; const emo=choice(EMO); el.textContent=emo;
        const s = 18 + Math.random()*18; el.style.fontSize = s+'px';
        el.style.left = Math.round(Math.random()*100)+'vw';
        el.style.top  = Math.round(Math.random()*100)+'vh';
        el.style.opacity = (0.18 + Math.random()*0.18).toFixed(2);
        el.style.animationDuration = (5 + Math.random()*4)+'s';
        if(['‚≠ê','‚ú®','üåü','üí´'].includes(emo)) el.classList.add('tw');
        if(emo==='‚òÅÔ∏è') el.classList.add('cloud');
        document.body.appendChild(el);
      }
      // gentle reposition loop
      setInterval(()=>{
        document.querySelectorAll('.sticker').forEach(el=>{
          if(Math.random()<0.25){
            el.style.left = Math.round(Math.random()*100)+'vw';
            el.style.top  = Math.round(Math.random()*100)+'vh';
          }
        });
      }, 5000);
    }catch{}
  }

  /* ----------- Pilot (guide) ----------- */
  let pilotTimers=[];
  function pilotStop(){ try{ pilotTimers.forEach(clearTimeout); pilotTimers=[]; }catch{} const pe=document.getElementById('pilot'); if(pe) pe.remove(); const h=document.getElementById('pilotHalo'); if(h) h.remove(); }
  function guideStepText(q){
    switch(q?.type){
      case 'qcm': return 'Lis la consigne, puis choisis la meilleure r√©ponse.';
      case 'input': return '√âcris ta r√©ponse dans la bo√Æte. Tu peux v√©rifier.';
      case 'order': return 'Glisse les √©l√©ments au bon endroit puis valide.';
      default: return 'Lis bien la consigne et avance doucement.';
    }
  }
  function showHaloAround(node){
    try{
      const r=node.getBoundingClientRect();
      let halo=document.getElementById('pilotHalo');
      if(!halo){ halo=document.createElement('div'); halo.id='pilotHalo'; document.body.appendChild(halo); }
      halo.style.left=(r.left + window.scrollX - 8)+'px';
      halo.style.top=(r.top + window.scrollY - 8)+'px';
      halo.style.width=(r.width + 16)+'px';
      halo.style.height=(r.height + 16)+'px';
    }catch{}
  }
  function pilotStart(q, kind, force){
    pilotStop();
    const old=document.getElementById('pilotPanel'); if(old) old.remove();
    // Show for levels 6+, or when forced (e.g., after 2 errors)
    if(((state.level||1) < 6) && !force) return;
    const panel=document.createElement('aside');
    panel.id='pilotPanel'; panel.setAttribute('role','complementary'); panel.setAttribute('aria-live','polite');
    const steps=guideStepText(q);
    const hintNow=q?.meta?.hint || q?.explain || '';
    panel.innerHTML = `
      <h4>${state.avatar?.face||'üôÇ'} Guide licorne</h4>
      <div class="pRow">üß≠ ${steps}</div>
      <div class="pHint" id="pHint">${hintNow? 'Indice : '+hintNow : 'Le guide peut donner un indice si tu bloques.'}</div>
      <div class="pBtns">
        <button class="btn g" id="pReplay">Revoir la d√©mo</button>
        <button class="btn g" id="pClose">Fermer</button>
      </div>`;
    document.body.appendChild(panel);
    requestAnimationFrame(()=> panel.classList.add('show'));
    // Progressive hint upgrade
    const more = q?.explain && (!hintNow || hintNow.length<q.explain.length) ? q.explain : '';
    if(more){ pilotTimers.push(setTimeout(()=>{ const el=document.getElementById('pHint'); if(el) el.innerHTML = 'Indice : '+more; }, 9000)); }
    // Demo focusing halo
    const runFocus=()=>{
      try{
        if(kind==='qcm'){ const items=Array.from(document.querySelectorAll('#opts .option')); const idx=state.current?.correct|0; const target=items[idx]; if(target) showHaloAround(target); }
        else if(kind==='input'){ const ans=document.getElementById('ans'); if(ans) showHaloAround(ans); }
        else if(kind==='order'){ const drop=document.getElementById('drop'); if(drop) showHaloAround(drop); }
      }catch{}
    };
    pilotTimers.push(setTimeout(runFocus, 14000));
    // Buttons
    panel.querySelector('#pClose').onclick=()=>{ panel.remove(); };
    panel.querySelector('#pReplay').onclick=()=>{
      try{
        if(q?.meta?.speakText){ audioCtxResume && audioCtxResume(); tts.speak(q.meta.speakText); }
        else { runFocus(); }
      }catch{}
    };
  }

  /* ----------- header chips ----------- */
  $("#fsChip").onclick=()=>{
    if(!document.fullscreenElement) {
      document.documentElement.requestFullscreen().catch(()=>{});
    } else {
      document.exitFullscreen();
    }
  };
  // Sync aria-pressed on fullscreen changes
  document.addEventListener('fullscreenchange', ()=>{
    const fs=$("#fsChip"); if(fs) fs.setAttribute('aria-pressed', String(!!document.fullscreenElement));
  });
  $("#soundChip").onclick=()=>{ state.sound=!state.sound; $("#soundState").textContent=state.sound?"ON":"OFF"; $("#soundChip").setAttribute('aria-pressed', String(state.sound)); save(); };
  $("#homeChip").onclick=()=> showHome();
  $("#btnFlash").onclick=()=> openFlashcards();
  $("#btnShop").onclick=()=> openShop();
  $("#btnScores").onclick=()=> showScores();
  $("#avatarChip").onclick=()=> openAvatar();
  $("#modeChip").onclick=()=> openModes();
  const themeEl=$("#themeChip");
  if(themeEl){ themeEl.onclick=()=>{ // toggle dark/light
    const now = document.documentElement.getAttribute("data-theme");
    if(now==="dark"){ document.documentElement.removeAttribute("data-theme"); state.theme=null; themeEl.textContent='‚òÄÔ∏è'; themeEl.setAttribute('aria-pressed','false'); }
    else { document.documentElement.setAttribute("data-theme","dark"); state.theme="dark"; themeEl.textContent='üåô'; themeEl.setAttribute('aria-pressed','true'); }
    save();
  }; }
  // Mode f√™te supprim√© pour favoriser la concentration

  // Hacer enfocables solo chips interactivos (evita moneda/niveau)
  $$('#controls .chip:not(button):not(.badge):not(#coinChip)').forEach(el=>{ el.tabIndex=0; el.setAttribute('role','button'); });
  // Reinicio de progreso local
  // (Bouton R√©initialiser supprim√©)

  // Accesibilidad teclado: Enter/Espacio activan elementos interactivos y ESC cierra modal
  document.addEventListener("keydown", (e)=>{
    const t=e.target;
    if((e.key==="Enter"||e.key===" ") && (t?.classList?.contains("chip") || t?.classList?.contains("sub") || t?.classList?.contains("option"))){
      e.preventDefault(); t.click();
    }
    if(e.key==="Escape" && $("#modal").style.display!=="none"){ hideModal(); }
  });

  /* ----------- HUD ----------- */
  const avatarGlyph=()=>`${state.avatar?.hat||''} ${state.avatar?.hair||''} ${state.avatar?.face||'üôÇ'} ${state.avatar?.outfit||''} ${state.avatar?.acc||''}`.trim();
  // Guide licorne qui √©volue avec les pi√®ces
  const GUIDE_STEPS=[
    {min:0,    name:'B√©b√© licorne',     emoji:'üçºü¶Ñ'},
    {min:20,   name:'Licorne curieuse', emoji:'üåüü¶Ñ'},
    {min:50,   name:'Licorne brillante',emoji:'‚ú®ü¶Ñ'},
    {min:100,  name:'Licorne royale',   emoji:'üëëü¶Ñ'},
    {min:200,  name:'Licorne l√©gendaire',emoji:'üåàü¶Ñ'}
  ];
  function guideInfo(){
    const coins=state.coins||0; let stage=GUIDE_STEPS[0];
    for(const s of GUIDE_STEPS){ if(coins>=s.min) stage=s; }
    const idx=GUIDE_STEPS.indexOf(stage);
    const next=GUIDE_STEPS[idx+1]?.min ?? stage.min;
    const base=stage.min; const span=Math.max(1,(next-base));
    const pct = Math.max(0, Math.min(100, Math.round(((coins-base)/span)*100)));
    return {stage:idx, name:stage.name, emoji:stage.emoji, next, base, pct};
  }
  const refreshHUD=()=>{
    $("#coins").textContent=state.coins; $("#lvl").textContent=state.level; $("#barProg").style.width=Math.round((state.progress.done/state.progress.total)*100)+"%";
    const av=$("#avatarEmoji"); if(av) av.textContent=avatarGlyph();
    const gi=guideInfo(); const uni=$("#uni"); if(uni){ uni.textContent=gi.emoji; uni.title=`${gi.name} ‚Äî prochaines: ${gi.next}ü™ô`; }
  };

  /* ----------- areas + subtopics (menu) ----------- */
  const AREAS=[
    {id:"ecole", icon:"üè´", title:"√âcole", sub:"Septiembre",
      subs:[
        {id:"sept", name:"Septiembre"}
      ]},
    {id:"fr",  icon:"üá´üá∑", title:"Fran√ßais", sub:"Lecture, vocabulaire, grammaire",
      subs:[{id:"lecture",name:"Lecture"},{id:"vocab",name:"Vocabulaire"},{id:"gram",name:"Grammaire"},
            {id:"ecrit",name:"Expression √©crite"},{id:"dialogue",name:"Dialogue oral"}]},
    {id:"nl", icon:"üá≥üá±", title:"N√©erlandais ‚Äî 2e primaire", sub:"Lecture (NL), nombres, salutations, couleurs",
      subs:[
        {id:"cloze",name:"üìñ Lecture (NL) ¬∑ Cloze"},
        {id:"getallen",name:"üî¢ Getallen (1‚Äì20)"},
        {id:"groeten",name:"üëã Groeten"},
        {id:"kleuren",name:"üé® Kleuren"},
        {id:"klas",name:"üè´ In de klas"}
      ]},
    {id:"math",icon:"üéØ", title:"Math√©matiques", sub:"",
      subs:[
        {id:"mag_add",name:"Additions"},
        {id:"mag_sub",name:"Soustractions"},
        {id:"mult",name:"Multiplications (tables 1‚Äì12)"},
        {id:"div",name:"Divisions simples (r√©partitions)"},
        {id:"eq",name:"√âquations simples (nombre manquant)"},
        {id:"ordre",name:"Ordre croissant/d√©croissant"},
        {id:"base10",name:"Unit√©s et dizaines (base 10)"},
        {id:"problemes",name:"Probl√®mes de la vie quotidienne"}
      ]},
    {id:"sciences", icon:"üåç", title:"Monde & Sciences", sub:"Saisons et m√©t√©o, famille et entourage, hygi√®ne et sant√©, alimentation √©quilibr√©e, corps",
      subs:[{id:"saisons",name:"Saisons et m√©t√©o."},{id:"famille",name:"Famille et entourage."},
            {id:"hygiene",name:"Hygi√®ne et sant√©."}, {id:"aliments",name:"Alimentation √©quilibr√©e."},
            {id:"corps",name:"Parties du corps."}]},
    {id:"arts", icon:"üé®", title:"Arts & couleurs", sub:"M√©langes, dessin",
      subs:[
        {id:"melanges",name:"M√©langes de couleurs"},
        {id:"dessin",name:"Dessin interactif"},
        {id:"coloriage",name:"Coloriage guid√©"}
      ]},
    {id:"num", icon:"üíª", title:"Culture num√©rique", sub:"Souris, ic√¥nes, s√©curit√©",
      subs:[{id:"icones",name:"Ic√¥nes"},{id:"souris",name:"Souris & clavier"},{id:"securite",name:"S√©curit√© Internet"}]},
    {id:"logique", icon:"üß©", title:"Jeux logiques", sub:"M√©moire, Sudoku, motifs",
      subs:[
        {id:"memo",name:"M√©moire"},
        {id:"rappel",name:"M√©moire ¬∑ Rappel"},
        {id:"sudoku",name:"Sudoku 4√ó4"},
        {id:"patterns",name:"S√©quences"}
      ]},
    {id:"contes", icon:"üìñ", title:"Contes", sub:"Histoires, √©nigmes, blagues, po√®mes",
      subs:[
        {id:"histoires",name:"Histoires magiques (20)"},
        {id:"enigmes",name:"√ânigmes"},
        {id:"blagues",name:"Blagues"},
        {id:"poemes",name:"Po√®mes"}
      ]},
    
    {id:"juegos", icon:"üéÆ", title:"Juegos", sub:"Puzzles rapides",
      subs:[
        {id:"hanoi",name:"Tower of Hanoi"},
        {id:"cherche",name:"Find & Match"},
        {id:"flows",name:"Robotic flows"},
        {id:"one",name:"Draw one line"},
        {id:"crime",name:"Crime scene"},
        {id:"missnum",name:"Missing number"},
        {id:"missop",name:"Missing op/number"},
        
      ]},
  ];

  function starRow(n){ // 0..3
    const full = "‚≠ê".repeat(n), empty = "‚≠ê".repeat(3-n);
    return `<div class="stars" aria-label="${n} √©toiles"><span class="s">${full||""}</span>${n<3?`<span class="s off">${empty}</span>`:""}</div>`;
  }

  function renderMenu(){
  const g=$("#grid"); g.innerHTML="";
  let idxReveal=0;
  AREAS.forEach(a=>{
      const keyArea = a.id+"|*";
      const starsArea = Math.max(0, ...a.subs.map(s=> state.stars[a.id+"|"+s.id]||0));
      const card=document.createElement("div"); card.className="card"; card.dataset.area=a.id;
      card.innerHTML=`
        
        <div class="cardHeader">
          <div class="icon">${a.icon}</div>
          <div>
            <div class="ctitle">${a.title}</div>
            
          </div>
        </div>
        <div class="bar"></div>
        <div class="subs"></div>
      `;
      const subs=card.querySelector(".subs");
      a.subs.forEach(s=>{
        const key=a.id+"|"+s.id; const st=state.stars[key]||0;
        const b=document.createElement("div"); b.className="sub"; b.dataset.sub=s.id;
        // Sin estrellas en los submen√∫s
        b.innerHTML = `<span>${s.name}</span>`;
        b.onclick=()=>{
          sparkleAt(innerWidth/2, 100, 10);
          if(a.id==='ecole' && s.id==='sept'){ openEcoleSeptMenu(a); return; }
          if(a.id==='logique' && s.id==='memo'){ openMemoMenu(a); return; }
          if(a.id==='logique' && s.id==='rappel'){ openRappelMenu(a); return; }
          if(a.id==='math' && s.id==='mult'){ openMultMenu(a); return; }
          if(a.id==='math' && s.id==='div'){ openDivMenu(a); return; }
          if(a.id==='math' && s.id==='mag_sub'){ openSoustrMenu(a); return; }
          state.area=a; state.sub=s; startBlock();
        };
        subs.appendChild(b);
      });
      // Los subtemas se muestran siempre; desactivamos el colapso por clic
      // card.querySelector(".cardHeader").onclick=()=>{ card.classList.toggle("collapsed"); };
      g.appendChild(card);
      // Reveal animation stagger
      try{ card.style.animationDelay = (idxReveal*0.06)+'s'; setTimeout(()=> card.classList.add('reveal'), 0); idxReveal++; }catch{}
    });
    // Hacer subtemas alcanzables por teclado
  $$('#grid .sub').forEach(el=>{ el.tabIndex=0; el.setAttribute('role','button'); });

  // Cycle des ic√¥nes (arc-en-ciel) ‚Äî change r√©guli√®rement l'emoji
  try{ startIconCycle(); }catch{}
}

  /* ----------- Stage flow ----------- */
  function pushView(v){ if(skipPush) return; const last=navStack[navStack.length-1]; if(last!==v) navStack.push(v); }
  function swapSections(fromSel, toSel, toDisplay){
    const from = document.querySelector(fromSel);
    const to = document.querySelector(toSel);
    if(!from || !to) return;
    // Prepare target
    to.style.display = toDisplay;
    to.classList.remove('xfade-enter'); void to.offsetWidth; to.classList.add('xfade-enter');
    // Animate out current if visible
    if(getComputedStyle(from).display!=='none'){
      from.classList.remove('xfade-leave'); void from.offsetWidth; from.classList.add('xfade-leave');
      const onEnd=()=>{ from.style.display='none'; from.classList.remove('xfade-leave'); from.removeEventListener('animationend', onEnd); };
      from.addEventListener('animationend', onEnd);
    }
  }
  function showHome(){ pilotStop(); swapSections('#stage','#home','block'); $("#breadcrumbs").textContent="Accueil"; renderMenu(); pushView('home'); }
  function showStage(){ pilotStop(); swapSections('#home','#stage','grid'); pushView('stage'); }
  function goBack(){
    if(navStack.length<=1) return;
    navStack.pop(); const prev=navStack[navStack.length-1];
    skipPush=true; if(prev==='home') showHome(); else showStage(); skipPush=false;
  }

  // Cycle d'ic√¥nes sur les cartes du menu (toutes les 4s)
  let iconTimer=null;
  const ICON_ALTS={
    ecole:["üè´","üìö","‚úèÔ∏è","üßÆ","üñçÔ∏è"],
    fr:["üá´üá∑","üìö","‚úçÔ∏è","üî§"], nl:["üá≥üá±","üìñ","üî¢","üëã"], math:["üéØ","‚ûó","‚úñÔ∏è","‚ûï","‚ûñ"],
    sciences:["üåç","üå¶Ô∏è","üë®‚Äçüë©‚Äçüëß","üßº","ü•ó","üß†"], arts:["üé®","üñçÔ∏è","üñºÔ∏è","üß©"], num:["üíª","üñ±Ô∏è","‚å®Ô∏è","üîí"],
    logique:["üß©","üß†","üî¢","üóÇÔ∏è"], contes:["üìñ","üßö","‚ú®","üìù"], juegos:["üéÆ","üß†","üïπÔ∏è"]
  };
  function startIconCycle(){
    clearInterval(iconTimer);
    const cards=Array.from(document.querySelectorAll('#grid .card'));
    const pos=new Map();
    iconTimer=setInterval(()=>{
      cards.forEach(c=>{
        const area=c.dataset.area; const list=ICONS(area);
        const i=(pos.get(c)||0)+1; pos.set(c,i);
        const iconEl=c.querySelector('.icon'); if(iconEl){ iconEl.textContent=list[i%list.length]; }
      });
    }, 6000);
    function ICONS(a){ return ICON_ALTS[a] || ['‚≠ê']; }
  }
  // Scale exercises per level (min 8 ‚Üí max 30 across totalLevels)
  function exercisesForLevel(L){
    const min=8, max=30;
    const tl=Math.max(1, (state.totalLevels||10));
    return clamp(min + Math.round((L-1)*((max-min)/(tl-1))), min, max);
  }
  function startBlock(){
    // Architecture de niveaux √©tendue: 20 niveaux, 8 ‚Üí 30 exos
    state.totalLevels = 20;
    state.progress.total = exercisesForLevel(state.level||1);
    state.progress.done=0; state.asked=new Set(); state.block={correct:0,wrong:0};
    state.blockStartCoins = state.coins;
    $("#barProg").style.width="0%";
    $("#breadcrumbs").textContent=`${state.area.title} ‚Ä∫ ${state.sub.name}`;
    // √âcole ‚Ä∫ Coloriage cod√©: initialiser l'√©tat de coloriage (sapin de No√´l)
    if(state.area?.id==='ecole' && state.sub?.id==='coloriage'){
      state.ecole = state.ecole || {};
      state.ecole.coloring = { shape: 'sapin', done: {} };
      save();
    }
    showStage();
    // D√©mo avant soustractions (sur demande)
    if(state.area?.id==='math' && state.sub?.id==='mag_sub'){
      try{ showSoustrDemo(); }catch{ nextQuestion(); }
    } else {
      nextQuestion();
    }
  }

  const engine={
    qcm(q){
      const hintDots = (q.meta && q.meta.dots) ? renderDots(q.meta.dots.rows, q.meta.dots.cols) : '';
      const hintText = (q.meta && q.meta.hint) ? `<div class="small">${q.meta.hint}</div>` : '';
      const banner = (q.meta && q.meta.svg) ? `<div class="svgWrap">${q.meta.svg}</div>` : '';
      const dirOverlay = (q.meta && q.meta.dir) ? `<div id="dirOverlay" class="small" style="display:none;text-align:center;font-weight:900;margin-top:6px"></div>` : '';
      $("#content").innerHTML=`<div class="prompt"><span class="spark">ü™Ñ</span>${q.text}</div>${banner}${dirOverlay}${hintDots}${hintText}<div class="options" id="opts" role="listbox" aria-label="Choix de r√©ponses"></div>`;
      const opts=$("#opts");
      q.options.forEach((op,i)=>{
        const el=document.createElement("div"); el.className="option"; el.dataset.idx=i; el.setAttribute('role','button'); el.tabIndex=0;
        const icon = op.icon? `<span style=\"font-size:18px;margin-right:8px\">${op.icon}</span>` : '';
        const isNum = /^\d+$/.test(String(op.label||''));
        const lab = isNum ? `<span class=\"numtxt\">${op.label}</span>` : `<span>${op.label}</span>`;
        el.innerHTML = `${op.color?`<span class=\"optColor\" style=\"background:${op.color}\"></span>`:""}${icon}${lab}`;
        // FX: option press feedback
        el.addEventListener('pointerdown', ()=>{ FX.pop(el); sfx.play('click'); });
        el.onclick=()=>{
          const ok = (i===q.correct);
          if(ok){ FX.glow(el); }
          else { FX.shake(el); }
          evaluate(ok,q,op.label,el);
          // SFX: small fanfare for special game (Hanoi)
          try{ if(ok && (q.id||'').startsWith('game-hanoi-')) sfx.play('fanfare'); }catch{}
        };
        opts.appendChild(el);
      });
      const items=$$("#opts .option"); if(items[0]) items[0].focus();
      opts.addEventListener("keydown", (ev)=>{
        const i=items.indexOf(document.activeElement);
        if(ev.key==="ArrowRight"||ev.key==="ArrowDown"){ ev.preventDefault(); const nx=items[clamp(i+1,0,items.length-1)]; nx?.focus(); }
        if(ev.key==="ArrowLeft"||ev.key==="ArrowUp"){ ev.preventDefault(); const px=items[clamp(i-1,0,items.length-1)]; px?.focus(); }
        if(ev.key==="Home"){ ev.preventDefault(); items[0]?.focus(); }
        if(ev.key==="End"){ ev.preventDefault(); items[items.length-1]?.focus(); }
      });
      bindNav(true);
      try{ pilotStart(q,'qcm'); }catch{}
    },
    tale(q){
      $("#content").innerHTML=`<div class="prompt"><span class="spark">üìñ</span>Conte magique</div>
        <div class="tale" id="tale">
          <div id="taleBody"></div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
            <button id="newTale" class="btn g">Nouvelle histoire</button>
          </div>
        </div>`;
      const render=(paras)=>{ $("#taleBody").innerHTML = paras.map(p=>`<p>${p}</p>`).join(""); };
      render(q.paras);
      $("#newTale").onclick=()=>{ const nxt=q.regen? q.regen() : q.paras; render(nxt); };
      bindNav(true);
    },
    // Maisons des nombres ‚Äî version saisie (1 maison par exercice, 1 case d√©j√† remplie)
    houses(q){
      const lvlConf=(L)=>{ if(L<=3) return {min:5,max:10,floors:2}; if(L<=6) return {min:8,max:14,floors:3}; if(L<=9) return {min:10,max:16,floors:3}; return {min:12,max:20,floors:4}; };
      const pickN=()=>{ const {min,max}=lvlConf(state.level||1); return rnd(min,max); };
      const makeRows=(N,floors)=>{
        const rows=[]; for(let i=0;i<floors;i++){ let a,b,tries=0; do{ a=rnd(1,Math.min(19,N-1)); b=N-a; tries++; if(tries>100) break; } while(b<1||b>20); const preLeft=Math.random()<0.5; rows.push({N,a,b,preLeft}); } return rows;
      };
      const render=(N=(q?.meta?.nums?.[0] ?? pickN()))=>{
        const {floors}=lvlConf(state.level||1); const rows=makeRows(N,floors);
        const head = `<div class="prompt"><span class="spark">üè†</span>Les maisons des nombres ‚Äî √©cris le nombre manquant pour faire le total.</div>`;
        $("#content").innerHTML = head + `<div class="housesWrap" id="houses"></div>`;
        const wrap=$("#houses"); const card=document.createElement('div'); card.className='houseCard';
        card.innerHTML = `<div class="houseHead"><div class="roofTag">Maison du ${N}</div><div style="font-weight:900">üòä</div></div>`;
        rows.forEach((r,i)=>{
          const row=document.createElement('div'); row.className='floorRow'; row.dataset.n=String(r.N); row.dataset.done='0';
          const aEl=document.createElement('input'); aEl.type='number'; aEl.min='0'; aEl.max='20'; aEl.inputMode='numeric'; aEl.setAttribute('aria-label',`Case gauche maison ${N}, √©tage ${i+1}`);
          const bEl=document.createElement('input'); bEl.type='number'; bEl.min='0'; bEl.max='20'; bEl.inputMode='numeric'; bEl.setAttribute('aria-label',`Case droite maison ${N}, √©tage ${i+1}`);
          const hint=document.createElement('div'); hint.className='hint';
          if(r.preLeft){ aEl.value=String(r.a); aEl.disabled=true; aEl.setAttribute('aria-disabled','true'); } else { bEl.value=String(r.b); bEl.disabled=true; bEl.setAttribute('aria-disabled','true'); }
          row.appendChild(aEl); row.appendChild(bEl); row.appendChild(hint); card.appendChild(row);
        });
        wrap.appendChild(card);
        const checkRow=(row)=>{ if(row.dataset.done==='1') return; const N=+row.dataset.n; const [aEl,bEl]=row.querySelectorAll('input'); const hint=row.querySelector('.hint'); const a=parseInt(aEl.value,10), b=parseInt(bEl.value,10);
          if(Number.isFinite(a)&&Number.isFinite(b)){ if(a+b===N){ row.dataset.done='1'; row.classList.remove('err'); row.classList.add('ok'); aEl.disabled=bEl.disabled=true; aEl.setAttribute('aria-disabled','true'); bEl.setAttribute('aria-disabled','true'); const r=aEl.getBoundingClientRect(); sparkleAt(r.left + r.width/2, r.top, 8); audio.ok(); win(1); showToast('Bravo ! +1 ü¶Ñüí∞'); hint.textContent=`Youpi ! ${a} + ${b} = ${N} ‚ú®`; const allDone=$$(".floorRow").every(rr=> rr.dataset.done==='1'); if(allDone){ fx.spawn(); evaluate(true,{type:'houses',text:`Maison du ${N}`},`${N}`); } } else { row.classList.remove('ok'); row.classList.add('err'); audio.no(); const fixedLeft=aEl.disabled; const base=fixedLeft?(+aEl.value||0):(+bEl.value||0); hint.textContent=`Indice : Cherche l‚Äôami de ${base} pour faire ${N}.`; } } else { row.classList.remove('err'); hint.textContent=''; } };
        $$(".floorRow").forEach(r=>{ const [aEl,bEl]=r.querySelectorAll('input'); const onchg=()=>checkRow(r); aEl.addEventListener('input', onchg); bEl.addEventListener('input', onchg); });
        $("#btnCheck").style.display='none'; const skip=$("#btnSkip"); skip.style.display='inline-flex'; skip.textContent='Nouveau'; skip.onclick=()=>{ render(pickN()); }; $("#btnPrev").style.display='inline-flex'; $("#btnPrev").onclick=goBack;
      };
      render();
    },
    // Busca elementos (por ejemplo, fantasmas)
    find(q){
      $("#content").innerHTML=`<div class="prompt">${q.text}</div><div class="small" id="foundStat" aria-live="polite">Trouv√©s : <b>0/${q.need}</b></div><div class="rappelGrid" id="fgrid"></div>`;
      const grid=$("#fgrid");
      q.grid.forEach(cell=>{
        const el=document.createElement('div'); el.className='rappelTile'; el.textContent=cell.e;
        el.dataset.kind=cell.k; grid.appendChild(el);
      });
      let found=0; const need=q.need; const stat=()=>{ const fs=$("#foundStat"); if(fs){ fs.innerHTML=`Trouv√©s : <b>${found}/${need}</b>`; FX.use(fs,'fx-slide-up'); } };
      grid.onclick=e=>{
        const el=e.target.closest('.rappelTile'); if(!el) return;
        if(el.classList.contains('done')) return;
        const k=el.dataset.kind;
        if(k==='target'){
          el.classList.add('done'); FX.pop(el); FX.glow(el); found++; stat();
          audio.ok();
          if(found>=need){ evaluate(true,q,`found ${found}`); }
        } else {
          FX.shake(el); el.classList.add('wrongflash'); setTimeout(()=>el.classList.remove('wrongflash'),250); evaluate(false,q,'wrong click');
        }
      };
      // Hint button (ping target)
      try{
        const hintBtn=document.createElement('button'); hintBtn.className='btn g'; hintBtn.textContent='üí° Indice'; hintBtn.style.marginTop='8px';
        hintBtn.onclick=()=>{
          const t=[...document.querySelectorAll('#fgrid .rappelTile')].find(n=>n.dataset.kind==='target' && !n.classList.contains('done'));
          if(t){ FX.pop(t); setTimeout(()=>FX.pop(t), 320); }
        };
        $("#content").appendChild(hintBtn);
      }catch{}
      $("#btnCheck").style.display='none'; $("#btnSkip").style.display='inline-flex';
      bindNav(false);
    },
    // Encontrar dos √≠tems id√©nticos
    findpair(q){
      $("#content").innerHTML=`<div class="prompt">${q.text}</div><div class="rappelGrid" id="pgrid"></div>`;
      const grid=$("#pgrid");
      q.items.forEach((e,i)=>{ const el=document.createElement('div'); el.className='rappelTile'; el.textContent=e; el.dataset.v=e; grid.appendChild(el); });
      let sel=[];
      grid.onclick=e=>{
        const el=e.target.closest('.rappelTile'); if(!el) return;
        if(el.classList.contains('done')) return;
        el.classList.add('done'); FX.pop(el); sel.push(el.dataset.v);
        if(sel.length===2){ if(sel[0]===sel[1] && sel[0]===q.target){ evaluate(true,q,sel.join(',')); } else { evaluate(false,q,sel.join(',')); } }
      };
      $("#btnCheck").style.display='none'; $("#btnSkip").style.display='inline-flex';
      bindNav(false);
    },
    input(q){
      const banner = (q.meta && q.meta.svg) ? `<div class="svgWrap">${q.meta.svg}</div>` : '';
      const hintText = (q.meta && q.meta.hint) ? `<div class="small">${q.meta.hint}</div>` : '';
      // Legend for Coloriage cod√©
      let legend = '';
      if(state.area?.id==='ecole' && state.sub?.id==='coloriage' && q?.meta?.col){
        const doneMap = (state.ecole && state.ecole.coloring && state.ecole.coloring.done) || {};
        const done = Object.keys(doneMap).length;
        const total = 10;
        const shape = (state.ecole && state.ecole.coloring && state.ecole.coloring.shape) || 'sapin';
        const emoji = shape==='licorne'?'ü¶Ñ':(shape==='dragon'?'üêâ':(shape==='sapin'?'üéÑ':'üíñ'));
        legend = `<div class="colorLegend">
          <div class="chip badge">${emoji} Coloriage</div>
          <div class="chip">Progr√®s: <b>${done}/${total}</b></div>
          <div class="chip"><span class="colorDot" style="background:${q.meta.col.hex}"></span>Couleur: <b>${q.meta.col.name}</b></div>
        </div>`;
      }
      const speakBtn = (q.meta && q.meta.speakText) ? `<button id="btnSpeak" class="btn g" style="margin-top:8px">üîà Lire</button>` : '';
      $("#content").innerHTML=`<div class="prompt">‚úçÔ∏è ${q.text}</div>${legend}${banner}${hintText}
        <div class="answerBox"><input id="ans" type="${q.kind||'text'}" placeholder="${q.placeholder||'Ta r√©ponse'}"/></div>${speakBtn}`;
      $("#ans").focus();
      $("#ans").addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ $("#btnCheck").click(); }});
      $("#btnCheck").onclick=()=>{ const v=$("#ans").value; const ok=q.check(v); evaluate(ok,q,v); };
      if(q.meta && q.meta.speakText && $("#btnSpeak")){
        $("#btnSpeak").onclick=()=>{ try{ audioCtxResume && audioCtxResume(); }catch{}; tts.speak(q.meta.speakText); };
      }
      // magic twinkles for this exercise
      if(q.meta && q.meta.magic==='twinkle'){
        try{ const r=document.getElementById('content').getBoundingClientRect(); for(let i=0;i<6;i++){ sparkleAt(r.left + Math.random()*r.width, r.top + 30 + Math.random()*60, 6); } }catch{}
      }
      bindNav(true);
      try{ pilotStart(q,'input'); }catch{}
    },
    order(q){
      const banner = (q.meta && q.meta.svg) ? `<div class="svgWrap">${q.meta.svg}</div>` : '';
      const helper = (q.meta && q.meta.sumHelp) ? `<div id="sumBox" class="small" style="margin-top:8px;font-weight:900"></div><div id="sumDots"></div>` : '';
      $("#content").innerHTML=`<div class="prompt">üî¢ ${q.text}</div>${banner}
        <div class="chips" id="pool"></div>
        <div class="small">Place dans la bo√Æte :</div>
        <div class="dropzone" id="drop"></div>
        ${helper}`;
      const pool=$("#pool"), drop=$("#drop");
      q.items.forEach((it,i)=>{const c=document.createElement("div"); c.className="draggable"; if(/^\d+$/.test(String(it))) c.classList.add('numchip'); c.textContent=it; c.draggable=true; c.addEventListener("dragstart",e=>{e.dataTransfer.setData("text/plain",it); FX.pop(c); sfx.play('move');}); pool.appendChild(c);});
      const updateSum=()=>{
        if(!(q.meta && q.meta.sumHelp)) return;
        const sumBox=document.getElementById('sumBox'); const dotsWrap=document.getElementById('sumDots');
        const nums=[...drop.children].map(x=>parseInt(x.textContent,10)).filter(n=>!isNaN(n)).slice(0,2);
        const a=nums[0]||0, b=nums[1]||0, s=a+b; const tgt=q.meta?.target;
        if(sumBox){ sumBox.textContent = `üß±üè† Somme: ${a} + ${b} = ${s} ${tgt!=null?`/ objectif ${tgt}`:''}`; sumBox.classList.remove('pulse'); void sumBox.offsetWidth; sumBox.classList.add('pulse'); }
        if(dotsWrap){
          const mk=(n)=>'<div class="dotRow">'+Array.from({length:Math.max(0,Math.min(20,n))}).map(()=>'<span class="dot"></span>').join('')+'</div>';
          dotsWrap.innerHTML = `<div class="dotsWrap">${mk(a)}${mk(b)}</div>`;
        }
      };
      [pool,drop].forEach(z=>{
        z.addEventListener("dragover",e=>e.preventDefault());
        z.addEventListener("drop",e=>{
          e.preventDefault();
          const t=e.dataTransfer.getData("text/plain");
          const from=[pool,drop].find(zz=>[...zz.children].some(x=>x.textContent===t));
          const node=[...from.children].find(x=>x.textContent===t);
          if(node&&z!==from) { z.appendChild(node); FX.glow(z); sfx.play('click'); updateSum(); }
        });
      });
      // Initial helper render
      try{ updateSum(); }catch{}
      $("#btnCheck").onclick=()=>{
        // FX: Robotic flows execution highlight (game only)
        try{
          if((q.id||'').startsWith('game-flows-')){
            const seq=[...drop.children]; let t=0; seq.forEach((n,idx)=>{ setTimeout(()=>{ FX.glow(n); sfx.play('trail'); }, t); t+=160; });
          }
        }catch{}
        const arr=[...drop.children].map(x=>x.textContent); const ok=q.check(arr); if(!ok){ FX.shake(drop); }
        evaluate(ok,q,arr.join(", "));
      };
      bindNav(true);
      try{ pilotStart(q,'order'); }catch{}
    },
    memory(q){
      $("#content").innerHTML=`<div class="prompt">üß† ${q.text}</div><div class="memoryGrid" id="mem"></div>`;
      const grid=$("#mem"); let first=null, lock=false, pairs=0;
      q.deck.forEach(card=>{
        const el=document.createElement("div"); el.className="cardMem"; el.dataset.val=card.v;
        el.innerHTML=`<div class="front">üé¥</div><div class="back">${card.e}</div>`;
        el.onclick=()=>{
          if(lock || el.classList.contains("done")) return;
          el.classList.add("flipped"); sfx.play('flip');
          if(!first){ first=el; return; }
          lock=true; setTimeout(()=>{
            if(first.dataset.val===el.dataset.val){
              first.classList.add("done","pairGood"); el.classList.add("done","pairGood"); FX.pop(first); FX.pop(el); FX.glow(first); FX.glow(el); pairs++; audio.ok();
              if(pairs===q.pairs){ evaluate(true,q,"M√©moire OK"); }
            } else { first.classList.remove("flipped"); el.classList.remove("flipped"); audio.no(); }
            first=null; lock=false;
          }, 420);
        };
        grid.appendChild(el);
      });
      bindNav(false);
    },
    // Spatial relations: drag the mouse to the correct position relative to the house
    spatial(q){
      const norm=k=> (k==='√† l‚Äôint√©rieur'? 'dans' : k);
      const target = norm(q.target);
      const banner = `<div class="svgWrap">${spatialSceneSVG()}</div>`;
      $("#content").innerHTML = `<div class="prompt">üê≠ ${q.text}</div>${banner}
        <div class="spatialWrap" id="sp">
          <!-- zones -->
          <div class="zone" data-pos="dans"    style="left:300px; top:120px; width:120px; height:120px" title="dans"></div>
          <div class="zone" data-pos="sur"     style="left:330px; top:84px;  width:60px;  height:30px"  title="sur"></div>
          <div class="zone" data-pos="sous"    style="left:320px; top:244px; width:80px;  height:30px"  title="sous"></div>
          <div class="zone" data-pos="devant"  style="left:290px; top:280px; width:140px; height:40px" title="devant"></div>
          <div class="zone" data-pos="derri√®re"style="left:300px; top:40px;  width:120px; height:30px"  title="derri√®re"></div>
          <div class="zone" data-pos="√† gauche"style="left:220px; top:160px; width:60px;  height:80px"  title="√† gauche"></div>
          <div class="zone" data-pos="√† droite"style="left:440px; top:160px; width:60px;  height:80px"  title="√† droite"></div>
          <div class="zone" data-pos="entre"   style="left:140px; top:260px; width:40px;  height:40px"  title="entre deux chaises"></div>
          <div class="zone" data-pos="contre"  style="left:620px; top:120px; width:20px;  height:140px" title="contre le mur"></div>
          <div id="mouse" class="spatialMouse" style="left:60px; top:60px">üê≠</div>
        </div>
        <div id="posStatus" class="small">Position : <b>‚Äî</b></div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnDemoSpatial" class="btn g">üé¨ D√©mo</button>
        </div>`;

      const wrap = document.getElementById('sp');
      const mouse = document.getElementById('mouse');
      const zones = Array.from(wrap.querySelectorAll('.zone'));
      const status = document.getElementById('posStatus');
      let dragging=false, offset=[0,0], active=null;
      function setStatus(label){ if(status){ status.innerHTML = `Position : <b>${label||'‚Äî'}</b>`; } }
      function findZoneAt(cx,cy){
        active=null; zones.forEach(z=> z.classList.remove('sel'));
        for(const z of zones){ const r=z.getBoundingClientRect(); const wr=wrap.getBoundingClientRect();
          const x=wr.left, y=wr.top; const inside = cx>=r.left && cx<=r.right && cy>=r.top && cy<=r.bottom;
          if(inside){ active=z; z.classList.add('sel'); setStatus(z.dataset.pos); break; }
        }
        if(!active) setStatus('‚Äî');
      }
      function onMove(ev){ if(!dragging) return; const wr=wrap.getBoundingClientRect(); const mx=(ev.touches?ev.touches[0].clientX:ev.clientX) - wr.left - offset[0]; const my=(ev.touches?ev.touches[0].clientY:ev.clientY) - wr.top - offset[1];
        const x=Math.max(0, Math.min(wr.width-40, mx)); const y=Math.max(0, Math.min(wr.height-40, my));
        mouse.style.left = x+"px"; mouse.style.top = y+"px";
        const cx=(ev.touches?ev.touches[0].clientX:ev.clientX), cy=(ev.touches?ev.touches[0].clientY:ev.clientY);
        findZoneAt(cx,cy);
      }
      function onUp(){ if(!dragging) return; dragging=false; mouse.classList.remove('drag');
        if(active){ const pos = active.dataset.pos; const ok = norm(pos)===target; evaluate(ok,q,pos); }
      }
      mouse.addEventListener('pointerdown', ev=>{ dragging=true; mouse.classList.add('drag'); const r=mouse.getBoundingClientRect(); offset=[ev.clientX-r.left, ev.clientY-r.top]; mouse.setPointerCapture(ev.pointerId);});
      mouse.addEventListener('pointermove', onMove);
      mouse.addEventListener('pointerup', onUp);
      // touch support
      mouse.addEventListener('touchstart', ev=>{ dragging=true; mouse.classList.add('drag'); const r=mouse.getBoundingClientRect(); const t=ev.touches[0]; offset=[t.clientX-r.left, t.clientY-r.top]; ev.preventDefault();},{passive:false});
      mouse.addEventListener('touchmove', onMove, {passive:false});
      mouse.addEventListener('touchend', onUp);
      // Demo animation to guide the user
      function runDemo(){
        try{
          const tz = zones.find(z=> norm(z.dataset.pos)===target);
          const wr = wrap.getBoundingClientRect(); const mz = mouse.getBoundingClientRect();
          if(!tz) return; const tr = tz.getBoundingClientRect();
          const cx = tr.left + tr.width/2 - wr.left; const cy = tr.top + tr.height/2 - wr.top;
          zones.forEach(z=>z.classList.remove('sel')); tz.classList.add('sel'); setStatus(tz.dataset.pos);
          mouse.style.left = Math.max(0, Math.min(wr.width-40, cx-18)) + 'px';
          mouse.style.top  = Math.max(0, Math.min(wr.height-40, cy-18)) + 'px';
          setTimeout(()=>{
            tz.classList.remove('sel'); setStatus('‚Äî');
            mouse.style.left = '60px'; mouse.style.top = '60px';
          }, 1100);
        }catch{}
      }
      document.getElementById('btnDemoSpatial').onclick = runDemo;

      // Hide check, this is direct feedback
      $("#btnCheck").style.display='none'; $("#btnSkip").style.display='inline-flex';
      bindNav(false);

      // Auto-run a quick demo on first show
      setTimeout(runDemo, 500);
    },
    rappel(q){
      $("#content").innerHTML=`<div class="prompt">üëÄ Regarde les nombres puis touche-les dans l‚Äôordre croissant.</div><div class="rappelGrid" id="rgrid"></div>`;
      const grid=$("#rgrid");
      const tiles = shuffle(q.nums.map(v=>({v})));
      tiles.forEach(t=>{ const el=document.createElement('div'); el.className='rappelTile show'; el.textContent=t.v; el.dataset.v=t.v; grid.appendChild(el); });
      // Oculta n√∫meros despu√©s de viewMs
      setTimeout(()=>{ $$(".rappelTile").forEach(el=>{ el.classList.remove('show'); el.textContent='?'; }); startClicks(); }, q.viewMs);
      let expected=[...q.nums].sort((a,b)=>a-b), idx=0;
      function startClicks(){
        $$(".rappelTile").forEach(el=>{
          el.onclick=()=>{
            const val=+el.dataset.v;
            if(el.classList.contains('done')) return;
            if(val===expected[idx]){ el.textContent=val; el.classList.add('done'); idx++; audio.ok(); if(idx===expected.length){ evaluate(true,q,'rappel'); } }
            else { el.classList.add('wrongflash'); setTimeout(()=>el.classList.remove('wrongflash'),250); audio.no(); evaluate(false,q,`attendu ${expected[idx]}`); }
          };
        });
      }
      $("#btnCheck").style.display='none';
      $("#btnSkip").style.display='inline-flex';
      bindNav(false);
    },
    sudoku(q){
      $("#content").innerHTML=`<div class="prompt">üßÆ Sudoku 4√ó4 ‚Äî compl√®te (1‚Äì4)</div>
        <div class="sudoku" id="sudoku"></div>
        <div style="margin-top:8px"><button class="btn g" id="btnClear">Effacer</button></div>`;
      const wrap=$("#sudoku");
      q.grid.forEach((v,i)=>{
        const inp=document.createElement("input"); inp.maxLength=1;
        if(v){ inp.value=v; inp.disabled=true; inp.className="fixed"; }
        inp.oninput=()=>{ inp.value=inp.value.replace(/[^1-4]/g,''); };
        wrap.appendChild(inp);
      });
      $("#btnClear").onclick=()=> $$("#sudoku input:not(.fixed)").forEach(i=>i.value="");
      $("#btnCheck").onclick=()=>{ const vals=$$("#sudoku input").map(i=>+i.value||0); const ok=q.check(vals); evaluate(ok,q,"Grille"); };
      bindNav(true);
    },
    // Technique de la saucisse (interactive, 2 √©tapes guid√©es)
    sausage(q){
      // Parse expression "a + b" or "a ‚àí b"
      const m = q.expr.match(/\s*(\d+)\s*([+‚àí-])\s*(\d+)\s*/);
      if(!m){ engine.input({text:q.text, kind:'number', placeholder:'R√©ponse', check:v=>String(v)==String(q.ans)}); return; }
      const a=+m[1]; const rawOp=m[2]; const op = rawOp==='-'?'‚àí':rawOp; const b=+m[3];
      const isAdd = op==='+'; const step1 = isAdd ? Math.max(0, 10 - a) : Math.max(0, a - 10);
      const rem = Math.max(0, b - step1);
      let phase = 0; // 0 start @a, 1 after jump to 10, 2 finished
      const render = ()=>{
        const line = sausageSVG(a,b,op,phase);
        $("#content").innerHTML = `<div class="prompt">üå≠ Technique de la saucisse ‚Äî ${a} ${op} ${b}</div>
          <div class="svgWrap">${line}</div>
          <div class="stepBox">
            <span class="tag">Etape 1: ${isAdd?`aller √† 10 (+${step1})`:`aller √† 10 (‚àí${step1})`}</span>
            <span class="tag">Etape 2: ${isAdd?`puis +${rem}`:`puis ‚àí${rem}`}</span>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnS1" class="btn g">${isAdd?`Aller √† 10 (+${step1})`:`Aller √† 10 (‚àí${step1})`}</button>
            <button id="btnS2" class="btn p" ${phase<1? 'disabled':''}>${isAdd?`Puis +${rem}`:`Puis ‚àí${rem}`}</button>
          </div>`;
        const b1 = $("#btnS1"), b2=$("#btnS2");
        if(phase>=1){ b1.disabled=true; }
        b1.onclick=()=>{ phase=1; render(); };
        b2.onclick=()=>{ if(phase<1) return; phase=2; const ans = isAdd? a+b : a-b; showToast(`R√©sultat: ${ans}`); evaluate(true,q,ans); };
      };
      render();
      $("#btnCheck").style.display='none'; $("#btnSkip").style.display='inline-flex';
      bindNav(false);
    },
    drawing(q){
      $("#content").innerHTML=`<div class=\"prompt\">üé® ${q.text}</div>
        <div id=\"drawWrap\"> 
          <canvas id=\"canvas\" width=\"800\" height=\"480\" aria-label=\"Zone de dessin\"></canvas>
          <div>
            ${q.bgSvg?'<div id="refWrap"><div class="small">R√©f√©rence</div><img id="refImg" alt="R√©f√©rence"/></div>':''}
            ${q.instructions?'<div id="instructions">Consignes :</div><ul id="instrList" class="small" style="margin:0 0 8px 18px;padding:0"></ul>':''}
            <div style=\"font-weight:900\">Palette</div>
            <div id=\"palette\"></div>
            <div style=\"margin-top:10px\">√âpaisseur : <input type=\"range\" id=\"thick\" min=\"2\" max=\"24\" value=\"8\"/></div>
            <div style=\"margin-top:10px;display:flex;gap:8px;flex-wrap:wrap\">
              <button id=\"clearCanvas\" class=\"btn g\">Effacer</button>
              <button id=\"validateDrawing\" class=\"btn s\">J'ai fini</button>
            </div>
          </div>
        </div>`;
      const defaultColors=["#000","#f43f5e","#f59e0b","#22c55e","#3b82f6","#a855f7","#ff99c8","#a9def9","#caffbf"];
      const colors = Array.isArray(q.allowedColors)&&q.allowedColors.length? q.allowedColors : defaultColors;
      const required = Array.isArray(q.requiredColors)? q.requiredColors : null;
      const pal=$("#palette");
      const canvas=$("#canvas"), ctx=canvas.getContext("2d");
      // Fond guid√© (SVG) optionnel
      if(q.bgSvg){
        try{
          const img=new Image();
          const dataURI='data:image/svg+xml;utf8,'+encodeURIComponent(q.bgSvg);
          img.onload=()=>{ ctx.save(); ctx.globalAlpha=0.9; ctx.drawImage(img,0,0,canvas.width,canvas.height); ctx.restore(); const ref=$("#refImg"); if(ref) ref.src=dataURI; };
          img.src=dataURI;
        }catch{}
      }
      // Instructions
      if(q.instructions && Array.isArray(q.instructions)){
        const ul=$("#instrList"); if(ul) ul.innerHTML = q.instructions.map(t=>`<li>${t}</li>`).join('');
      }
      // Outils dessin
      ctx.lineCap="round"; ctx.lineJoin="round"; ctx.strokeStyle=colors[0]; ctx.lineWidth=8;
      colors.forEach((c,i)=>{const sw=document.createElement("div"); sw.className="sw"; sw.style.background=c; if(i===0) sw.classList.add("sel"); sw.title=c; sw.onclick=()=>{ $$("#palette .sw").forEach(x=>x.classList.remove("sel")); sw.classList.add("sel"); ctx.strokeStyle=c; }; pal.appendChild(sw);});
      let drawing=false, moves=0, used=new Set([colors[0]]), last=[0,0];
      const pos=e=>{const r=canvas.getBoundingClientRect(); const sx=canvas.width/Math.max(1,r.width), sy=canvas.height/Math.max(1,r.height); const cx=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const cy=(e.touches?e.touches[0].clientY:e.clientY)-r.top; return [cx*sx, cy*sy];};
      let trailPlayed=false;
      const start=e=>{drawing=true; last=pos(e); if(!trailPlayed){ sfx.play('trail'); trailPlayed=true; setTimeout(()=>trailPlayed=false, 800); } };
      const draw=e=>{ if(!drawing) return; const [x,y]=pos(e); ctx.save(); ctx.shadowBlur=6; ctx.shadowColor=ctx.strokeStyle; ctx.beginPath(); ctx.moveTo(...last); ctx.lineTo(x,y); ctx.stroke(); ctx.restore(); last=[x,y]; moves++; used.add(ctx.strokeStyle); };
      const end=()=>{drawing=false;};
      canvas.addEventListener("mousedown",start); addEventListener("mouseup",end); canvas.addEventListener("mousemove",draw);
      canvas.addEventListener("touchstart",e=>{start(e); e.preventDefault();},{passive:false});
      canvas.addEventListener("touchmove",e=>{draw(e); e.preventDefault();},{passive:false});
      canvas.addEventListener("touchend",end);
      $("#thick").oninput=e=> ctx.lineWidth=+e.target.value;
      $("#clearCanvas").onclick=()=>{ctx.clearRect(0,0,canvas.width,canvas.height); moves=0; used=new Set(); if(q.bgSvg){ try{ const img=new Image(); const dataURI='data:image/svg+xml;utf8,'+encodeURIComponent(q.bgSvg); img.onload=()=>{ ctx.save(); ctx.globalAlpha=0.9; ctx.drawImage(img,0,0,canvas.width,canvas.height); ctx.restore(); }; img.src=dataURI; }catch{} }};
      $("#validateDrawing").onclick=()=>{
        let ok;
        if(required && required.length){ ok = moves>180 && required.every(c=> used.has(c)); }
        else { ok = moves>250 && used.size>=3; }
        if(ok){ try{ FX.glow($("#canvas")); }catch{} }
        evaluate(ok,q,"dessin");
      };
      bindNav(true);
    },
    flash(cards){
      $("#home").style.display="none"; $("#stage").style.display="grid";
      $("#breadcrumbs").textContent="R√©vision rapide";
      $("#content").innerHTML=`<div class="prompt"><span class="spark">‚ö°</span>R√©vision rapide ‚Äî clique pour r√©v√©ler</div><div class="cards" id="fc"></div>`;
      const wrap=$("#fc"); let revealed=0;
      cards.forEach(c=>{
        const el=document.createElement("div"); el.className="flash"; el.innerHTML=`<div class="q">${c.q}</div><div class="a">${c.a}</div>`;
        el.onclick=()=>{
          const adding = !el.classList.contains("show");
          el.classList.toggle("show");
          revealed += adding ? 1 : -1;
          if(revealed>=cards.length){ showToast('Nouveau set üîÅ'); setTimeout(()=> openFlashcards(), 900); }
        };
        wrap.appendChild(el);
      });
      $("#btnCheck").style.display="none"; $("#btnSkip").style.display="inline-flex"; $("#btnPrev").style.display="inline-flex";
      $("#btnPrev").onclick=showHome; $("#btnSkip").onclick=showHome;
    }
  };

  function bindNav(checkable){
    $("#btnCheck").style.display=checkable?"inline-flex":"none";
    $("#btnPrev").onclick=goBack;
    $("#btnSkip").onclick=()=>{ state.progress.done++; refreshHUD(); nextQuestion(); };
  }

  function nextQuestion(){
    pilotStop();
    state.currentWrong = 0;
    if(state.progress.done>=state.progress.total){ endOfBlock(); return; }
    // Breaks removed
    let q, tries=0;
    do {
      q = makeQuestion(state.area.id, state.sub.id);
      tries++;
      if(tries>150){
        // Pool de questions uniques √©puis√©e pour ce th√®me/niveau
        try{
          showToast('Plus de questions uniques disponibles');
          endOfBlock();
        }catch{ endOfBlock(); }
        return;
      }
    } while(state.asked.has(q.id));
    // Adaptation de difficult√© (6 niveaux, 3 questions courtes)
    const adapt=(qq)=>{
      try{
        const L=state.level||1;
        if(qq.type==='qcm' && Array.isArray(qq.options) && typeof qq.correct==='number'){
          const max=qq.options.length;
          const want = Math.max(2, Math.min(max, L<=2?2 : (L===3?3 : (L>=5?Math.min(4,max):3))));
          const correct = qq.options[qq.correct];
          const others = qq.options.filter((_,i)=> i!==qq.correct);
          const picked = shuffle(others).slice(0, Math.max(0, want-1));
          const merged = shuffle([correct, ...picked]);
          qq.options = merged;
          qq.correct = merged.findIndex(o=> (o.label??'')===(correct.label??''));
          if(L<=2 && qq.explain){ qq.meta=qq.meta||{}; qq.meta.hint = qq.meta.hint || qq.explain; }
        }
        if(qq.type==='input' && (state.area?.id!=='arts')){
          if(L<=2 && qq.explain){ qq.meta=qq.meta||{}; qq.meta.hint = qq.meta.hint || qq.explain; }
        }
      }catch{}
      return qq;
    };
    q = adapt(q);
    state.asked.add(q.id); state.current=q;
    if(q.type==="qcm") engine.qcm(q);
    else if(q.type==="input") engine.input(q);
    else if(q.type==="order") engine.order(q);
    else if(q.type==="memory") engine.memory(q);
    else if(q.type==="sudoku") engine.sudoku(q);
    else if(q.type==="drawing") engine.drawing(q);
    else if(q.type==="rappel") engine.rappel(q);
    else if(q.type==="tale") engine.tale(q);
    else if(q.type==="houses") engine.houses(q);
    else engine.qcm(q);
    refreshHUD();
  }

  // D√©monstration guid√©e pour la soustraction pos√©e (avant de commencer)
  function showSoustrDemo(){
    const a=48, b=9; // D√©mo demand√©e : 48 ‚àí 9
    const svg = posedSubSVG(a,b);
    // Explication douce fa√ßon CP/CE1
    const demoHtml = `
      <div style="font-weight:900; font-size:18px; line-height:1.6">
        48 ‚àí 9 = ?<br>
        ‚úÇÔ∏è D√©compose :<br>
        48 = <b>40</b> + <b>8</b><br>
        9 = <b>8</b> + <b>1</b><br><br>
        ‚ûú <b>8 ‚àí 8 = 0</b> üéâ (ils s‚Äôannulent)<br>
        ‚ûú Il reste <b>40 ‚àí 1 = 39</b><br><br>
        ‚úÖ R√©sultat : <b>48 ‚àí 9 = 39</b><br>
        Bravo, tu as r√©ussi ! üåü
      </div>`;
    $("#content").innerHTML = `
      <div class="prompt">‚ú® D√©mo ‚Äî Soustraction pos√©e (48 ‚àí 9)</div>
      <div class="svgWrap">${svg}</div>
      <div class="tale" style="margin-top:6px">${demoHtml}</div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="soustrSpeak" class="btn g">üîà Lire l‚Äôexplication</button>
        <button id="soustrStart" class="btn s">J‚Äôai compris, commencer</button>
      </div>`;
    const speak=`Quarante-huit moins neuf. On d√©coupe: quarante-huit, c‚Äôest quarante plus huit. Neuf, c‚Äôest huit plus un. On fait huit moins huit, cela fait z√©ro. Il reste quarante moins un, cela fait trente-neuf. Le r√©sultat est trente-neuf.`;
    $("#soustrSpeak").onclick = ()=> { try{ audioCtxResume && audioCtxResume(); }catch{} tts.speak(speak); };
    $("#soustrStart").onclick = ()=> { nextQuestion(); };
    $("#btnCheck").style.display='none';
    $("#btnSkip").style.display='none';
    $("#btnPrev").style.display='inline-flex';
    $("#btnPrev").onclick=goBack;
  }

  function evaluate(ok,q,userAns,el){
    pilotStop();
    if(ok){
      state.currentWrong = 0;
      // Coloriage cod√©: colorier la zone courante si pr√©sent
      try{
        if(state.area?.id==='ecole' && state.sub?.id==='coloriage' && q?.meta?.col){
          const idx = state.progress.done; // zone index avant incr√©ment
          const hex = q.meta.col.hex;
          state.ecole = state.ecole || {}; state.ecole.coloring = state.ecole.coloring || {shape:'coeur', done:{}};
          state.ecole.coloring.done[idx] = hex;
          const z = document.getElementById('zone-'+idx);
          if(z){ z.setAttribute('fill', hex); z.classList.add('painted'); setTimeout(()=> z.classList.remove('painted'), 600); }
          save();
        }
      }catch{}
      state.block.correct++;
      state.streak=(state.streak||0)+1;
      if(el){ el.classList.add("correct"); try{ const halo=document.createElement('div'); halo.className='haloPop'; el.style.position='relative'; el.appendChild(halo); setTimeout(()=>halo.remove(), 700); }catch{} FX.glow(el); }
      // Gentle glow pop
      try{ if(el){ el.classList.add('glow','pop'); setTimeout(()=>{ el.classList.remove('glow','pop'); }, 600); } }catch{}
      win(1);
      haptic('ok');
      showWinPopup('‚ú® +1 ü¶Ñ ‚Ä¢ Bien jou√© !');
      try{ const msgs=["Bien jou√© ! ‚≠ê","Bravo ! ‚ú®","Super ! üåü","G√©nial ! üéà","Yes ! ü¶Ñ"]; showToast(msgs[Math.floor(Math.random()*msgs.length)]); }catch{}
      // Bonus por combo: 2 aciertos seguidos => +3, 3 seguidos => +4
      if(state.streak===2){ win(3); showToast("Yupiiii, ¬°sigue as√≠, L√©na! +3 ü¶Ñüí∞"); }
      if(state.streak===3){ win(4); showToast("Yupiiii, ¬°sigue as√≠, L√©na! +4 ü¶Ñüí∞"); }
      state.progress.done++; refreshHUD();
      setTimeout(nextQuestion,360);
    } else {
      state.block.wrong++;
      state.streak=0;
      state.currentWrong = (state.currentWrong||0) + 1;
      haptic('no');
      if(el){ el.classList.add("wrong","shake-soft"); FX.shake(el); setTimeout(()=> el.classList.remove('shake-soft'), 360); }
      // Show Pilot after two errors even on lower levels
      try{ if(state.currentWrong>=2){ pilotStart(q, q?.type, true); } }catch{}
      // Sweet penalty + solution for soustraction pos√©e
      if(q?.meta?.penaltyOnWrong){
        const lost = lose(q.meta.penaltyOnWrong);
        const sol = q?.meta?.solutionText || solutionOf(q);
        const svg = q?.meta?.svg || '';
        const msg = `
          <div style="margin-bottom:6px">Courage, on y est presque ‚ú®</div>
          ${userAns!=null?`<div>Ta r√©ponse : <b>${String(userAns)}</b></div>`:''}
          <div>R√©sultat : <b>${sol}</b></div>
          ${svg?`<div class="svgWrap" style="margin-top:6px">${svg}</div>`:''}
          <div class="small" style="margin-top:6px">${q.explain||''}</div>
          <div class="small" style="margin-top:6px">ü¶Ñ Billets utilis√©s : <b>${lost}</b></div>`;
        showModal("Petit coup de pouce ‚ú®", msg);
        return;
      }
      // Droite ou gauche (Vrai/Faux): muestra flecha de ayuda cuando fallo
      try{
        if(q?.meta?.dir){
          const ov = document.getElementById('dirOverlay');
          if(ov){
            const left = q.meta.dir==='left';
            const arrow = left ? '‚Üê gauche' : '‚Üí droite';
            ov.innerHTML = `Indice : <span style="font-weight:900">${arrow}</span>`;
            ov.style.display='block';
          }
        }
      }catch{}
      if(ADHD_MODE){
        const your = userAns!=null? `<div>Ta r√©ponse : <b>${String(userAns)}</b></div>` : '';
        const msg = `<div style="margin-bottom:6px">Essaie encore üåü</div>${your}<div class="small">Indice : ${q.explain||"Regarde bien l‚Äô√©nonc√© üëÄ"}</div>`;
        showModal("On r√©essaie ‚ú®", msg, ()=>{ const okBtn=$("#modalClose"); if(okBtn) okBtn.textContent='R√©essayer'; });
      } else {
        const lost = lose(2);
        const good = solutionOf(q);
        const solExtra = q.solution ? `<div style="margin-top:6px">Solution : <b>${Array.isArray(q.solution)? q.solution.join(' ‚Üí ') : q.solution}</b></div>` : '';
        const your = userAns!=null? `<div>Ta r√©ponse : <b>${String(userAns)}</b></div>` : '';
        showModal("Oups ‚ùå", `${your}<div>Bonne r√©ponse : <b>${good}</b></div>${solExtra}<div style="margin-top:6px">ü¶Ñüò¢ Perdiste <b>${lost}</b> ü¶Ñüí∞</div><br><small>${q.explain||"Regarde bien l‚Äô√©nonc√© üëÄ"}</small>`);
      }
    }
  }
  const solutionOf=q=> q.type==="qcm" ? (q.options[q.correct]?.label ?? "‚Äî") : "Voir explication.";

  function endOfBlock(){
    // estrellas seg√∫n errores: 3 (0 erreur), 2 (‚â§2), 1 (sinon)
    const w = state.block.wrong;
    const stars = w===0?3 : (w<=2?2:1);
    const key = state.area.id+"|"+state.sub.id;
    state.stars[key] = Math.max(state.stars[key]||0, stars);
    save();
    // Bonus doux pour le d√©fi final (niveau 6)
    if(ADHD_MODE && state.level>=state.totalLevels){ win(3); showToast('D√©fi final r√©ussi ! +3 ü¶Ñ‚ú®'); }

    fx.spawn(); showRainbow();
    const earned = Math.max(0, state.coins - (state.blockStartCoins||0));
    showModal("üéâ Bravo !", `
      <p>Tu as termin√© le niveau ${state.level} (${state.progress.total} exercices).</p>
      <p>Dinero unicornio : <b>${state.coins}</b> ü¶Ñüí∞</p>
      <p>Gan√© en este bloque: <b>+${earned}</b> ü¶Ñüí∞</p>
      <div style="font-size:24px">Tes √©toiles pour <b>${state.sub.name}</b> : ${"‚≠ê".repeat(stars)}${stars<3?`<span style="opacity:.35">${"‚≠ê".repeat(3-stars)}</span>`:""}</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button class="btn s" id="goNext">Continuer niveau suivant</button>
        <button class="btn g" id="stay">Rejouer ce niveau</button>
        <button class="btn g" id="goHome">Aller au menu</button>
      </div>
    `, ()=>{
      $("#goNext").onclick=()=>{ state.level=Math.min(state.totalLevels,state.level+1); startBlock(); hideModal(); };
      $("#stay").onclick=()=>{ startBlock(); hideModal(); };
      $("#goHome").onclick=()=>{ hideModal(); showHome(); };
      state.scores.unshift({name:state.user.name||"Joueur",coins:state.coins,level:state.level,at:Date.now()});
      state.scores=state.scores.slice(0,20); save();
    });
  }

  function animateCoins(delta){
    try{
      const chip=document.getElementById('coinChip'); if(!chip) return;
      const tag=document.createElement('span'); tag.style.marginLeft='6px'; tag.style.fontWeight='900'; tag.style.color= delta>0? '#16a34a' : '#dc2626';
      tag.textContent = (delta>0? '+':'') + delta + 'ü™ô';
      tag.style.transition='transform .25s, opacity .6s'; tag.style.display='inline-block'; tag.style.transform='translateY(6px)'; tag.style.opacity='0';
      chip.appendChild(tag);
      requestAnimationFrame(()=>{ tag.style.transform='translateY(-6px)'; tag.style.opacity='1'; });
      setTimeout(()=>{ tag.style.opacity='0'; tag.style.transform='translateY(-16px)'; }, 800);
      setTimeout(()=> tag.remove(), 1200);
    }catch{}
  }
  function showRainbow(){ try{ const r=document.getElementById('rainbow'); if(!r) return; r.classList.remove('show'); void r.offsetWidth; r.classList.add('show'); }catch{} }
  function win(n){ state.coins+=n; save(); audio.ok(); animateCoins(n); try{ fx.spawn(36); }catch{} return n; }
  function lose(n){ const lost = Math.min(n, state.coins); state.coins=Math.max(0,state.coins-n); save(); audio.no(); animateCoins(-lost); return lost; }

  // Toast no intrusivo para bonus
  function showToast(msg){
    // Ensure only one toast is visible at a time
    try{ document.querySelectorAll('.toast').forEach(el=> el.remove()); }catch{}
    const t=document.createElement('div');
    t.className='toast';
    t.setAttribute('role','status');
    t.setAttribute('aria-live','polite');
    t.textContent=msg;
    document.body.appendChild(t);
    setTimeout(()=>{ t.classList.add('out'); }, 1300);
    setTimeout(()=> t.remove(), 1800);
  }

  /* ----------- Modal helpers ----------- */
  function showModal(title, html, onOpen){
    $("#modalTitle").innerHTML=title; $("#modalBody").innerHTML=html; $("#modal").style.display="grid";
    $("#modalClose").onclick=hideModal; if(onOpen) onOpen();
    try{ document.querySelectorAll('#modal .box .btn').forEach(b=> b.classList.add('magic')); }catch{}
    // Cerrar al hacer click en el fondo
    $("#modal").onclick=(e)=>{ if(e.target.id==="modal") hideModal(); };
    // Focus trap inside modal box (accessibility)
    try{
      const box = document.querySelector('#modal .box');
      const focusable = () => Array.from(box.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))
        .filter(el=> !el.hasAttribute('disabled') && el.offsetParent!==null);
      const firstFocus = () => { const els=focusable(); (els[0]||box).focus(); };
      setTimeout(firstFocus,0);
      const onKey=(ev)=>{
        if(ev.key==='Escape'){ ev.preventDefault(); hideModal(); return; }
        if(ev.key==='Tab'){
          const els=focusable(); if(!els.length) return; const i=els.indexOf(document.activeElement);
          if(ev.shiftKey){ if(i<=0){ ev.preventDefault(); els[els.length-1].focus(); } }
          else { if(i===els.length-1){ ev.preventDefault(); els[0].focus(); } }
        }
      };
      box.addEventListener('keydown', onKey);
    }catch{}
  }
  function hideModal(){ const m=$("#modal"); if(!m) return; m.classList.add('closing'); setTimeout(()=>{ m.style.display="none"; m.classList.remove('closing'); }, 160); }

  // Modes (clair / sombre)
  function openModes(){
    const isDark = document.documentElement.getAttribute('data-theme')==='dark';
    showModal('üéõÔ∏è Modes', `
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
        <button class="btn g" id="mLight">‚òÄÔ∏è Clair</button>
        <button class="btn g" id="mDark">üåô Sombre</button>
      </div>
      <div class="small" style="margin-top:8px">Choisis ton apparence.</div>
    `, ()=>{
      $("#mLight").onclick=()=>{ document.documentElement.removeAttribute('data-theme'); state.theme=null; const th=document.getElementById('themeChip'); if(th){ th.textContent='‚òÄÔ∏è'; th.setAttribute('aria-pressed','false'); } save(); hideModal(); };
      $("#mDark").onclick=()=>{ document.documentElement.setAttribute('data-theme','dark'); state.theme='dark'; const th=document.getElementById('themeChip'); if(th){ th.textContent='üåô'; th.setAttribute('aria-pressed','true'); } save(); hideModal(); };
    });
  }

  /* ----------- Shop & scores ----------- */
  const SHOP=[
    {id:'hat_crown',  name:'Couronne',        price:20, emoji:'üëë', type:'hat', value:'üëë'},
    {id:'hat_cap',    name:'Casquette',       price:10, emoji:'üß¢', type:'hat', value:'üß¢'},
    {id:'acc_glasses',name:'Lunettes',        price:12, emoji:'üï∂Ô∏è', type:'acc', value:'üï∂Ô∏è'},
    {id:'acc_magic',  name:'Paillettes',      price:9,  emoji:'‚ú®', type:'acc', value:'‚ú®'},
    {id:'acc_unicorn',name:'Petit poney',     price:25, emoji:'ü¶Ñ', type:'acc', value:'ü¶Ñ'},
    {id:'acc_heart',  name:'Coeur',           price:7,  emoji:'üíñ', type:'acc', value:'üíñ'},
    {id:'hat_top',    name:'Haut-de-forme',   price:14, emoji:'üé©', type:'hat', value:'üé©'},
    {id:'acc_headph', name:'Casque audio',    price:13, emoji:'üéß', type:'acc', value:'üéß'},
    {id:'acc_star',   name:'√âtoiles',         price:11, emoji:'‚≠ê',  type:'acc', value:'‚≠ê'},
    {id:'acc_scarf',  name:'√âcharpe',         price:10, emoji:'üß£', type:'acc', value:'üß£'},
    {id:'face_smile', name:'Sourire üòÉ',      price:8,  emoji:'üòÉ', type:'face', value:'üòÉ'},
    {id:'face_cool',  name:'Cool üòé',         price:12, emoji:'üòé', type:'face', value:'üòé'},
    {id:'face_star',  name:'√âtoiles ü§©',      price:12, emoji:'ü§©', type:'face', value:'ü§©'},
    {id:'face_cat',   name:'Chat üò∫',         price:10, emoji:'üò∫', type:'face', value:'üò∫'}
  ];
  function openShop(){
    const owned=id=>state.inventory.includes(id);
    const rows=SHOP.map(it=>`
      <div class="flash" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div><span style="font-size:22px">${it.emoji}</span> <b>${it.name}</b> ‚Äî ${it.price} ü¶Ñüí∞</div>
        ${owned(it.id)? '<button class="btn s" data-equip="'+it.id+'">√âquiper</button>' : '<button class="btn p" data-buy="'+it.id+'">Acheter</button>'}
      </div>`).join("");
    showModal("üõçÔ∏è Boutique", `<div>${rows}</div><div class="small" style="margin-top:6px">Ach√®te des accessoires pour ton avatar puis √©quipe-les.</div>`, ()=>{
      $("#modalBody").onclick=e=>{
        const buy=e.target?.dataset?.buy; const eq=e.target?.dataset?.equip;
        if(buy){
          const item=SHOP.find(x=>x.id===buy);
          if(state.coins<item.price){ showModal("Boutique", `Pas assez de dinero unicornio pour <b>${item.name}</b>. Continue de jouer !`); return; }
          state.coins-=item.price; state.inventory.push(buy); save(); refreshHUD(); hideModal(); openShop(); return;
        }
        if(eq){
          const item=SHOP.find(x=>x.id===eq); if(!item) return;
          if(item.type==='hat') state.avatar.hat=item.value;
          if(item.type==='acc') state.avatar.acc=item.value;
          if(item.type==='face') state.avatar.face=item.value;
          save(); refreshHUD(); showToast('Avatar mis √† jour ‚ú®');
        }
      };
    });
  }
  function showScores(){
    const rows=(state.scores||[]).slice(0,12).map(s=>`<tr><td>${s.name}</td><td>${s.coins} ü¶Ñüí∞</td><td>Niv. ${s.level}</td><td>${new Date(s.at).toLocaleDateString()}</td></tr>`).join("");
    showModal("üèÜ Scores (local)", `
      <table style="width:100%;border-collapse:collapse">
        <thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #eee">Joueur</th>
        <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">Dinero unicornio</th>
        <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">Progr√®s</th>
        <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">Date</th></tr></thead>
        <tbody>${rows || '<tr><td colspan="4" style="padding:6px">Aucun score enregistr√©.</td></tr>'}</tbody>
      </table>
      <div style="display:flex;gap:8px;margin-top:10px">
        <input id="nameInput" placeholder="Ton pr√©nom" style="flex:1;padding:10px;border-radius:10px;border:1px solid #ddd">
        <button id="saveScore" class="btn s">Enregistrer ce score</button>
      </div>
    `, ()=>{
      $("#saveScore").onclick=()=>{
        const name=($("#nameInput").value||"Joueur").slice(0,16);
        state.scores.unshift({name, coins:state.coins, level:state.level, at:Date.now()});
        state.scores=state.scores.slice(0,20); save(); hideModal();
      };
    });
  }

  /* ----------- Flashcards ----------- */
  function openFlashcards(){
    const pool=[
      // Couleurs / arts
      {q:"bleu + jaune = ?", a:"vert"},
      {q:"rouge + bleu = ?", a:"violet"},
      {q:"rouge + jaune = ?", a:"orange"},
      // FR vocab
      {q:"Synonyme de ¬´ papa ¬ª ?", a:"p√®re"},
      {q:"F√©minin de ¬´ gar√ßon ¬ª ?", a:"fille"},
      // Maths
      {q:"3 √ó 4 = ?", a:"12"}, {q:"5 + 7 = ?", a:"12"}, {q:"9 ‚àí 4 = ?", a:"5"},
      // Num√©rique
      {q:"Ic√¥ne üíæ ?", a:"Sauvegarder"}, {q:"Ic√¥ne üóëÔ∏è ?", a:"Supprimer"},
      // Monde & saisons
      {q:"Saison de la neige ?", a:"hiver"}, {q:"Apr√®s l‚Äôautomne ?", a:"hiver"},
      // Base10
      {q:"Unit√©s avant dizaines ?", a:"unit√©s"},
      // S√©curit√©
      {q:"Mot de passe : le partager ?", a:"Non !"},
      // NL basique
      {q:"üá≥üá± ¬´ Bonjour ! ¬ª ?", a:"Goedemorgen !"},
      {q:"üá≥üá± ¬´ Merci ! ¬ª ?", a:"Dank je !"}
    ];
    const cards=shuffle(pool).slice(0,8);
    engine.flash(cards);
  }

  /* ----------- Avatar ----------- */
  function openAvatar(){
    state.avatar = state.avatar || {hat:null,acc:null,face:'üôÇ',hair:null,outfit:null};
    const gi=guideInfo();
    const preview=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:center">
      <div style="display:grid;place-items:center;height:160px"><div id="avGlyph" style="font-size:64px">${avatarGlyph()}</div><div class="small">Ton avatar</div></div>
      <div style="display:grid;place-items:center;height:160px"><div style="font-size:48px">${gi.emoji}</div><div class="small">Guide licorne ‚Äî ${gi.name}</div>
        <div class="small" style="margin-top:6px;width:90%">
          <div style="height:8px;border-radius:999px;background:#eee;overflow:hidden"><div style="height:100%;width:${gi.pct}%;background:linear-gradient(90deg,var(--p1),var(--p2))"></div></div>
          <div style="margin-top:4px;text-align:center">${state.coins} / ${gi.next} ü™ô</div>
        </div>
      </div>
    </div>`;
    const FREE={ hair:['üíá‚Äç‚ôÄÔ∏è','üëß','üë±‚Äç‚ôÄÔ∏è','üë©‚Äçü¶±','üë©‚Äçü¶∞'], outfit:['üëó','üëö','üëï','üß•','ü©≥'] };
    const owned=(type)=>SHOP.filter(i=>i.type===type && state.inventory.includes(i.id));
    const rowShop=(type,label)=>{
      const items=owned(type).map(i=>`<button class="btn g" data-wear="${i.id}">${i.emoji} ${i.name}</button>`).join(' ');
      const clear=`<button class="btn g" data-clear="${type}">Retirer</button>`;
      return `<div style="margin:6px 0"><b>${label}</b><div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">${items||'<span class="small">(Aucun pour le moment)</span>'} ${clear}</div></div>`;
    };
    const rowFree=(key,label)=>{
      const items=FREE[key].map(v=>`<button class="btn g" data-free="${key}:${v}">${v}</button>`).join(' ');
      const clear=`<button class="btn g" data-free-clear="${key}">Retirer</button>`;
      return `<div style="margin:6px 0"><b>${label}</b><div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">${items} ${clear}</div></div>`;
    };
    showModal('üôÇ Ton avatar', `${preview}
      ${rowFree('hair','Cheveux')}
      ${rowFree('outfit','V√™tements')}
      ${rowShop('face','Visages (boutique)')}
      ${rowShop('hat','Chapeaux (boutique)')}
      ${rowShop('acc','Accessoires (boutique)')}
      <div style="margin-top:8px"><button class="btn s" id="randAv">Al√©atoire ‚ú®</button></div>
    `, ()=>{
      const refresh=()=>{ const av=document.getElementById('avGlyph'); if(av) av.textContent=avatarGlyph(); refreshHUD(); };
      $("#modalBody").onclick=(e)=>{
        const wear=e.target?.dataset?.wear; const clr=e.target?.dataset?.clear;
        const free=e.target?.dataset?.free; const frclr=e.target?.dataset?.freeClear;
        if(wear){ const it=SHOP.find(x=>x.id===wear); if(it?.type==='hat') state.avatar.hat=it.value; if(it?.type==='acc') state.avatar.acc=it.value; if(it?.type==='face') state.avatar.face=it.value; save(); refresh(); }
        if(clr){ if(clr==='hat') state.avatar.hat=null; if(clr==='acc') state.avatar.acc=null; if(clr==='face') state.avatar.face='üôÇ'; save(); refresh(); }
        if(free){ const [k,v]=free.split(':'); if(k==='hair') state.avatar.hair=v; if(k==='outfit') state.avatar.outfit=v; save(); refresh(); }
        if(frclr){ if(frclr==='hair') state.avatar.hair=null; if(frclr==='outfit') state.avatar.outfit=null; save(); refresh(); }
      };
      $("#randAv").onclick=()=>{ const pick=arr=>arr[Math.floor(Math.random()*arr.length)]; state.avatar.hair=pick(FREE.hair); state.avatar.outfit=pick(FREE.outfit); save(); refresh(); };
    });
  }

  /* ----------- M√©moire: s√©lecteur de niveaux ----------- */
  function openMemoMenu(area){
    state.area = area;
    showStage();
    $("#breadcrumbs").textContent = `${area.title} ‚Ä∫ M√©moire`;
    const levels = [1,2,3,4,5];
    const html = `
      <div class="prompt">üß† M√©moire ‚Äî choisis un niveau</div>
      <div class="options" id="memoLvls"></div>`;
    $("#content").innerHTML = html;
    const wrap = $("#memoLvls");
    levels.forEach(L=>{
      const el=document.createElement('div');
      el.className='option';
      el.textContent = `Niveau ${L}`;
      el.onclick=()=>{ state.sub={id:`memo${L}`, name:`M√©moire Niv. ${L}`}; startBlock(); };
      wrap.appendChild(el);
    });
    // Ocultar botones de validar para este paso
    $("#btnCheck").style.display='none';
    $("#btnSkip").style.display='inline-flex';
    $("#btnPrev").style.display='inline-flex';
    $("#btnPrev").onclick=showHome;
  }

  function openRappelMenu(area){
    state.area = area;
    showStage();
    $("#breadcrumbs").textContent = `${area.title} ‚Ä∫ M√©moire ¬∑ Rappel`;
    const levels = [1,2,3,4,5];
    $("#content").innerHTML = `<div class="prompt">üëÄ Regarde les nombres puis touche-les dans l‚Äôordre croissant.</div><div class="options" id="rappelLvls"></div>`;
    const wrap=$("#rappelLvls");
    levels.forEach(L=>{const el=document.createElement('div'); el.className='option'; el.textContent=`Niveau ${L}`; el.onclick=()=>{ state.sub={id:`rappel${L}`, name:`Rappel Niv. ${L}`}; startBlock(); }; wrap.appendChild(el);});
    $("#btnCheck").style.display='none'; $("#btnSkip").style.display='inline-flex'; $("#btnPrev").style.display='inline-flex'; $("#btnPrev").onclick=showHome;
  }

  // ----------- Divisions: niveaux (facile ‚Üí difficile)
  function openDivMenu(area){
    state.area = area;
    showStage();
    $("#breadcrumbs").textContent = `${area.title} ‚Ä∫ Divisions simples`;
    const levels = [1,2,3];
    $("#content").innerHTML = `<div class="prompt">‚ûó Choisis un niveau</div><div class="options" id="divLvls"></div>`;
    const wrap=$("#divLvls");
    levels.forEach(L=>{ const el=document.createElement('div'); el.className='option'; el.textContent=`Niveau ${L}`; el.onclick=()=>{ state.math=state.math||{}; state.math.divLevel=L; state.sub={id:'div', name:`Divisions ¬∑ niveau ${L}`}; startBlock(); }; wrap.appendChild(el); });
    $("#btnCheck").style.display='none'; $("#btnSkip").style.display='inline-flex'; $("#btnPrev").style.display='inline-flex'; $("#btnPrev").onclick=showHome;
  }

  // ----------- Soustractions: niveaux (1 ‚Üí 10)
  function openSoustrMenu(area){
    state.area = area;
    showStage();
    $("#breadcrumbs").textContent = `${area.title} ‚Ä∫ Soustractions`;
    const levels = Array.from({length:10}, (_,i)=> i+1);
    $("#content").innerHTML = `<div class="prompt">‚ûñ Choisis un niveau (1‚Äì10)</div><div class="options" id="soustrLvls"></div>`;
    const wrap=$("#soustrLvls");
    levels.forEach(L=>{
      const el=document.createElement('div'); el.className='option'; el.textContent=`Niveau ${L}`;
      el.onclick=()=>{ state.level=L; state.sub={id:'mag_sub', name:`Soustractions ¬∑ niveau ${L}`}; startBlock(); };
      wrap.appendChild(el);
    });
    $("#btnCheck").style.display='none'; $("#btnSkip").style.display='inline-flex'; $("#btnPrev").style.display='inline-flex'; $("#btnPrev").onclick=showHome;
  }

  // ----------- Multiplications: chooser for table (1‚Äì5, 10)
  function openMultMenu(area){
    state.area = area;
    showStage();
    $("#breadcrumbs").textContent = `${area.title} ‚Ä∫ Multiplications`;
    const tables = Array.from({length:12}, (_,i)=> i+1);
    const html = `
      <div class="prompt">‚úñÔ∏è Choisis la table</div>
      <div class="options" id="multTables"></div>`;
    $("#content").innerHTML = html;
    const wrap = $("#multTables");
    tables.forEach(T=>{
      const el=document.createElement('div');
      el.className='option';
      el.textContent = `Table de ${T}`;
      el.onclick=()=>{
        state.math = state.math || {};
        state.math.multTable = T;
        state.sub = {id:'mult', name:`Multiplications ¬∑ table de ${T}`};
        startBlock();
      };
      wrap.appendChild(el);
    });
    $("#btnCheck").style.display='none';
    $("#btnSkip").style.display='inline-flex';
    $("#btnPrev").style.display='inline-flex';
    $("#btnPrev").onclick=showHome;
  }

  // ----------- √âcole: Septiembre ‚Üí seleccionar semana (15‚Äì19)
  function openEcoleSeptMenu(area){
    state.area = area;
    showStage();
    $("#breadcrumbs").textContent = `${area.title} ‚Ä∫ Septiembre`;
    const weeks = [
      {id:'sep1519', label:'Semana 15 a 19'}
    ];
    const html = `
      <div class="prompt">üè´ Septiembre ‚Äî elige la semana</div>
      <div class="options" id="weeks"></div>`;
    $("#content").innerHTML = html;
    const wrap = $("#weeks");
    weeks.forEach(w=>{
      const el=document.createElement('div');
      el.className='option';
      el.textContent = w.label;
      el.onclick=()=>{ openEcole1519Topics(area); };
      wrap.appendChild(el);
    });
    $("#btnCheck").style.display='none';
    $("#btnSkip").style.display='inline-flex';
    $("#btnPrev").style.display='inline-flex';
    $("#btnPrev").onclick=showHome;
  }

  // ----------- √âcole: Semana 15‚Äì19 ‚Üí choisir th√®me
  function openEcole1519Topics(area){
    state.area = area;
    showStage();
    $("#breadcrumbs").textContent = `${area.title} ‚Ä∫ Septembre ¬∑ Semaine 15‚Äì19`;
    const topics = [
      {id:'coloriage', label:'üé® Coloriage cod√©'},
      {id:'maisons_saisie', label:'üè† Les maisons des nombres'},
      {id:'problemes', label:'üç™ü•¨ Probl√®mes (cookies et salades)'},
      {id:'vocab_spatial', label:'üê≠ Vocabulaire spatial (souris)'},
      {id:'droite_gauche', label:'‚úã Droite et gauche'},
      {id:'saucisse', label:'‚ûï‚ûñ Technique de la saucisse'},
      {id:'lecture_assoc', label:'üìñ Lecture ‚Äî Associer livres et phrases'},
      {id:'roles_livre', label:'üìó Vocabulaire du livre'},
      {id:'comparaisons', label:'üìè Comparaisons'}
    ];
    const html = `
      <div class=\"prompt\">üè´ Choisis un th√®me</div>
      <div class=\"options\" id=\"ecTopics\"></div>`;
    $("#content").innerHTML = html;
    const wrap=$("#ecTopics");
    topics.forEach(t=>{
      const el=document.createElement('div');
      el.className='option';
      el.textContent = t.label;
      el.onclick=()=>{ state.sub={id:t.id, name:t.label}; startBlock(); };
      wrap.appendChild(el);
    });
    $("#btnCheck").style.display='none'; $("#btnSkip").style.display='inline-flex'; $("#btnPrev").style.display='inline-flex'; $("#btnPrev").onclick=showHome;
  }

  /* ----------- Contes ----------- */
  function generateTale(seed){
    const lieux=['la for√™t de l\u2019Aurore üå≤','le village de Brindille üè°','le bord de la mer üåä','la montagne bleue ‚õ∞Ô∏è','le jardin aux lucioles ‚ú®','la plaine des nuages ‚òÅÔ∏è'];
    const heros=['L\u00e9na ü¶Ñ','Milo üêª','Zo\u00e9 ü¶ä','Nino üêº','Lina üê±','Rox üê∂'];
    const amis=['un \u00e9cureuil curieux üêøÔ∏è','un chat qui parle üê±üí¨','une luciole brillante üîÜ','un petit robot ü§ñ','un oiseau messager üê¶','une tortue sage üê¢'];
    const quetes=['retrouver une \u00e9toile perdue ‚≠ê','apprendre le secret des saisons üå∏‚òÄÔ∏èüçÇ‚ùÑÔ∏è','rendre des couleurs \u00e0 un tableau üé®','offrir un sourire \u00e0 quelqu\u2019un de triste üòä‚û°Ô∏èüôÇ','apaiser un nuage grognon ‚òÅÔ∏èüò†','raconter une histoire au vent üí®üìñ'];
    const obstacles=['un pont cass\u00e9 üåâ','un brouillard \u00e9pais üå´Ô∏è','une \u00e9nigme \u00e0 r\u00e9soudre üîç','un vent capricieux üí®','un labyrinthe de feuilles üçÅ','une rivi\u00e8re vive üí¶'];
    const moral=['le courage grandit quand on le partage üí™ü§ù','un petit geste peut illuminer le monde ‚ú®','on apprend en aidant les autres üë©‚Äçüè´','la patience ouvre toutes les portes üóùÔ∏è','la gentillesse revient toujours üíû','respirer aide \u00e0 avancer üßò'];
    const pick=(arr,i)=> arr[i%arr.length];
    const L=pick(lieux,seed*3+1), H=pick(heros,seed+2), A=pick(amis,seed*5+3), Q=pick(quetes,seed*7+4), O=pick(obstacles,seed*11+5), M=pick(moral,seed*13+6);
    const name=H.split(' ')[0];
    return [
      `${H} habite pr\u00e8s de ${L}. Chaque matin, ${name} dit \u00ab bonjour ! \u00bb aux oiseaux üê¶ et au soleil ‚òÄÔ∏è.`,
      `Un jour, ${name} rencontre ${A}. Ensemble, ils d\u00e9cident de ${Q}. Ils pr\u00e9parent un sac üéí, une gourde ü•§ et un grand sourire üòÑ.`,
      `Le chemin est simple. Pas \u00e0 pas. Ils chantent üé∂ et sautent les flaques üíß.`,
      `Soudain, ils croisent ${O}. Ils respirent üßò. Ils essayent encore üí´.`,
      `Gr\u00e2ce \u00e0 leur entraide ü§ù, la route s\u2019ouvre ‚ú®. Au loin, une petite lumi\u00e8re les guide üîî.`,
      `Au coucher du soleil üåá, ils r\u00e9ussissent. Ils comprennent que ${M}.`
    ];
  }
  const TALES=Array.from({length:20}, (_,i)=> generateTale(i));

  /* ----------- Fabrique de questions ----------- */
  // FR
  const FR={
    lecture(){
      const tales=[
        {t:"Mina trouve une graine. Elle la plante. Un matin, une petite fleur appara√Æt.", q:"Vrai ou faux : Mina a plant√© une graine ?", a:true, exp:"On lit ¬´ Elle la plante ¬ª."},
        {t:"Lucas a un cerf-volant rouge. Il pleut. Lucas d√©cide d‚Äôattendre.", q:"Vrai ou faux : Lucas joue sous la pluie.", a:false, exp:"Il d√©cide d‚Äôattendre."},
        {t:"Zo√© voit un chat et un chien. Le chat dort, le chien court.", q:"Qui dort ?", a:"le chat", choices:["le chat","le chien","les deux"], exp:"¬´ Le chat dort ¬ª."}
      ];
      const s=choice(tales);
      if(typeof s.a==="boolean"){
        return {id:"fr-lecture-"+s.t,type:"qcm",text:`üìñ Lis : ¬´ ${s.t} ¬ª ‚Äî ${s.q}` ,options:[{label:"Vrai"},{label:"Faux"}],correct:s.a?0:1, explain:s.exp};
      } else {
        const opts=shuffle(s.choices).map(x=>({label:x})); const correct=opts.findIndex(o=>o.label===s.a);
        return {id:"fr-lecture-"+s.t,type:"qcm",text:`üìñ Lis : ¬´ ${s.t} ¬ª ‚Äî ${s.q}`,options:opts,correct, explain:s.exp};
      }
    },
    vocab(){
      const cat=choice([
        {name:"animaux", pairs:[["chat","üê±"],["chien","üê∂"],["poisson","üêü"],["oiseau","üê¶"],["lion","ü¶Å"],["souris","üê≠"]]},
        {name:"v√™tements", pairs:[["chapeau","üëí"],["chaussures","üëü"],["pantalon","üëñ"],["robe","üëó"],["manteau","üß•"],["gants","üß§"]]},
        {name:"saisons", pairs:[["printemps","üå∏"],["√©t√©","‚òÄÔ∏è"],["automne","üçÇ"],["hiver","‚ùÑÔ∏è"]]},
        {name:"famille", pairs:[["maman","üë©"],["papa","üë®"],["fr√®re","üë¶"],["s≈ìur","üëß"],["b√©b√©","üë∂"],["grand-m√®re","üëµ"]]},
        {name:"couleurs", pairs:[["rouge","üî¥"],["bleu","üîµ"],["jaune","üü°"],["vert","üü¢"],["violet","üü£"],["orange","üü†"]]}
      ]);
      const pair=choice(cat.pairs); let opts=shuffle(cat.pairs.map(p=>p[0])).slice(0,4); if(!opts.includes(pair[0])) opts[0]=pair[0];
      return {id:`fr-vocab-${cat.name}-${pair[0]}`, type:"qcm", text:`üìö Choisis le mot qui correspond √† ${pair[1]} (${cat.name}).`, options:opts.map(x=>({label:x})), correct:opts.indexOf(pair[0]), explain:`${pair[1]} correspond √† ¬´ ${pair[0]} ¬ª.`};
    },
    gram(){
      const t=choice(["genre","pluriel","etreavoir"]);
      if(t==="genre"){
        const pairs=[["une","fille"],["un","gar√ßon"],["une","pomme"],["un","livre"]]; const p=choice(pairs);
        return {id:`fr-gram-genre-${p.join("-")}`, type:"qcm", text:`üî§ Choisis le bon genre : ____ ${p[1]}`, options:[{label:"un"},{label:"une"}], correct:p[0]==="un"?0:1, explain:`On dit ¬´ ${p[0]} ${p[1]} ¬ª.`};
      }
      if(t==="pluriel"){
        const w=choice([["cheval","chevaux"],["animal","animaux"],["chou","choux"],["chien","chiens"]]);
        const arr=shuffle([w[1], w[0]+"s", w[0]+"x", w[0]]);
        return {id:`fr-gram-pluriel-${w[0]}`, type:"qcm", text:`üî§ Quel est le pluriel de ¬´ ${w[0]} ¬ª ?`, options:arr.map(x=>({label:x})), correct:arr.indexOf(w[1]), explain:`Le pluriel de ¬´ ${w[0]} ¬ª est ¬´ ${w[1]} ¬ª.`};
      }
      const subj=choice(["Je","Tu","Il","Elle","Nous","Vous","Ils"]); const verb=choice(["√™tre","avoir"]);
      const forms={"√™tre":{"Je":"suis","Tu":"es","Il":"est","Elle":"est","Nous":"sommes","Vous":"√™tes","Ils":"sont"},"avoir":{"Je":"ai","Tu":"as","Il":"a","Elle":"a","Nous":"avons","Vous":"avez","Ils":"ont"}};
      const corr=forms[verb][subj]; const opts=shuffle([corr, choice(["es","est","a","ont","avez","sommes","ai","as"]), choice(["serai","aurai"])]);
      return {id:`fr-etreavoir-${subj}-${verb}`, type:"qcm", text:`üî§ Conjugue ${verb} : ${subj} ___`, options:opts.map(x=>({label:x})), correct:opts.indexOf(corr), explain:`${subj} ${corr}.`};
    },
    ecrit(){
      const sentence=choice(["Le chat saute sur le mur.","Aujourd‚Äôhui il fait beau.","La licorne brille dans le ciel.","Nous aimons lire des contes."]);
      return {id:`fr-ecrit-${sentence}`, type:"input", text:"‚úçÔ∏è Copie la phrase exactement :", kind:"text", placeholder:sentence, check:v=>strip(v)===strip(sentence), explain:`R√©ponse attendue : ¬´ ${sentence} ¬ª.`};
    },
    dialogue(){
      const dial=choice([
        {q:"‚Äî Bonjour ! √áa va ?\n‚Äî __________", a:"Oui, tr√®s bien merci !", wrong:["Je m‚Äôappelle L√©o.","Bleu et rouge.","Au revoir."]},
        {q:"‚Äî Tu veux jouer avec moi ?\n‚Äî __________", a:"Oui, avec plaisir !", wrong:["J‚Äôai huit ans.","Je mange une pomme.","Il pleut."]},
        {q:"‚Äî Merci pour ton aide !\n‚Äî __________", a:"De rien !", wrong:["Bonjour !","√Ä demain.","Peut-√™tre."]}
      ]);
      const opts=shuffle([dial.a,...dial.wrong]).map(x=>({label:x}));
      return {id:`fr-dialogue-${dial.a}`, type:"qcm", text:`üí¨ Choisis la bonne r√©plique :<br><pre style="white-space:pre-wrap;background:#fff;border:1px solid #eee;padding:10px;border-radius:10px">${dial.q}</pre>`, options:opts, correct:opts.findIndex(o=>o.label===dial.a), explain:`On r√©pond : ¬´ ${dial.a} ¬ª.`};
    }
  };

  // MATH
  const MATH={
    // Math√©matiques magiques ‚ú®ü¶Ñ ‚Äî additions
    mag_add(lvl){
      const L = Math.max(1, Math.min(10, lvl||1));
      const max = L<=3 ? 20 : (L<=6 ? 50 : 100);
      let a=rnd(0,max), b=rnd(0,max);
      while(a+b>max){ a=rnd(0,max); b=rnd(0,max); }
      const res=a+b;
      const text = `üåüü¶Ñ Math√©matiques magiques ‚Äî Addition<br>ü™Ñ ${a} + ${b} = ?`;
      const explain = expAddSub(a,b,res,true);
      const [rd,ru]=tu(res);
      const hint = `üß© D√©compose<br>${fmtTU(a)}<br>${fmtTU(b)}<br>üßÆ Calcule pas √† pas : ${a} + ${b} = ??<br>‚ú® R√©sultat : ?? = ${rd} diz. + ${ru} unit.`;
      return { id:`m-mag-add-${a}-${b}-${L}`, type:'input', text, kind:'number', placeholder:'R√©ponse', check:v=> String(v).trim()==String(res), explain, meta:{ hint } };
    },
    // Soustraction pos√©e avec retenue (toujours avec emprunt)
    mag_sub(lvl){
      const L = Math.max(1, Math.min(10, lvl||1));
      const range = L<=3 ? 20 : (L<=6 ? 50 : 100);
      function gen(){
        let a,b;
        if(range<=20){
          a=rnd(11,Math.min(19,range));
          b=rnd(2,9);
          const ua=a%10; if(ua>=b) b = Math.min(9, ua+1);
          if(b>=a) b = Math.max(2, (a%10)+1);
        } else {
          const da=rnd(2,Math.min(9,Math.floor(range/10)));
          const db=rnd(1,da);
          const ua=rnd(0,8); const ub=rnd(ua+1,9); // garantir emprunt
          a=da*10+ua; b=db*10+ub;
          if(a<=b) a+=10;
          if(a>range) a=range-(a%10)+ua; // borne
        }
        if(b>a) [a,b]=[b,a];
        if((a%10) >= (b%10)) return gen();
        if(a>range || b>range || a<=b) return gen();
        return [a,b];
      }
      const [a,b]=gen(); const res=a-b;
      const ua=a%10, ub=b%10, da=Math.floor(a/10);
      const text = `üåüü¶Ñ Soustraction pos√©e ‚Äî ${a} ‚àí ${b} = ?`;
      const exp = [
        `On ne peut pas faire ${ua} ‚àí ${ub}, alors on prend 1 dizaine du ${da}.`,
        `Le ${da} devient ${da-1} et le ${ua} devient ${ua+10}.`,
        `${ua+10} ‚àí ${ub} puis on termine avec les dizaines.`,
        `R√©sultat : <b>${a} ‚àí ${b} = ${res}</b>.`
      ].join('<br>');
      const svg = posedSubSVG(a,b);
      const speak = `Soustraction pos√©e. ${a} moins ${b}. On ne peut pas faire ${ua} moins ${ub}. On emprunte une dizaine au ${da}. Le ${da} devient ${da-1} et le ${ua} devient ${ua+10}. Le r√©sultat est ${res}.`;
      const mag = {
        id:`m-sub-ret-${a}-${b}-L${L}`,
        type:'qcm',
        text,
        // three options: correct + two plausible distractors
        options: (()=>{
          const opts=new Set([res]);
          const add=(x)=>{ if(x>=0) opts.add(x); };
          add(res+1); add(res-1); add(res+2); add(res-2);
          return Array.from(opts).slice(0,3).sort(()=>Math.random()-.5).map(x=>({label:String(x)}));
        })(),
        correct: 0, // will fix below
        explain:exp,
        meta:{ svg, hint:'Observe la fl√®che : la dizaine va aider les unit√©s.', magic:'twinkle', speakText:speak, penaltyOnWrong:2, solutionText:String(res), soustractionPosee:true }
      };
      // fix correct index after options built
      const i = mag.options.findIndex(o=> o.label===String(res));
      mag.correct = i<0?0:i;
      return mag;
    },
    addsub(lvl){
      // 0‚Äì100, pas de n√©gatifs
      let a=rnd(0,100), b=rnd(0,100), add=Math.random()<.5;
      if(add){ while(a+b>100){ a=rnd(0,100); b=rnd(0,100); } }
      else { if(b>a){ const t=a; a=b; b=t; } }
      const res=add?a+b:a-b;
      const text=`${a} ${add?"+":"‚àí"} ${b} = ?`;
      const arr=shuffle([res,res+rnd(1,5), res-rnd(1,5), res+rnd(6,10)]);
      const hint=`üß© D√©compose<br>${fmtTU(a)}<br>${fmtTU(b)}<br>üßÆ Calcule : ${a} ${add?'+':'‚àí'} ${b} = ??`;
      return {id:`m-addsub-${a}-${b}-${add}`, type:"qcm", text, options:arr.map(x=>({label:String(x)})), correct:arr.indexOf(res), explain: expAddSub(a,b,res,add), meta:{ hint }};
    },
    mult(lvl){
      const chosen = (state.math && state.math.multTable) ? state.math.multTable : null;
      const table = chosen || choice([1,2,3,4,5,6,7,8,9,10,11,12]);
      const b=rnd(1,12); const res=table*b;
      const arr=shuffle([res, res+table, res-table, res+2]);
      // Hint: repeated addition and dots
      const repeat = `${Array(Math.min(table,3)).fill(b).join(' + ')}${table>3?' + ‚Ä¶':''} = ${res}`;
      return {
        id:`m-mult-${table}-${b}`,
        type:"qcm",
        text:`${table} √ó ${b} = ?`,
        options:arr.map(x=>({label:String(x), icon:'üî¢'})),
        correct:arr.indexOf(res),
        explain:`üßÆ Table de ${table} ‚Üí ${table}√ó${b}=${res}.`,
        meta:{dots:{rows:table, cols:b}, hint:`Addition r√©p√©t√©e : ${repeat}`}
      };
    },
    div(lvl){
      const L=(state.math&&state.math.divLevel)||1;
      // niveaux: 1 facile, 2 moyen, 3 difficile
      const cfg={1:{g:[2,3], e:[2,4]}, 2:{g:[2,5], e:[3,7]}, 3:{g:[3,7], e:[4,9]}}[L];
      const groups=rnd(cfg.g[0], cfg.g[1]), each=rnd(cfg.e[0], cfg.e[1]), total=groups*each;
      const arr=shuffle([each, each+1, each-1, each+2]);
      const dots=renderDots(groups, each);
      return {id:`m-div-${groups}-${each}-L${L}`, type:"qcm", text:`On partage ${total} bonbons en ${groups} groupes √©gaux. Combien dans chaque groupe ?`, options:arr.map(x=>({label:String(x), icon:'üç¨'})), correct:arr.indexOf(each), explain:`üç¨ Paquets: ${total} √∑ ${groups} = <b>${each}</b>.`, meta:{dots:{rows:groups, cols:each}, hint:`R√©partition: ${total} = ${groups} √ó ${each}`}};
    },
    eq(){
      const a=rnd(1,30), b=rnd(1,30), c=a+b, miss=choice(["a","b","c"]);
      if(miss==="a"){const arr=shuffle([a,a+1,a-1,a+2]); const hint=`üß© D√©compose<br>${fmtTU(c)}<br>${fmtTU(b)}<br>üßÆ Calcule : ${c} ‚àí ${b} = ??`; return {id:`m-eq-a-${a}-${b}`, type:"qcm", text:`‚ñ° + ${b} = ${c}`, options:arr.map(x=>({label:String(x)})), correct:arr.indexOf(a), explain:`üîÅ On cherche le nombre manquant: ${c} ‚àí ${b} = <b>${a}</b>.<br>${fmtTU(c)}<br>${fmtTU(b)}`, meta:{ hint }};}
      if(miss==="b"){const arr=shuffle([b,b+1,b-1,b+2]); const hint=`üß© D√©compose<br>${fmtTU(c)}<br>${fmtTU(a)}<br>üßÆ Calcule : ${c} ‚àí ${a} = ??`; return {id:`m-eq-b-${a}-${b}`, type:"qcm", text:`${a} + ‚ñ° = ${c}`, options:arr.map(x=>({label:String(x)})), correct:arr.indexOf(b), explain:`üîÅ On cherche le nombre manquant: ${c} ‚àí ${a} = <b>${b}</b>.<br>${fmtTU(c)}<br>${fmtTU(a)}`, meta:{ hint }};}
      const arr=shuffle([c,c+1,c-1,c+2]); const hint=`üß© D√©compose<br>${fmtTU(a)}<br>${fmtTU(b)}<br>üßÆ Calcule : ${a} + ${b} = ??`; return {id:`m-eq-c-${a}-${b}`, type:"qcm", text:`${a} + ${b} = ‚ñ°`, options:arr.map(x=>({label:String(x)})), correct:arr.indexOf(c), explain:expAddSub(a,b,c,true), meta:{ hint }};
    },
    ordre(){
      const arr=[rnd(0,99),rnd(0,99),rnd(0,99),rnd(0,99)]; const mode=Math.random()<.5?"croissant":"d√©croissant";
      const solution=[...arr].sort((a,b)=> mode==="croissant"?a-b:b-a).map(String);
      return {id:`m-ordre-${arr.join("-")}-${mode}`, type:"order", text:`Range ces nombres en ordre ${mode} :`, items:shuffle(arr.map(x=>String(x))), solution, check(ans){ return JSON.stringify(ans)===JSON.stringify(solution); }, explain:`Ordre ${mode}.`};
    },
    base10(){
      const d=rnd(0,9), u=rnd(0,9), n=d*10+u;
      const opts=shuffle([`${d} diz. et ${u} unit.`, `${d+1} diz. et ${u-10} unit.`, `${d-1} diz. et ${u+10} unit.`, `${d} diz. et ${u+1} unit.`]);
      return {id:`m-b10-${n}`, type:"qcm", text:`D√©compose ${n} en dizaines et unit√©s.`, options:opts.map(x=>({label:x})), correct:opts.indexOf(`${d} diz. et ${u} unit.`), explain:`üß© ${fmtTU(n)}`};
    },
    problemes(){
      const a=rnd(2,9), b=rnd(2,9), r=a+b;
      const arr=shuffle([r,r+1,r-1,r+2]);
      const hint=`üß© D√©compose<br>${fmtTU(a)}<br>${fmtTU(b)}<br>üßÆ Calcule : ${a} + ${b} = ??`;
      return {id:`m-prob-${a}-${b}`, type:"qcm", text:`L√©na ach√®te ${a} pommes et ${b} poires. Combien de fruits a-t-elle ?`, options:arr.map(x=>({label:String(x)})), correct:arr.indexOf(r), explain:expAddSub(a,b,r,true), meta:{ hint }};
    }
  };

  // SCIENCES
  const SCI={
    saisons(){const q=choice([{act:"On fait un bonhomme de neige",season:"hiver",emoji:"‚õÑ"},{act:"On nage √† la plage",season:"√©t√©",emoji:"üèñÔ∏è"},{act:"Les feuilles tombent",season:"automne",emoji:"üçÇ"},{act:"Les fleurs poussent",season:"printemps",emoji:"üå∏"}]); const opts=shuffle(["printemps","√©t√©","automne","hiver"]); return {id:"sci-saison-"+q.act,type:"qcm",text:`${q.emoji} ${q.act}. Quelle saison ?`, options:opts.map(x=>({label:x})), correct:opts.indexOf(q.season), explain:`C‚Äôest en ${q.season}.`};},
    famille(){const q=choice([{p:"La s≈ìur de ma maman est ma ‚Ä¶",a:"tante"},{p:"Le fils de ma tante est mon ‚Ä¶",a:"cousin"},{p:"Le p√®re de mon p√®re est mon ‚Ä¶",a:"grand-p√®re"}]); const opts=shuffle([q.a,"ami","voisin","fr√®re"]); return {id:"sci-fam-"+q.a,type:"qcm",text:q.p,options:opts.map(x=>({label:x})),correct:opts.indexOf(q.a), explain:`On dit : ${q.a}.`};},
    hygiene(){ return SANTE.hygiene(); },
    aliments(){ return SANTE.alimentation(); },
    corps(){const pairs=[["Voir","les yeux üëÄ"],["Sentir","le nez üëÉ"],["Marcher","les jambes ü¶µ"],["Saisir","les mains ‚úã"]]; const q=choice(pairs); const opts=shuffle(pairs.map(p=>p[1])); return {id:"sci-corps-"+q[0], type:"qcm", text:`Pour ¬´ ${q[0]} ¬ª, quelle partie du corps ?`, options:opts.map(x=>({label:x})), correct:opts.indexOf(q[1]), explain:`On utilise ${q[1]}.`};}
  };

  // ARTS
  const ARTS={
    melanges(){const mix=choice([{a:"üîµ bleu",b:"üü° jaune",res:"üü¢ vert",color:"#22cc88"},{a:"üî¥ rouge",b:"üîµ bleu",res:"üü£ violet",color:"#8a2be2"},{a:"üî¥ rouge",b:"üü° jaune",res:"üü† orange",color:"#ff8c00"}]); const arr=shuffle(["üü¢ vert","üü£ violet","üü† orange"]); return {id:"art-mix-"+mix.res,type:"qcm",text:`M√©lange ${mix.a} + ${mix.b} = ?`, options:arr.map(x=>({label:x, color: x.includes("vert")?"#22cc88":x.includes("violet")?"#8a2be2":"#ff8c00"})), correct:arr.indexOf(mix.res), explain:`R√©sultat : ${mix.res}.`};},
    dessin(){return {id:"art-dessin", type:"drawing", text:"Dessine librement (utilise au moins 3 couleurs et remplis bien la feuille)."};},
    coloriage(){
      // Simple sc√®ne: maison + arbre + ciel + herbe (contours)
      const svg = `<?xml version="1.0" encoding="UTF-8"?>
      <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 480' width='800' height='480'>
        <rect x='0' y='0' width='800' height='480' fill='white'/>
        <g fill='none' stroke='#222' stroke-width='2'>
          <!-- Sol -->
          <rect x='0' y='400' width='800' height='80' fill='none'/>
          <!-- Maison -->
          <rect x='120' y='230' width='220' height='170' />
          <polygon points='120,230 230,150 340,230' />
          <rect x='210' y='310' width='40' height='90' />
          <rect x='150' y='260' width='60' height='50' />
          <rect x='250' y='260' width='60' height='50' />
          <!-- Arbre -->
          <rect x='420' y='300' width='24' height='100' />
          <circle cx='470' cy='270' r='40' />
          <circle cx='430' cy='260' r='30' />
          <circle cx='500' cy='250' r='35' />
          <!-- Soleil -->
          <circle cx='700' cy='90' r='34' />
        </g>
      </svg>`;
      const allowed=["#f43f5e", "#3b82f6", "#fde047", "#22c55e", "#10b981", "#a855f7", "#000000"];
      const instructions=[
        "Toit: rouge",
        "Fen√™tres: jaune",
        "Porte: bleu",
        "Herbe: vert",
        "Tronc: vert sombre (ou noir)",
        "Ciel: bleu clair",
        "Soleil: jaune"
      ];
      return { id:"art-coloriage-1", type:"drawing", text:"Colorie l'image en suivant les consignes.", allowedColors: allowed, requiredColors:["#f43f5e","#3b82f6","#fde047","#22c55e"], instructions, bgSvg: svg };
    }
  };

  // N√âERLANDAIS (NL)
  const NL={
    cloze(){
      const bank=[
        {s:'Ik ____ een appel.', a:'eet', opts:['eet','ben','speel'], exp:'¬´ Ik eet een appel ¬ª = Yo como una manzana.'},
        {s:'Wij ____ naar school.', a:'gaan', opts:['gaan','hebt','loopt'], exp:'¬´ Wij gaan naar school ¬ª = Vamos a la escuela.'},
        {s:'De kat is ____.', a:'zwart', opts:['zwart','groot','twee'], exp:'kleur: zwart = negro.'},
        {s:'____ heet Lena.', a:'Ik', opts:['Ik','Jij','Hij'], exp:'¬´ Ik heet‚Ä¶ ¬ª = Me llamo‚Ä¶'},
        {s:'Het is ____ uur.', a:'tien', opts:['tien','rood','eten'], exp:'tien = diez.'}
      ];
      const e=choice(bank); const options=shuffle(e.opts.map(x=>({label:x}))); const correct=options.findIndex(o=>o.label===e.a);
      return {id:`nl-cloze-${e.s}`, type:'qcm', text:`üá≥üá±üìñ Compl√®te la phrase : ${e.s.replace('____','___')}`, options, correct, explain:e.exp};
    },
    getallen(){
      const map=[[1,'een'],[2,'twee'],[3,'drie'],[4,'vier'],[5,'vijf'],[6,'zes'],[7,'zeven'],[8,'acht'],[9,'negen'],[10,'tien'],[11,'elf'],[12,'twaalf'],[13,'dertien'],[14,'veertien'],[15,'vijftien'],[16,'zestien'],[17,'zeventien'],[18,'achttien'],[19,'negentien'],[20,'twintig']];
      const max = Math.min(20, 10 + Math.ceil(state.level/3)*5); // escala por nivel
      const pool = map.filter(([n])=> n<=max);
      const [n, w] = choice(pool);
      const mode = Math.random()<.5?'nl2num':'num2nl';
      if(mode==='nl2num'){
        const opts = shuffle(pool.map(([nn])=> String(nn))).slice(0,4);
        if(!opts.includes(String(n))) opts[0]=String(n);
        return {id:`nl-getallen-nl2num-${n}`, type:'qcm', text:`üî¢ Quel nombre correspond √† ¬´ ${w} ¬ª ?`, options:opts.map(x=>({label:x})), correct:opts.indexOf(String(n)), explain:`¬´ ${w} ¬ª = ${n}.`};
      } else {
        const opts = shuffle(pool.map(([,ww])=> ww)).slice(0,4);
        if(!opts.includes(w)) opts[0]=w;
        return {id:`nl-getallen-num2nl-${n}`, type:'qcm', text:`üî¢ Comment dit-on ${n} en n√©erlandais ?`, options:opts.map(x=>({label:x})), correct:opts.indexOf(w), explain:`${n} = ¬´ ${w} ¬ª.`};
      }
    },
    groeten(){
      const bank=[
        ['Bonjour !','Goedemorgen !'],['Salut !','Hallo !'],['Au revoir !','Tot ziens !'],['Bonne nuit !','Welterusten !'],['Merci !','Dank je !']
      ];
      const [fr,nl]=choice(bank); const opts=shuffle([nl,'Alsjeblieft !','Tot morgen !']).map(x=>({label:x}));
      const correct=opts.findIndex(o=>o.label===nl);
      return {id:`nl-greet-${nl}`, type:'qcm', text:`üëã Comment dire ¬´ ${fr} ¬ª en n√©erlandais ?`, options:opts, correct, explain:`On dit : ¬´ ${nl} ¬ª. `};
    },
    kleuren(){
      const colors=[["rouge","rood","üî¥"],["bleu","blauw","üîµ"],["jaune","geel","üü°"],["vert","groen","üü¢"],["noir","zwart","‚ö´"],["blanc","wit","‚ö™"]];
      const [fr, nl, em]=choice(colors);
      const opts=shuffle(colors.map(c=>c[1])).map(x=>({label:x})); const correct=opts.findIndex(o=>o.label===nl);
      return {id:`nl-color-${nl}`, type:'qcm', text:`üé® ${em} Couleur : ¬´ ${fr} ¬ª en n√©erlandais ?`, options:opts, correct, explain:`¬´ ${fr} ¬ª = ¬´ ${nl} ¬ª.`};
    },
    klas(){
      const bank=[
        {fr:'Puis-je aller aux toilettes ?', nl:'Mag ik naar het toilet ?', wrong:['Ik heb honger','Ik ben ziek','Tot ziens']},
        {fr:'Je ne comprends pas.', nl:'Ik begrijp het niet.', wrong:['Ik heb dorst','Tot morgen','Geen probleem']},
        {fr:'Puis-je boire de l‚Äôeau ?', nl:'Mag ik water drinken ?', wrong:['Ik heb een vraag','Tot ziens','Dank je']},
      ];
      const e=choice(bank); const opts=shuffle([e.nl,...e.wrong]).map(x=>({label:x}));
      return {id:`nl-klas-${e.nl}`, type:'qcm', text:`üè´ En classe : traduction de ¬´ ${e.fr} ¬ª`, options:opts, correct:opts.findIndex(o=>o.label===e.nl), explain:`On dit : ¬´ ${e.nl} ¬ª. `};
    }
  };

  // CONTES
  const CONTE={
    histoires(){
      const idx = rnd(0, TALES.length-1);
      const mk = ()=> generateTale(rnd(0,9999));
      return {id:`conte-${idx}`, type:'tale', paras: TALES[idx], regen: mk, explain:'Lis tranquillement le conte.'};
    },
    enigmes(){
      const bank=[
        {q:'Je grandis quand on me compte. Qui suis-je ?', a:'L‚Äô√¢ge', opts:['L‚Äô√¢ge','La pluie','Une fleur'], exp:'On compte les ann√©es : l‚Äô√¢ge grandit.'},
        {q:'Je brille la nuit mais je ne br√ªle pas.', a:'La lune', opts:['Le feu','La lune','La lampe'], exp:'La lune brille sans br√ªler.'},
        {q:'J‚Äôai des feuilles mais je ne suis pas un arbre.', a:'Un livre', opts:['Un livre','Une salade','Une fleur'], exp:'Un livre a des ¬´ feuilles ¬ª de papier.'},
        {q:'Plus je s√®che, plus je mouille.', a:'La serviette', opts:['La serviette','La pluie','Le vent'], exp:'La serviette mouille en s√©chant les autres.'},
        {q:'Je passe devant le soleil, et la nuit arrive.', a:'Le temps', opts:['Le temps','Un nuage','La neige'], exp:'Le temps fait venir la nuit.'}
      ];
      const e=choice(bank); const options=shuffle(e.opts.map(x=>({label:x}))); const correct=options.findIndex(o=>o.label===e.a);
      return {id:`enigme-${e.q}`, type:'qcm', text:`üß© √ânigme : ${e.q}`, options, correct, explain:e.exp};
    },
    blagues(){
      const jokes=[
        ['Pourquoi la r√®gle est toujours calme ?','Parce qu‚Äôelle a plein de ¬´ mesures ¬ª ! üìèüòÑ'],
        ['Que dit la petite montagne √† la grande ?','Salut, Grand-papa ! ‚õ∞Ô∏èüëã'],
        ['Quel est le comble pour une montre ?','Avoir le temps‚Ä¶ de se reposer ! ‚è∞üò¥'],
        ['Pourquoi le livre se repose ?','Parce qu‚Äôil a trop de ¬´ chapitres ¬ª ! üìöüòÖ']
      ];
      const [q,a]=choice(jokes);
      return {id:`blague-${q}`, type:'tale', paras:[`ü§£ ${q}`, `üëâ ${a}`], regen:()=>{const [qq,aa]=choice(jokes); return [`ü§£ ${qq}`, `üëâ ${aa}`];}};
    },
    poemes(){
      const poems=[
        ['Matin doux', 'Le soleil dor√©, tout doucement,', 'R√©veille les fleurs gentiment.', 'Un oiseau chante, ¬´ bonjour, bonjour ! ¬ª,', 'Le jour commence, plein d‚Äôamour.'],
        ['Goutte de pluie', 'Toc, toc, la goutte rit,', 'Sur la vitre, petit bruit.', 'Elle glisse, danse et fuit,', 'Puis dispara√Æt, tout petit.'],
        ['Petit vent', 'Le vent chuchote aux nuages,', 'Des secrets tout en voyage.', 'Il caresse nos joues, tout l√©ger,', 'Et s‚Äôendort dans le verger.']
      ];
      const p=choice(poems);
      const title=p[0]; const body=p.slice(1).map(v=>v);
      const paras=[`üìù ${title}`, ...body];
      return {id:`poeme-${title}`, type:'tale', paras, regen:()=>{const pp=choice(poems); return [`üìù ${pp[0]}`, ...pp.slice(1)];}};
    }
  };

  // JUEGOS
  const GAMES={
    hanoi(){
      const n=rnd(3,5); const ans=(1<<n)-1; const opts=shuffle([ans, ans+2, ans-2, ans+4]).map(x=>({label:String(x), icon:'üß†'}));
      return {id:`game-hanoi-${n}`, type:'qcm', text:`üóº Tours de Hano√Ø ‚Äî mouvements minimum pour ${n} disques ?`, options:opts, correct:opts.findIndex(o=>+o.label===ans), explain:`Formule : 2^${n} ‚àí 1 = ${ans}.`, meta:{ svg: hanoiSVG(n), hint:`Astuce : double √† chaque disque ‚Üí 2^${n} ‚àí 1` } };
    },
    hidden(){
      const need=5; const pool=['üéà','üçé','üåü','üê±','ü¶ã','üçÄ','üåº','üç©','üöó','üß∏'];
      const cells=[]; for(let i=0;i<30-need;i++) cells.push({e:choice(pool),k:'other'}); for(let i=0;i<need;i++) cells.push({e:'üëª',k:'target'});
      return {id:`game-hidden-${Date.now()}`, type:'find', text:`üëª Trouve ${need} fant√¥mes dans la grille.`, grid:shuffle(cells), need, explain:`Clique sur les üëª.`};
    },
    flows(){
      const steps=rnd(3,6); const dirs=['‚Üë','‚Üì','‚Üê','‚Üí']; const seq=Array.from({length:steps},()=>choice(dirs));
      const text=`ü§ñ Robotic flows : place les fl√®ches dans l‚Äôordre pour arriver au but.`;
      return {id:`game-flows-${seq.join('')}`, type:'order', text, items:shuffle(seq), check:(ans)=> ans.join('')===seq.join(''), explain:`Ordre correct : ${seq.join(' ‚Üí ')}`};
    },
    one(){ return {id:`game-one-${Date.now()}`, type:'drawing', text:'‚úèÔ∏è Draw one line: dessine une seule ligne (essaie sans lever la main).'}; },
    crime(){
      const cases=[
        {story:'Trois animaux sont suspects : üê± porte un chapeau, üê∂ boit du jus, üê≠ a de la peinture sur la patte. Qui a colori√© le mur ?', a:'üê≠', opts:['üê±','üê∂','üê≠'], exp:'La peinture sur la patte ‚Üí üê≠.'},
        {story:'Au pique-nique, üçì dispara√Æt. Indices: üê∞ a des miettes, üêª a une fraise sur le museau, ü¶ä dort. Qui a mang√© la fraise ?', a:'üêª', opts:['üê∞','üêª','ü¶ä'], exp:'Fraise sur le museau ‚Üí üêª.'}
      ];
      const c=choice(cases); const options=shuffle(c.opts).map(x=>({label:x}));
      return {id:`game-crime-${c.a}`, type:'qcm', text:`üïµÔ∏è Crime scene : ${c.story}`, options, correct:options.findIndex(o=>o.label===c.a), explain:c.exp};
    },
    missnum(){
      const a=rnd(1,9), d=rnd(1,5), n=5; const seq=Array.from({length:n},(_,i)=>a+i*d); const miss=rnd(1,n-2); const ans=seq[miss]; seq[miss]='?';
      const txtSeq = seq.map(x=> x==='?'? '<span class="missPulse">?</span>' : String(x)).join(' ');
      const opts=shuffle([ans, ans+d, ans-d, ans+2*d]).map(x=>({label:String(x)}));
      return {id:`game-missnum-${ans}`, type:'qcm', text:`‚ùì Missing number : ${txtSeq} (suite arithm√©tique)`, options:opts, correct:opts.findIndex(o=>+o.label===ans), explain:`Pas de ${d} en ${d} ‚Äî valeur manquante = ${ans}.`};
    },
    missop(){
      const a=rnd(1,12), b=rnd(1,12); const op=choice(['+','‚àí','√ó','√∑']);
      let c; if(op==='+') c=a+b; else if(op==='‚àí'){ if(a<b) [a,b]=[b,a]; c=a-b; } else if(op==='√ó') c=a*b; else { const d=rnd(2,9); c=a; a=b*d; b=d; op='√∑'; }
      const text=`? : ${a} _ ${b} = ${c}`; const opts=['+','‚àí','√ó','√∑']; const correctIndex=opts.indexOf(op);
      return {id:`game-missop-${a}-${b}-${c}`, type:'qcm', text:`‚öôÔ∏è Missing operator : ${text}`, options:opts.map(x=>({label:x})), correct:correctIndex, explain:`L‚Äôop√©rateur correct est ¬´ ${op} ¬ª.`};
    },
    identical(){
      const pool=['üçé','üçå','üçá','üçì','üçë','üçê','üçí','ü•ù','üçä','üçâ'];
      const target=choice(pool); const items=shuffle([target,target, ...Array.from({length:10},()=>choice(pool.filter(x=>x!==target)))]).slice(0,12);
      return {id:`game-identical-${target}`, type:'findpair', text:`üîé Identical items : clique les deux identiques (${target}).`, items:shuffle(items), target, explain:`Il y a deux ${target}.`};
    },
    // Merge de juegos similares: elige aleatoriamente Hidden Ghosts o Identical items
    cherche(){ return Math.random()<.5 ? this.hidden() : this.identical(); }
  };

  // NUM
  const NUM={
    icones(){const pairs=[["üíæ","Sauvegarder"],["üñ®Ô∏è","Imprimer"],["‚ùå","Fermer"],["üîç","Rechercher"]]; const p=choice(pairs); const opts=shuffle(pairs.map(x=>x[1])); return {id:"num-ic-"+p[0], type:"qcm", text:`Quelle action correspond √† ${p[0]} ?`, options:opts.map(x=>({label:x})), correct:opts.indexOf(p[1]), explain:`${p[0]} = ${p[1]}.`};},
    souris(){const q=choice([{t:"Quel bouton pour ouvrir un menu contextuel ?",a:"clic droit",o:["clic gauche","clic droit","molette"]},{t:"Pour d√©placer un objet, on ‚Ä¶",a:"clique et on glisse",o:["double-clique","clique et on glisse","appuie sur √âchap"]},{t:"La touche pour effacer un caract√®re √† gauche est ‚Ä¶",a:"Retour arri√®re (Backspace)",o:["Entr√©e","Retour arri√®re (Backspace)","Majuscule"]}]); const arr=shuffle(q.o); return {id:"num-souris-"+q.t,type:"qcm",text:q.t,options:arr.map(x=>({label:x})),correct:arr.indexOf(q.a), explain:`R√©ponse : ${q.a}.`};},
    securite(){const q=choice([{t:"Tu donnes ton mot de passe √† ton ami.",a:false,exp:"Ne jamais partager son mot de passe."},{t:"Tu demandes √† un adulte avant de cliquer sur un lien √©trange.",a:true,exp:"Toujours demander de l‚Äôaide."}]); return {id:"num-sec-"+q.t,type:"qcm",text:`Vrai ou faux : ${q.t}`,options:[{label:"Vrai"},{label:"Faux"}],correct:q.a?0:1, explain:q.exp};}
  };

  // LOGIQUE
  const LOG={
    // M√©moire avec op√©rations ‚Üî r√©sultats (5 niveaux)
    memoLevel(L){
      const cfg=[null,{pairs:4,ops:['add'],range:[1,5]},{pairs:6,ops:['add'],range:[1,9]},{pairs:8,ops:['add','sub'],range:[0,10]},{pairs:10,ops:['add','sub','mul'],range:[1,10]},{pairs:12,ops:['add','sub','mul','div'],range:[1,12]}][L];
      const used=new Set(); const deck=[];
      function gen(){
        const [aMin,aMax]=cfg.range;
        const op=choice(cfg.ops);
        let a,b,txt,res;
        if(op==='add'){ a=rnd(aMin,aMax); b=rnd(aMin,aMax); res=a+b; txt=`${a} + ${b}`; }
        else if(op==='sub'){ a=rnd(aMin,aMax); b=rnd(aMin,aMax); if(a<b) [a,b]=[b,a]; res=a-b; txt=`${a} ‚àí ${b}`; }
        else if(op==='mul'){ const tables=[2,3,4,5,6]; a=choice(tables); b=rnd(1,10); res=a*b; txt=`${a} √ó ${b}`; }
        else { // div
          const d=rnd(2,10); const r=rnd(1,10); a=d*r; res=r; txt=`${a} √∑ ${d}`;
        }
        return {txt, res:String(res)};
      }
      while(deck.length < cfg.pairs*2){
        const {txt,res}=gen();
        if(used.has(txt) || used.has('RES:'+res)) continue; // evita duplicados visibles
        used.add(txt); used.add('RES:'+res);
        const id=`${txt}=${res}`;
        deck.push({e:txt, v:id});
        deck.push({e:res, v:id});
      }
      return {id:`log-memoops-${L}-${Date.now()}`, type:'memory', text:'M√©moire ‚Äî associe op√©ration ‚Üî r√©sultat.', deck:shuffle(deck), pairs:deck.length/2};
    },
    memo1(){ return this.memoLevel(1); },
    memo2(){ return this.memoLevel(2); },
    memo3(){ return this.memoLevel(3); },
    memo4(){ return this.memoLevel(4); },
    memo5(){ return this.memoLevel(5); },
    sudoku(){const p=choice([{g:[1,0,0,4, 0,0,2,0, 0,2,0,0, 3,0,0,1]},{g:[0,0,2,1, 1,0,0,0, 0,1,0,0, 4,0,1,0]}]);
      return {id:"log-sudoku-"+p.g.join(""), type:"sudoku", grid:p.g, check(vals){
        if(vals.length!==16 || vals.some(v=>v<1||v>4)) return false;
        const okRow=r=> new Set(vals.slice(r*4,(r+1)*4)).size===4;
        const okCol=c=> new Set([vals[c],vals[c+4],vals[c+8],vals[c+12]]).size===4;
        const blk=(r,c)=>{const idx=[r*8+c*2, r*8+c*2+1, r*8+c*2+4, r*8+c*2+5].map(i=>[Math.floor(i/4), i%4]).map(([R,C])=>vals[R*4+C]); return new Set(idx).size===4;};
        for(let i=0;i<4;i++){ if(!okRow(i)||!okCol(i)) return false; }
        for(let r=0;r<2;r++) for(let c=0;c<2;c++) if(!blk(r,c)) return false;
        return true;
      }};
    },
    patterns(){
      const s=choice([{arr:["üî¥","üîµ","üî¥","üîµ","?"], a:"üî¥", opts:["üî¥","üü¢","üü°"], exp:"R√©p√©tition rouge/bleu."},{arr:["1","2","3","?","5"], a:"4", opts:["4","6","2"], exp:"Suite 1 √† 5."},{arr:["üê∂","üê±","üê∂","?","üê∂"], a:"üê±", opts:["üê±","üê≠","üê∏"], exp:"Un chien sur deux."}]);
      const opt=shuffle(s.opts); return {id:"log-pat-"+s.arr.join(""), type:"qcm", text:`Compl√®te la s√©quence : ${s.arr.join(" ")}`, options:opt.map(x=>({label:x})), correct:opt.indexOf(s.a), explain:s.exp};
    },
    // Rappel de nombres: montre puis cache, cliquer en ordre croissant
    rappelLevel(L){
      const counts=[0,4,6,8,10,12]; const maxes=[0,9,15,20,30,50];
      const n=counts[L], max=maxes[L];
      const set=new Set();
      while(set.size<n){ set.add(rnd(0,max)); }
      const arr=[...set]; const solution=[...arr].sort((a,b)=>a-b);
      return {id:`log-rappel-${L}-${Date.now()}`, type:'rappel', nums:arr, solution, viewMs: 1500 + L*250, explain:'Clique en ordre croissant.'};
    },
    rappel1(){ return this.rappelLevel(1); },
    rappel2(){ return this.rappelLevel(2); },
    rappel3(){ return this.rappelLevel(3); },
    rappel4(){ return this.rappelLevel(4); },
    rappel5(){ return this.rappelLevel(5); }
  };

  // SANT√â
  const SANTE_HYGIENE_BANK=[
    {emoji:'üßº',prompt:'Avant de manger je‚Ä¶',options:['Me lave les mains','Cours','Crie','Dors'],answer:'Me lave les mains'},
    {emoji:'ü™•',prompt:'Brossage des dents : combien ?',options:['2','0','1','5'],answer:'2'},
    {emoji:'ü§ß',prompt:'Je tousse : je‚Ä¶',options:['Dans mon coude','Dans ma main','Par terre','Sans couvrir'],answer:'Dans mon coude'},
    {emoji:'üõÅ',prompt:'Je dois me laver‚Ä¶',options:['R√©guli√®rement','Jamais','Une fois/an','Quand il pleut'],answer:'R√©guli√®rement'},
    {emoji:'üß¥',prompt:'Le gel hydro sert √†‚Ä¶',options:['Nettoyer les mains','Boire','Cuisiner','Peindre'],answer:'Nettoyer les mains'},
    {emoji:'üß¶',prompt:'Changer de chaussettes‚Ä¶',options:['Chaque jour','Jamais','Apr√®s 1 mois','Seulement l‚Äô√©t√©'],answer:'Chaque jour'}
  ];
  const SANTE_FOOD_BANK=[
    {emoji:'üçéüç´',prompt:'Le plus sain ?',options:['Pomme','Chocolat','Bonbons','G√¢teau'],answer:'Pomme'},
    {emoji:'ü•§üíß',prompt:'Meilleure boisson ?',options:['Eau','Soda','Sirop','Limonade'],answer:'Eau'},
    {emoji:'ü•¶üçü',prompt:'√ânergie longue‚Ä¶',options:['L√©gumes','Frites','Chips','Bonbons'],answer:'L√©gumes'},
    {emoji:'üçûüç¨',prompt:'Petit-d√©j √©quilibr√© ?',options:['Pain + fruit','Bonbons','Chips','Rien'],answer:'Pain + fruit'},
    {emoji:'üçΩÔ∏è',prompt:'Assiette id√©ale ?',options:['Couleurs vari√©es','Seulement frites','Seulement sucr√©','Aucune'],answer:'Couleurs vari√©es'},
    {emoji:'üçä',prompt:'Vitamine C ?',options:['Orange','Bonbon','G√¢teau','Frites'],answer:'Orange'},
    {emoji:'üêü',prompt:'Bon pour le cerveau ?',options:['Poisson','Bonbon','Soda','Chips'],answer:'Poisson'}
  ];
  const SANTE={
    hygiene(){
      const item=choice(SANTE_HYGIENE_BANK);
      const opts=shuffle(item.options.map(x=>({label:x})));
      const correct=opts.findIndex(o=>o.label===item.answer);
      return {id:`sante-hyg-${item.prompt}`, type:'qcm', text:`${item.emoji} ${item.prompt}`, options:opts, correct, explain:`R√©ponse : ${item.answer}.`};
    },
    alimentation(){
      const item=choice(SANTE_FOOD_BANK);
      const opts=shuffle(item.options.map(x=>({label:x})));
      const correct=opts.findIndex(o=>o.label===item.answer);
      return {id:`sante-food-${item.prompt}`, type:'qcm', text:`${item.emoji} ${item.prompt}`, options:opts, correct, explain:`Choix sain : ${item.answer}.`};
    }
  };

  // √âCOLE ‚Äî Septembre Semaine 15‚Äì19 (th√®mes fixes, 10 exos chacun)
  const ECOLE=(function(){
    // Helpers: map color names ‚Üí hex
    function colorHex(name){
      const m={
        'bleu':'#3b82f6','bleu ciel':'#60a5fa','rouge':'#ef4444','vert':'#22c55e','vert clair':'#86efac','jaune':'#fde047',
        'violet':'#a855f7','orange':'#f97316','rose':'#f472b6','turquoise':'#14b8a6'
      }; return m[(name||'').toLowerCase()]||'#a78bfa';
    }
    // Build SVG for coloriage: sapin (üéÑ) or licorne (ü¶Ñ) or fallback mosaic
    function buildColoriageSVG(shape, doneMap){
      if(shape==='sapin'){
        const W=720, H=360;
        const F=(i)=> (doneMap && doneMap[i]) ? doneMap[i] : '#ffffff';
        // Positions for 10 ornaments (bolitas)
        const balls=[
          [360,100],[320,130],[400,130],[280,170],[360,170],
          [440,170],[240,210],[320,210],[400,210],[480,210]
        ];
        const zones = balls.map(([x,y],i)=>`<circle id='zone-${i}' cx='${x}' cy='${y}' r='14' fill='${F(i)}' stroke='#222' stroke-opacity='.25'/>`).join('');
        return `<?xml version="1.0" encoding="UTF-8"?>
        <svg id="coloringSVG" xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${W} ${H}' width='${W}' height='${H}'>
          <defs>
            <linearGradient id='bg2' x1='0' x2='1'><stop offset='0' stop-color='#f0f9ff'/><stop offset='1' stop-color='#fef3c7'/></linearGradient>
            <filter id='s2' x='-10%' y='-10%' width='120%' height='120%'><feDropShadow dx='0' dy='1' stdDeviation='1' flood-color='#000' flood-opacity='.10'/></filter>
          </defs>
          <rect x='0' y='0' width='${W}' height='${H}' rx='18' fill='url(#bg2)'/>
          <!-- √âtoile en haut -->
          <polygon points='360,28 368,44 386,46 372,58 376,76 360,68 344,76 348,58 334,46 352,44' fill='#fde047' stroke='#222' stroke-opacity='.18'/>
          <!-- Sapin: trois triangles superpos√©s -->
          <polygon points='360,60 420,120 300,120' fill='#10b981' stroke='#14532d' stroke-opacity='.18' filter='url(#s2)'/>
          <polygon points='360,110 460,200 260,200' fill='#059669' stroke='#14532d' stroke-opacity='.18' filter='url(#s2)'/>
          <polygon points='360,180 500,260 220,260' fill='#047857' stroke='#14532d' stroke-opacity='.18' filter='url(#s2)'/>
          <!-- Tronc -->
          <rect x='330' y='260' width='60' height='60' rx='8' fill='#8b5e34' stroke='#111' stroke-opacity='.15' filter='url(#s2)'/>
          <!-- Neige -->
          <path d='M40,300 C160,280 240,320 360,300 C480,280 560,320 680,300 L680,360 L40,360 Z' fill='#fff' opacity='.7'/>
          <!-- Boules (zones √† colorier) -->
          ${zones}
        </svg>`;
      }
      if(shape==='licorne'){
        const W=720, H=360;
        const F=(i)=> (doneMap && doneMap[i]) ? doneMap[i] : '#ffffff';
        return `<?xml version="1.0" encoding="UTF-8"?>
        <svg id="coloringSVG" xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${W} ${H}' width='${W}' height='${H}'>
          <defs>
            <linearGradient id='bg' x1='0' x2='1'><stop offset='0' stop-color='#faf5ff'/><stop offset='1' stop-color='#eff6ff'/></linearGradient>
            <filter id='s' x='-10%' y='-10%' width='120%' height='120%'><feDropShadow dx='0' dy='1' stdDeviation='1' flood-color='#000' flood-opacity='.10'/></filter>
            <linearGradient id='rain' x1='0' x2='1'>
              <stop offset='0' stop-color='#ec4899'/>
              <stop offset='0.33' stop-color='#f59e0b'/>
              <stop offset='0.66' stop-color='#10b981'/>
              <stop offset='1' stop-color='#3b82f6'/>
            </linearGradient>
          </defs>
          <rect x='0' y='0' width='${W}' height='${H}' rx='18' fill='url(#bg)'/>
          <!-- Arc-en-ciel d√©coratif -->
          <path d='M80,320 C140,180 320,120 560,160' stroke='url(#rain)' stroke-width='18' fill='none' opacity='.25'/>
          <!-- Corne (horn) -->
          <polygon id='zone-0' points='430,40 460,20 470,80' fill='${F(0)}' stroke='#222' stroke-linejoin='round' stroke-linecap='round' stroke-opacity='.25' filter='url(#s)'/>
          <!-- Oreille (ear) -->
          <polygon id='zone-1' points='410,70 440,90 415,110' fill='${F(1)}' stroke='#222' stroke-linejoin='round' stroke-linecap='round' stroke-opacity='.25' filter='url(#s)'/>
          <!-- Visage (face) -->
          <ellipse id='zone-2' cx='360' cy='170' rx='140' ry='110' fill='${F(2)}' stroke='#222' stroke-opacity='.25' filter='url(#s)'/>
          <!-- Cou (neck) -->
          <path id='zone-9' d='M300,250 C340,260 410,260 440,280 L440,340 L260,340 L260,270 Z' fill='${F(9)}' stroke='#222' stroke-linejoin='round' stroke-linecap='round' stroke-opacity='.25' filter='url(#s)'/>
          <!-- Crini√®re (mane) segments -->
          <path id='zone-3' d='M260,120 C300,60 360,40 420,70 C380,90 350,110 320,140 Z' fill='${F(3)}' stroke='#222' stroke-linejoin='round' stroke-linecap='round' stroke-opacity='.25' filter='url(#s)'/>
          <path id='zone-4' d='M250,150 C300,110 360,90 400,110 C360,130 330,150 300,180 Z' fill='${F(4)}' stroke='#222' stroke-linejoin='round' stroke-linecap='round' stroke-opacity='.25' filter='url(#s)'/>
          <path id='zone-5' d='M240,180 C290,150 340,140 380,155 C340,175 310,195 280,220 Z' fill='${F(5)}' stroke='#222' stroke-linejoin='round' stroke-linecap='round' stroke-opacity='.25' filter='url(#s)'/>
          <path id='zone-6' d='M230,210 C280,190 330,185 360,195 C320,215 290,235 260,255 Z' fill='${F(6)}' stroke='#222' stroke-linejoin='round' stroke-linecap='round' stroke-opacity='.25' filter='url(#s)'/>
          <path id='zone-7' d='M220,240 C270,230 310,230 330,238 C300,255 270,270 240,285 Z' fill='${F(7)}' stroke='#222' stroke-linejoin='round' stroke-linecap='round' stroke-opacity='.25' filter='url(#s)'/>
          <!-- Joue (cheek) -->
          <circle id='zone-8' cx='410' cy='200' r='20' fill='${F(8)}' stroke='#222' stroke-opacity='.2' filter='url(#s)'/>
          <!-- Oeil -->
          <circle cx='420' cy='160' r='6' fill='#111' opacity='.5'/>
          <!-- D√©cor -->
          <text x='120' y='90' font-size='32' opacity='.25'>‚ú®</text>
          <text x='520' y='320' font-size='32' opacity='.25'>üåà</text>
        </svg>`;
      }
      // Fallback: mosa√Øque 10 cases avec emoji filigrane
      const emoji = shape==='dragon'?'üêâ': (shape==='licorne'?'ü¶Ñ': (shape==='sapin'?'üéÑ':'üíñ'));
      const cols=5, rows=2, W=720, H=320, pad=16, cellW=(W-pad*2)/cols, cellH=(H-pad*2)/rows;
      let zones=''; let k=0;
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const x=Math.round(pad + c*cellW + 4), y=Math.round(pad + r*cellH + 4);
          const w=Math.round(cellW - 8), h=Math.round(cellH - 8);
          const fill = doneMap && doneMap[k] ? doneMap[k] : '#ffffff';
          zones += `<rect id="zone-${k}" x="${x}" y="${y}" rx="12" ry="12" width="${w}" height="${h}" fill="${fill}" stroke="#111" stroke-opacity=".25"/>`;
          k++;
        }
      }
      return `<?xml version="1.0" encoding="UTF-8"?>
      <svg id="coloringSVG" xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${W} ${H}' width='${W}' height='${H}'>
        <defs>
          <linearGradient id='bg' x1='0' x2='1'><stop offset='0' stop-color='#faf5ff'/><stop offset='1' stop-color='#eff6ff'/></linearGradient>
        </defs>
        <rect x='0' y='0' width='${W}' height='${H}' rx='16' fill='url(#bg)'/>
        <text x='50%' y='56%' text-anchor='middle' font-size='160' opacity='.15'>${emoji}</text>
        ${zones}
      </svg>`;
    }
    const asInput=(id,text,answer,explain,kind='number',placeholder='Ta r√©ponse')=>({
      id:`ec-in-${id}`,
      type:'input',
      text,
      kind,
      placeholder,
      check:(v)=> String(v).trim().toLowerCase()===String(answer).toLowerCase(),
      explain
    });

    // 1) üé® Coloriage cod√© ‚Äî 10 op√©rations simples
    const COLORIAGE = [
      {op:'7 + 5', ans:12, color:'bleu'},
      {op:'9 ‚àí 4', ans:5, color:'rouge'},
      {op:'3 √ó 4', ans:12, color:'vert'},
      {op:'6 + 8', ans:14, color:'jaune'},
      {op:'15 ‚àí 7', ans:8, color:'violet'},
      {op:'2 √ó 6', ans:12, color:'orange'},
      {op:'10 ‚àí 3', ans:7, color:'rose'},
      {op:'5 + 6', ans:11, color:'bleu ciel'},
      {op:'4 √ó 3', ans:12, color:'turquoise'},
      {op:'8 + 9', ans:17, color:'vert clair'}
    ].map((e,i)=>{
      const q=asInput(
        `color-${i}`,
        `Coloriage cod√© ‚Äî √©cris le r√©sultat de ${e.op} (couleur¬†: ${e.color}).`,
        e.ans,
        `Si c‚Äô√©tait sur papier, colorie la zone en <b>${e.color}</b>. Bravo ma championne¬†!`);
      q.meta = { col: { name:e.color, hex: colorHex(e.color) } };
      return q;
    });

    // 2) üè† Maisons des nombres ‚Äî choisir 2 nombres qui font N (avec aide anim√©e)
    const MAISONS = [10, 11, 12, 13, 14, 15, 16, 18, 20].map((N,i)=>{
      // Candidats plus pertinents autour de N (1..9) + quelques distracteurs
      const valids=[]; for(let a=1;a<=9;a++){ const b=N-a; if(b>=1 && b<=9) { valids.push(a,b); } }
      const base=Array.from(new Set(valids)).map(String);
      const distractors=[1,2,3,4,5,6,7,8,9].filter(x=>!base.includes(String(x))).slice(0,4).map(String);
      const items=shuffle(Array.from(new Set([...base, ...distractors])).slice(0,8));
      return {
        id:`maison-${N}-${i}`,
        type:'order',
        text:`Maison du ${N} ‚Äî glisse deux nombres pour faire ${N} ‚ú®`,
        items,
        meta:{ svg: houseSVG(N), sumHelp:true, target:N },
        check:(arr)=>{
          const nums=arr.map(x=>+x).filter(x=>!isNaN(x));
          if(nums.length!==2) return false;
          return nums[0]+nums[1]===N;
        },
        explain:`Astuce¬†: trouve ¬´ l‚Äôami ¬ª d‚Äôun nombre pour atteindre ${N}. Observe la somme anim√©e üß±üè†`
      };
    });

    // 3) üç™ü•¨ Probl√®mes ‚Äî cookies et salades
    const PROB = [
      asInput('cookies-1', `Cookies¬†: Elena, Eva et Maya apportent chacune 6 cookies. Combien au total¬†?`, 18, `3 √ó 6 = 18. Les cookies disparaissent‚Ä¶ miam üòã`),
      asInput('cookies-2', `Cookies¬†: 2 bo√Ætes de 6 + 1 bo√Æte de 3. Total¬†?`, 15, `12 + 3 = 15. Bien vu¬†!`),
      asInput('cookies-3', `Cookies¬†: 4 bo√Ætes de 5. Total¬†?`, 20, `4 √ó 5 = 20.`),
      asInput('salades-1', `Salades¬†: Ruben a 15 salades et en vend 7. Combien restent¬†?`, 8, `15 ‚àí 7 = 8. Les salades sourient üåø`),
      asInput('salades-2', `Salades¬†: 12 au d√©part, il en cueille 5 de plus. Total¬†?`, 17, `12 + 5 = 17.`),
      asInput('salades-3', `Salades¬†: 20 au d√©part, il en donne 9. Combien restent¬†?`, 11, `20 ‚àí 9 = 11.`),
      asInput('cookies-4', `Cookies¬†: 5 + 7 + 6. Total¬†?`, 18, `5 + 7 = 12, puis 12 + 6 = 18.`),
      asInput('cookies-5', `Cookies¬†: 3 √ó 4. Total¬†?`, 12, `3 √ó 4 = 12.`),
      asInput('salades-4', `Salades¬†: 9 + 9. Total¬†?`, 18, `9 + 9 = 18.`),
      asInput('salades-5', `Salades¬†: 14 ‚àí 6. Reste¬†?`, 8, `14 ‚àí 6 = 8.`)
    ];

    // 4) üê≠ Vocabulaire spatial ‚Äî d√©placer la souris autour de la maison
    const SPATIAL = [
      {msg:'Glisse la souris SOUS la maison', target:'sous'},
      {msg:'Glisse la souris SUR le toit', target:'sur'},
      {msg:'Glisse la souris DERRI√àRE la maison', target:'derri√®re'},
      {msg:'Glisse la souris DEVANT la maison', target:'devant'},
      {msg:'Glisse la souris DANS la maison', target:'dans'},
      {msg:'Glisse la souris √Ä L‚ÄôINT√âRIEUR (comme ¬´ dans ¬ª)', target:'√† l‚Äôint√©rieur'},
      {msg:'Glisse la souris CONTRE le mur', target:'contre'},
      {msg:'Glisse la souris √Ä GAUCHE de la maison', target:'√† gauche'},
      {msg:'Glisse la souris √Ä DROITE de la maison', target:'√† droite'},
      {msg:'Glisse la souris ENTRE les deux chaises', target:'entre'}
    ].map((e,i)=>({
      id:`spatial-${i}`,
      type:'spatial',
      text:e.msg + ' üê≠üè†',
      target:e.target,
      explain:`Observe bien la position demand√©e : ¬´ ${e.target} ¬ª. D√©place la souris jusqu‚Äô√† la bonne zone.`
    }));

    // 5) ‚úã Droite et gauche ‚Äî Vrai/Faux avec sc√®ne simple et fl√®che explicative
    function dgScene(names){
      const W=640, H=140; const step=W/(names.length+1);
      const circles = names.map((nm,i)=>{
        const x=Math.round(step*(i+1)); const y=60;
        const [face,name] = nm.split(' ');
        return `<g><circle cx='${x}' cy='${y}' r='26' fill='#fff' stroke='#111' stroke-opacity='.18'/>
          <text x='${x}' y='66' text-anchor='middle' font-size='22'>${face}</text>
          <text x='${x}' y='108' text-anchor='middle' font-size='14' fill='#334155' font-weight='700'>${name}</text></g>`;
      }).join('');
      return `<?xml version="1.0" encoding="UTF-8"?>
      <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${W} ${H}' width='${W}' height='${H}'>
        <rect x='0' y='0' width='${W}' height='${H}' rx='14' fill='#f8fafc'/>
        ${circles}
      </svg>`;
    }
    function dgVF(i){
      const lines=[
        ['üßí L√©o','üëß Mia','üë¶ Tom'],
        ['üëß Eva','üßí L√©o','üë¶ Tom'],
        ['üë¶ Max','üëß Zo√©','üßí Liam','üëß Mia']
      ];
      const line = choice(lines);
      const names = line.map(n=>n.split(' ')[1]);
      // Pick two distinct indices
      const a=rnd(0,line.length-1); let b=rnd(0,line.length-1); while(b===a) b=rnd(0,line.length-1);
      const [nameA,nameB] = [names[a],names[b]];
      const rel = Math.random()<.5 ? 'gauche' : 'droite';
      const truth = rel==='gauche' ? (a<b) : (a>b);
      const text=`‚úã ${nameA} est √† ${rel} de ${nameB}. ‚Äî Vrai ou faux ?`;
      const svg=dgScene(line);
      return {
        id:`dg-vf-${i}-${line.join('-')}-${rel}-${nameA}-${nameB}`,
        type:'qcm',
        text,
        options:[{label:'vrai'},{label:'faux'}],
        correct: truth ? 0 : 1,
        meta:{ svg, dir: rel==='gauche' ? 'left' : 'right' },
        explain:`Pense: gauche ‚Üê et droite ‚Üí. Regarde l'ordre des enfants.`
      };
    }
    const DROITE_GAUCHE = Array.from({length:10}, (_,i)=> dgVF(i));

    // 6) ‚ûï‚ûñ Technique de la saucisse ‚Äî passage par 10
    const SAUCISSE = [
      {expr:'8 + 5', via:'8 ‚Üí 10 (+2), puis +3 = 13', ans:13},
      {expr:'9 + 6', via:'9 ‚Üí 10 (+1), puis +5 = 15', ans:15},
      {expr:'7 + 8', via:'7 ‚Üí 10 (+3), puis +5 = 15', ans:15},
      {expr:'15 ‚àí 7', via:'15 ‚Üí 10 (‚àí5), puis ‚àí2 = 8', ans:8},
      {expr:'14 ‚àí 6', via:'14 ‚Üí 10 (‚àí4), puis ‚àí2 = 8', ans:8},
      {expr:'12 ‚àí 5', via:'12 ‚Üí 10 (‚àí2), puis ‚àí3 = 7', ans:7},
      {expr:'16 ‚àí 9', via:'16 ‚Üí 10 (‚àí6), puis ‚àí3 = 7', ans:7},
      {expr:'6 + 7', via:'6 ‚Üí 10 (+4), puis +3 = 13', ans:13},
      {expr:'5 + 8', via:'5 ‚Üí 10 (+5), puis +3 = 13', ans:13},
      {expr:'13 ‚àí 4', via:'13 ‚Üí 10 (‚àí3), puis ‚àí1 = 9', ans:9}
    ].map((e,i)=>({
      id:`sauc-${i}`,
      type:'sausage',
      text:`Technique de la saucisse¬†: ${e.expr}`,
      expr:e.expr,
      ans:e.ans,
      explain:`Trace ta ¬´¬†saucisse¬†¬ª jusqu‚Äô√† 10¬†: ${e.via}. Dizaines et unit√©s t‚Äôaident¬†! üå≠‚ú®`
    }));

    // 7) üìñ Lecture ‚Äî Associer livres et phrases (QCM)
    const LECTURE_ASSOC = [
      {phrase:`‚úàÔ∏è Un avion file dans le ciel et fait ¬´ whooosh ¬ª !`, cover:'Le grand avion bleu ‚úàÔ∏è'},
      {phrase:`üêâ Un dragon veille sur son tr√©sor qui brille ‚ú®`, cover:'Le dragon courageux üêâ'},
      {phrase:`üëë Une princesse marche dans une for√™t magique üå≥`, cover:'La princesse et la for√™t üëë'},
      {phrase:`üè¥‚Äç‚ò†Ô∏è Des pirates cherchent une carte au tr√©sor üó∫Ô∏è`, cover:'Les pirates et la carte üè¥‚Äç‚ò†Ô∏è'},
      {phrase:`ü§ñ Un petit robot apprend √† danser üíÉ`, cover:'Le robot danseur ü§ñ'},
      {phrase:`üê∂ Un chien retrouve enfin sa maison üè†`, cover:'Le chien perdu üê∂'},
      {phrase:`üê± Un chat explore la nuit √©toil√©e üåô`, cover:'Le chat de minuit üê±'},
      {phrase:`üåü Des √©toiles discutent doucement avec les enfants üëßüë¶`, cover:'Les √©toiles bavardes üåü'},
      {phrase:`üöÇ Un train traverse une montagne enneig√©e ‚õ∞Ô∏è`, cover:'Le train de la montagne üöÇ'},
      {phrase:`üåø Un jardin pousse tr√®s vite, hop hop !`, cover:'Le jardin press√© üåø'}
    ].map((e,i)=>{
      const pool=[e.cover,'Le v√©lo rouge üö≤','La f√™te surprise üéâ','La mer brillante üåä'];
      const labels=shuffle(pool);
      const correct=labels.indexOf(e.cover);
      return {id:`lect-${i}`, type:'qcm', text:`ü™Ñ Associe l‚Äôhistoire √† sa couverture : ¬´ ${e.phrase} ¬ª`, options:labels.map(x=>({label:x})), correct, explain:`Rep√®re les mots-cl√©s et les emojis (dragon üêâ, avion ‚úàÔ∏è, robot ü§ñ‚Ä¶).`, meta:{ svg: bookCoversSVG(labels) } };
    });

    // 8) üìó Vocabulaire du livre ‚Äî r√¥les
    const ROLES_LIVRE=[
      {role:'Auteur', def:'√©crit l‚Äôhistoire'},
      {role:'Illustrateur', def:'dessine les images'},
      {role:'√âditeur', def:'fabrique/imprime le livre'},
      {role:'Biblioth√©caire', def:'range et pr√™te les livres'},
      {role:'Lecteur', def:'lit l‚Äôhistoire'},
      {role:'Traducteur', def:'traduit le texte'},
      {role:'Relieur', def:'assemble les pages'},
      {role:'Correcteur', def:'corrige les fautes'},
      {role:'Libraire', def:'vend les livres'},
      {role:'Auteur', def:'imagine les personnages'}
    ].map((e,i)=>{
      const correct = `${e.role} : ${e.def}`;
      const wrongs = [
        'Auteur : dessine les images',
        'Illustrateur : imprime le livre',
        '√âditeur : √©crit l‚Äôhistoire'
      ];
      const opts=shuffle([correct, ...wrongs]);
      // opts est un tableau de cha√Ænes; l'index correct doit √™tre calcul√© avant le map
      const correctIdx = opts.indexOf(correct);
      return {id:`roles-${i}`, type:'qcm', text:`Qui fait quoi¬†?`, options:opts.map(x=>({label:x})), correct:correctIdx, explain:`Rappelle-toi¬†: Auteur ‚úçÔ∏è, Illustrateur üé®, √âditeur üñ®Ô∏è.`};
    });

    // 9) üìè Comparaisons ‚Äî QCM descriptifs
    const COMP=[
      {q:'Entoure le plus long', a:'ficelle A', opts:['ficelle A','ficelle B','ficelle C']},
      {q:'Souligne le moins √©pais', a:'pain fin', opts:['pain fin','pain moyen','pain √©pais']},
      {q:'Entoure le r√©cipient le plus rempli', a:'verre 3/3', opts:['verre 1/3','verre 2/3','verre 3/3']},
      {q:'Barre ce qui co√ªte le moins cher', a:'stylo 1‚Ç¨', opts:['stylo 1‚Ç¨','cahier 2‚Ç¨','boite 3‚Ç¨']},
      {q:'Choisis la porte la plus haute', a:'porte A', opts:['porte A','porte B','porte C']},
      {q:'Choisis la bouteille de plus grande capacit√©', a:'bouteille 2 L', opts:['bouteille 0,5 L','bouteille 1 L','bouteille 2 L']},
      {q:'S√©lectionne le trait le plus court', a:'trait C', opts:['trait A','trait B','trait C']},
      {q:'Quel sac est le moins rempli¬†?', a:'sac l√©ger', opts:['sac l√©ger','sac moyen','sac lourd']},
      {q:'Quel carnet est le plus √©pais¬†?', a:'gros carnet', opts:['petit carnet','moyen carnet','gros carnet']},
      {q:'Quel bocal contient le moins d‚Äôeau¬†?', a:'bocal vide', opts:['bocal vide','bocal moiti√©','bocal plein']}
    ].map((e,i)=>{
      const opts=shuffle(e.opts);
      const correctIdx = opts.indexOf(e.a);
      return {id:`comp-${i}`, type:'qcm', text:`üìè ${e.q}`, options:opts.map(x=>({label:x})), correct:correctIdx, explain:`Observe bien : longueur, √©paisseur, hauteur, capacit√©, ou prix.`, meta:{ svg: buildCompSVG(i) } };
    });

    function pickSequential(list){
      const idx = Math.min(state.progress.done, list.length-1);
      return list[idx];
    }
    function pickByLevel(list){
      // Choisit un √©l√©ment non pos√© (id pas dans state.asked) dans la tranche de niveau, sinon retourne un au hasard de la tranche
      const L = Math.max(1, Math.min(6, state.level||1));
      const size = Math.max(1, Math.ceil(list.length/6));
      const start = Math.min(list.length-1, (L-1)*size);
      const end = Math.min(list.length, start+size);
      const slice = list.slice(start, end);
      // Essaye un choix non vu
      const shuffled = slice.slice().sort(()=>Math.random()-.5);
      for(const q of shuffled){ if(!state.asked?.has?.(q.id)) return q; }
      // Tout vu: retourne un au hasard (nextQuestion g√®rera l‚Äô√©puisement global)
      return shuffled[0] || list[0];
    }

    return {
      // Week id kept for compatibility (use coloriage set)
      sep1519: ()=> pickByLevel(COLORIAGE),
      // Themes
      coloriage: ()=>{
        const q = pickByLevel(COLORIAGE);
        const shape = (state.ecole && state.ecole.coloring && state.ecole.coloring.shape) || 'coeur';
        const doneMap = (state.ecole && state.ecole.coloring && state.ecole.coloring.done) || {};
        const svg = buildColoriageSVG(shape, doneMap);
        q.meta = q.meta || {}; q.meta.svg = svg; q.meta.col = q.meta.col || {name:'',hex:'#a78bfa'};
        return q;
      },
      maisons_saisie: ()=> ({ id:`maisons_saisie_${Date.now()}`, type:'houses', text:`Les maisons des nombres`, meta:{ nums:[5,8,12,13] } }),
      maisons: ()=> pickByLevel(MAISONS),
      problemes: ()=> pickByLevel(PROB),
      vocab_spatial: ()=> pickByLevel(SPATIAL),
      droite_gauche: ()=> pickByLevel(DROITE_GAUCHE),
      saucisse: ()=> pickByLevel(SAUCISSE),
      lecture_assoc: ()=> pickByLevel(LECTURE_ASSOC),
      roles_livre: ()=> pickByLevel(ROLES_LIVRE),
      comparaisons: ()=> pickByLevel(COMP)
    };
  })();

  function makeQuestion(area,sub){
    switch(area){
      case "ecole": return ECOLE[sub]();
      case "fr": return FR[sub]();
      case "nl": return NL[sub]();
      case "math": return MATH[sub](state.level);
      case "sciences": return SCI[sub]();
      case "arts": return ARTS[sub]();
      case "num": return NUM[sub]();
      case "logique": return LOG[sub]();
      case "contes": return CONTE[sub]();
      case "juegos": return GAMES[sub]();
      case "sante": return SANTE[sub]();
      default: return FR.vocab();
    }
  }

  /* ----------- init ----------- */
  load();
  // aplicar tema guardado
  if(state.theme==="dark") document.documentElement.setAttribute("data-theme","dark");
  // Sync chips iconos
  { const th=document.getElementById('themeChip'); if(th) th.textContent = (state.theme==="dark") ? 'üåô' : '‚òÄÔ∏è'; }
  // Accesibilidad: estados aria-pressed iniciales
  $("#themeChip")?.setAttribute('aria-pressed', String(state.theme==="dark"));
  $("#soundChip")?.setAttribute('aria-pressed', String(!!state.sound));
  $("#fsChip")?.setAttribute('aria-pressed', String(!!document.fullscreenElement));
  // Defaults after load
  if(!state.avatar) state.avatar={hat:null, acc:null, bg:null, face:'üôÇ'};

  renderMenu(); refreshHUD(); showHome();
  // Avatar World vibe: floating stickers
  try{ spawnStickers(); }catch{}

  if(!state.user?.name || state.user.name==="Invit√©"){
    showModal("Bienvenue !", `
      <p>Comment t‚Äôappelles-tu ?</p>
      <div><input id="nameInput2" placeholder="Ton pr√©nom" style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd"></div>
    `, ()=>{
      $("#nameInput2").focus();
      const submit=()=>{
        const n=$("#nameInput2").value.trim()||"Invit√©";
        state.user.name=n; $("#avatarName").textContent=n; save(); hideModal();
      };
      $("#modalClose").onclick=submit;
      $("#nameInput2").addEventListener('keydown', (ev)=>{
        if(ev.key==='Enter'){ ev.preventDefault(); submit(); }
      });
    });
  } else { $("#avatarName").textContent = state.user.name; }

})();
</script>
</body>
</html>
